# üêò –ö–æ–ª–ª–µ–∫—Ü–∏—è –≥–æ—Ç–æ–≤—ã—Ö SQL –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è PostgreSQL

## –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

**[–ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö](#–ø–æ–ª—É—á–µ–Ω–∏–µ-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö-–¥–∞–Ω–Ω—ã—Ö)**
   1. [–í–∞–ª–∏–¥–∞—Ü–∏—è –∏ –¥–æ–º–µ–Ω—ã](#–≤–∞–ª–∏–¥–∞—Ü–∏—è-–∏-–¥–æ–º–µ–Ω—ã)
      1. [–ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å email –Ω–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å?](#–∫–∞–∫-–ø—Ä–æ–≤–µ—Ä–∏—Ç—å-email-–Ω–∞-–≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å)
      1. [–ö–∞–∫ –Ω–∞–π—Ç–∏ –≤—Å–µ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–µ email –≤ —Ç–∞–±–ª–∏—Ü–µ?](#–∫–∞–∫-–Ω–∞–π—Ç–∏-–≤—Å–µ-–Ω–µ–≤–∞–ª–∏–¥–Ω—ã–µ-email-–≤-—Ç–∞–±–ª–∏—Ü–µ)
      1. [–ö–∞–∫ —É–¥–∞–ª–∏—Ç—å –≤—Å–µ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–µ email –∏–∑ –±–æ–ª—å—à–æ–π —Ç–∞–±–ª–∏—Ü—ã?](#–∫–∞–∫-—É–¥–∞–ª–∏—Ç—å-–≤—Å–µ-–Ω–µ–≤–∞–ª–∏–¥–Ω—ã–µ-email-–∏–∑-–±–æ–ª—å—à–æ–π-—Ç–∞–±–ª–∏—Ü—ã)
      1. [–ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å CSS —Ü–≤–µ—Ç –Ω–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å?](#–∫–∞–∫-–ø—Ä–æ–≤–µ—Ä–∏—Ç—å-css-—Ü–≤–µ—Ç-–Ω–∞-–≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å)
      1. [–ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∫–≤–∏–∑–∏—Ç—ã –∫–æ–º–ø–∞–Ω–∏–∏ (–ò–ù–ù, –ö–ü–ü, –û–ì–†–ù, –û–ì–†–ù–ò–ü) –Ω–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å?](#–∫–∞–∫-–ø—Ä–æ–≤–µ—Ä–∏—Ç—å-—Ä–µ–∫–≤–∏–∑–∏—Ç—ã-–∫–æ–º–ø–∞–Ω–∏–∏-–∏–Ω–Ω-–∫–ø–ø-–æ–≥—Ä–Ω-–æ–≥—Ä–Ω–∏–ø-–Ω–∞-–≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å)
      1. [–ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –±–∞–Ω–∫–æ–≤—Å–∫–∏–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã (–ë–ò–ö, —Ä–∞—Å—á—ë—Ç–Ω—ã–π —Å—á—ë—Ç, –∫–æ—Ä—Ä–µ—Å–ø–æ–Ω–¥–µ–Ω—Ç—Å–∫–∏–π —Å—á—ë—Ç) –Ω–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å?](#–∫–∞–∫-–ø—Ä–æ–≤–µ—Ä–∏—Ç—å-–±–∞–Ω–∫–æ–≤—Å–∫–∏–µ-—Ä–µ–∫–≤–∏–∑–∏—Ç—ã-–±–∏–∫-—Ä–∞—Å—á—ë—Ç–Ω—ã–π-—Å—á—ë—Ç-–∫–æ—Ä—Ä–µ—Å–ø–æ–Ω–¥–µ–Ω—Ç—Å–∫–∏–π-—Å—á—ë—Ç-–Ω–∞-–≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å)
      1. [–ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –°–ù–ò–õ–° –Ω–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å?](#–∫–∞–∫-–ø—Ä–æ–≤–µ—Ä–∏—Ç—å-—Å–Ω–∏–ª—Å-–Ω–∞-–≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å)
      1. [–ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –Ω–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å?](#–∫–∞–∫-–ø—Ä–æ–≤–µ—Ä–∏—Ç—å-–Ω–æ–º–µ—Ä-—Ç–µ–ª–µ—Ñ–æ–Ω–∞-–Ω–∞-–≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å)
      1. [–ö–∞–∫ –ø—Ä–æ–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ–ª—è, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω–æ —è–≤–Ω–æ —É–∫–∞–∑–∞–Ω–æ –≤ UPDATE –∑–∞–ø—Ä–æ—Å–µ?](#–∫–∞–∫-–ø—Ä–æ–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å-–∑–Ω–∞—á–µ–Ω–∏–µ-–ø–æ–ª—è-—Ç–æ–ª—å–∫–æ-–µ—Å–ª–∏-–æ–Ω–æ-—è–≤–Ω–æ-—É–∫–∞–∑–∞–Ω–æ-–≤-update-–∑–∞–ø—Ä–æ—Å–µ)
   1. [–ü–µ—Ä–µ–µ–∑–¥ –∏–∑ MySQL –≤ PostgreSQL](#–ø–µ—Ä–µ–µ–∑–¥-–∏–∑-mysql-–≤-postgresql)
      1. [–ö–∞–∫ —Å–¥–µ–ª–∞—Ç—å –∞–Ω–∞–ª–æ–≥ —Ñ—É–Ω–∫—Ü–∏–∏ `group_concat()` –∏–∑ MySQL](#–∫–∞–∫-—Å–¥–µ–ª–∞—Ç—å-–∞–Ω–∞–ª–æ–≥-—Ñ—É–Ω–∫—Ü–∏–∏-group_concat-–∏–∑-mysql)
      1. [–ö–∞–∫ —Å–¥–µ–ª–∞—Ç—å –∞–Ω–∞–ª–æ–≥ —Ç–∏–ø–∞ `set` –∏–∑ MySQL?](#–∫–∞–∫-—Å–¥–µ–ª–∞—Ç—å-–∞–Ω–∞–ª–æ–≥-—Ç–∏–ø–∞-set-–∏–∑-mysql)
      1. [–ö–∞–∫ —Å–¥–µ–ª–∞—Ç—å –∞–Ω–∞–ª–æ–≥ —Ñ—É–Ω–∫—Ü–∏–∏ `make_set()` –∏–∑ MySQL?](#–∫–∞–∫-—Å–¥–µ–ª–∞—Ç—å-–∞–Ω–∞–ª–æ–≥-—Ñ—É–Ω–∫—Ü–∏–∏-make_set-–∏–∑-mysql)
   1. [–°—Ç—Ä–æ–∫–∏](#—Å—Ç—Ä–æ–∫–∏)
      1. [–ö–∞–∫ —Ç—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ä—É—Å—Å–∫–∏–µ –±—É–∫–≤—ã –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ?](#–∫–∞–∫-—Ç—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∏—Ä–æ–≤–∞—Ç—å-—Ä—É—Å—Å–∫–∏–µ-–±—É–∫–≤—ã-–Ω–∞-–∞–Ω–≥–ª–∏–π—Å–∫–∏–µ)
      1. [–ö–∞–∫ —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å CSV —Å—Ç—Ä–æ–∫—É –≤ —Ç–∞–±–ª–∏—Ü—É?](#–∫–∞–∫-—Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å-csv-—Å—Ç—Ä–æ–∫—É-–≤-—Ç–∞–±–ª–∏—Ü—É)
      1. [–ö–∞–∫ –∑–∞–≥—Ä—É–∑–∏—Ç—å –≤ —Ç–∞–±–ª–∏—Ü—É –±–æ–ª—å—à–æ–π —Ñ–∞–π–ª-–∞—Ä—Ö–∏–≤ –≤ —Ñ–æ—Ä–º–∞—Ç–µ `csv.xz`?](#–∫–∞–∫-–∑–∞–≥—Ä—É–∑–∏—Ç—å-–≤-—Ç–∞–±–ª–∏—Ü—É-–±–æ–ª—å—à–æ–π-—Ñ–∞–π–ª-–∞—Ä—Ö–∏–≤-–≤-—Ñ–æ—Ä–º–∞—Ç–µ-csvxz)
      1. [–ö–∞–∫ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ–ª –ø–æ –§–ò–û (—Ñ–∞–º–∏–ª–∏–∏, –∏–º–µ–Ω–∏, –æ—Ç—á–µ—Å—Ç–≤—É) –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ?](#–∫–∞–∫-–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å-–ø–æ–ª-–ø–æ-—Ñ–∏–æ-—Ñ–∞–º–∏–ª–∏–∏-–∏–º–µ–Ω–∏-–æ—Ç—á–µ—Å—Ç–≤—É-–Ω–∞-—Ä—É—Å—Å–∫–æ–º-—è–∑—ã–∫–µ)
      1. [–ö–∞–∫ –∑–∞–∫–≤–æ—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—Ç—Ä–æ–∫—É –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ —Ä–µ–≥—É–ª—è—Ä–Ω–æ–º –≤—ã—Ä–∞–∂–µ–Ω–∏–∏?](#–∫–∞–∫-–∑–∞–∫–≤–æ—Ç–∏—Ä–æ–≤–∞—Ç—å-—Å—Ç—Ä–æ–∫—É-–¥–ª—è-–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è-–≤-—Ä–µ–≥—É–ª—è—Ä–Ω–æ–º-–≤—ã—Ä–∞–∂–µ–Ω–∏–∏)
      1. [–ö–∞–∫ –∑–∞–∫–≤–æ—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—Ç—Ä–æ–∫—É –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –æ–ø–µ—Ä–∞—Ç–æ—Ä–µ LIKE?](#–∫–∞–∫-–∑–∞–∫–≤–æ—Ç–∏—Ä–æ–≤–∞—Ç—å-—Å—Ç—Ä–æ–∫—É-–¥–ª—è-–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è-–≤-–æ–ø–µ—Ä–∞—Ç–æ—Ä–µ-like)
   1. [JSON](#json)
      1. [–ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å –∑–∞–ø–∏—Å–∏, –∫–æ—Ç–æ—Ä—ã–µ —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä—è—é—Ç —É—Å–ª–æ–≤–∏—è–º –∏–∑ JSON –º–∞—Å—Å–∏–≤–∞?](#–∫–∞–∫-–ø–æ–ª—É—á–∏—Ç—å-–∑–∞–ø–∏—Å–∏-–∫–æ—Ç–æ—Ä—ã–µ-—É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä—è—é—Ç-—É—Å–ª–æ–≤–∏—è–º-–∏–∑-json-–º–∞—Å—Å–∏–≤–∞)
      1. [–ö–∞–∫ —Å—Ä–∞–≤–Ω–∏—Ç—å 2 JSON –æ–±—ä–µ–∫—Ç–∞ –∏ –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–ª–∏—á–∏—è?](#–∫–∞–∫-—Å—Ä–∞–≤–Ω–∏—Ç—å-2-json-–æ–±—ä–µ–∫—Ç–∞-–∏-–ø–æ–ª—É—á–∏—Ç—å-–æ—Ç–ª–∏—á–∏—è)
   1. [–ú–∞—Å—Å–∏–≤—ã](#–º–∞—Å—Å–∏–≤—ã)
      1. [–ê–≥—Ä–µ–≥–∞—Ç–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∫–æ–Ω–∫–∞—Ç–µ–Ω–∞—Ü–∏–∏ (–æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è) –º–∞—Å—Å–∏–≤–æ–≤](#–∞–≥—Ä–µ–≥–∞—Ç–Ω–∞—è-—Ñ—É–Ω–∫—Ü–∏—è-–∫–æ–Ω–∫–∞—Ç–µ–Ω–∞—Ü–∏–∏-–æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è-–º–∞—Å—Å–∏–≤–æ–≤)
      1. [–ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –º–∞—Å—Å–∏–≤–æ–≤ (–ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ –º–∞—Å—Å–∏–≤–æ–≤)?](#–∫–∞–∫-–ø–æ–ª—É—á–∏—Ç—å-–æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ-—ç–ª–µ–º–µ–Ω—Ç—ã-–º–∞—Å—Å–∏–≤–æ–≤-–ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ-–º–∞—Å—Å–∏–≤–æ–≤)
      1. [–ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –º–∞—Å—Å–∏–≤–∞ –∏–ª–∏ –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∏—Ö?](#–∫–∞–∫-–ø–æ–ª—É—á–∏—Ç—å-—É–Ω–∏–∫–∞–ª—å–Ω—ã–µ-—ç–ª–µ–º–µ–Ω—Ç—ã-–º–∞—Å—Å–∏–≤–∞-–∏–ª–∏-–æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å-–∏—Ö)
      1. [–ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–ª–∏—á–∞—é—â–∏–µ—Å—è —ç–ª–µ–º–µ–Ω—Ç—ã –¥–≤—É—Ö –º–∞—Å—Å–∏–≤–æ–≤?](#–∫–∞–∫-–ø–æ–ª—É—á–∏—Ç—å-–æ—Ç–ª–∏—á–∞—é—â–∏–µ—Å—è-—ç–ª–µ–º–µ–Ω—Ç—ã-–¥–≤—É—Ö-–º–∞—Å—Å–∏–≤–æ–≤)
      1. [–ö–∞–∫ —Å–¥–µ–ª–∞—Ç—å –≤–Ω–µ—à–Ω–∏–π –∫–ª—é—á –Ω–∞ —ç–ª–µ–º–µ–Ω—Ç—ã –º–∞—Å—Å–∏–≤–∞?](#–∫–∞–∫-—Å–¥–µ–ª–∞—Ç—å-–≤–Ω–µ—à–Ω–∏–π-–∫–ª—é—á-–Ω–∞-—ç–ª–µ–º–µ–Ω—Ç—ã-–º–∞—Å—Å–∏–≤–∞)
   1. [–ü–æ–∏—Å–∫ –ø–æ —Ñ—Ä–∞–∑–µ (—Ç–æ—á–Ω—ã–π –∏ –Ω–µ—Ç–æ—á–Ω—ã–π)](#–ø–æ–∏—Å–∫-–ø–æ-—Ñ—Ä–∞–∑–µ-—Ç–æ—á–Ω—ã–π-–∏-–Ω–µ—Ç–æ—á–Ω—ã–π)
      1. [–ö–∞–∫ –Ω–∞–π—Ç–∏ —Å–ø–∏—Å–æ–∫ —Å—Ç—Ä–æ–∫, —Å–æ–≤–ø–∞–¥–∞—é—â–∏—Ö —Å–æ —Å–ø–∏—Å–∫–æ–º —à–∞–±–ª–æ–Ω–æ–≤?](#–∫–∞–∫-–Ω–∞–π—Ç–∏-—Å–ø–∏—Å–æ–∫-—Å—Ç—Ä–æ–∫-—Å–æ–≤–ø–∞–¥–∞—é—â–∏—Ö-—Å–æ-—Å–ø–∏—Å–∫–æ–º-—à–∞–±–ª–æ–Ω–æ–≤)
      1. [–ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏—è —Å—É—â–Ω–æ—Å—Ç–µ–π –ø–æ –ø–æ–∏—Å–∫–æ–≤–æ–π —Ñ—Ä–∞–∑–µ —Å —É—á—ë—Ç–æ–º –Ω–∞—á–∞–ª–∞ —Å–ª–æ–≤ (–ø–æ–∏—Å–∫–æ–≤—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏)?](#–∫–∞–∫-–ø–æ–ª—É—á–∏—Ç—å-–Ω–∞–∑–≤–∞–Ω–∏—è-—Å—É—â–Ω–æ—Å—Ç–µ–π-–ø–æ-–ø–æ–∏—Å–∫–æ–≤–æ–π-—Ñ—Ä–∞–∑–µ-—Å-—É—á—ë—Ç–æ–º-–Ω–∞—á–∞–ª–∞-—Å–ª–æ–≤-–ø–æ–∏—Å–∫–æ–≤—ã–µ-–ø–æ–¥—Å–∫–∞–∑–∫–∏)
      1. [–ö–∞–∫ –¥–ª—è —Å–ª–æ–≤–∞ —Å –æ–ø–µ—á–∞—Ç–∫–æ–π (–æ—à–∏–±–∫–æ–π) –ø–æ–ª—É—á–∏—Ç—å –Ω–∞–∏–±–æ–ª–µ–µ –ø–æ–¥—Ö–æ–¥—è—â–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã —Å–ª–æ–≤ –¥–ª—è –∑–∞–º–µ–Ω—ã (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–ø–µ—á–∞—Ç–æ–∫)?](#–∫–∞–∫-–¥–ª—è-—Å–ª–æ–≤–∞-—Å-–æ–ø–µ—á–∞—Ç–∫–æ–π-–æ—à–∏–±–∫–æ–π-–ø–æ–ª—É—á–∏—Ç—å-–Ω–∞–∏–±–æ–ª–µ–µ-–ø–æ–¥—Ö–æ–¥—è—â–∏–µ-–≤–∞—Ä–∏–∞–Ω—Ç—ã-—Å–ª–æ–≤-–¥–ª—è-–∑–∞–º–µ–Ω—ã-–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ-–æ–ø–µ—á–∞—Ç–æ–∫)
   1. [–î–µ—Ä–µ–≤—å—è –∏ –≥—Ä–∞—Ñ—ã](#–¥–µ—Ä–µ–≤—å—è-–∏-–≥—Ä–∞—Ñ—ã)
      1. [–ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –Ω–∞–∑–≤–∞–Ω–∏–π –ø—Ä–µ–¥–∫–æ–≤ –∏ –Ω–∞—Å–ª–µ–¥–Ω–∏–∫–æ–≤ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —É–∑–ª–∞ –¥–µ—Ä–µ–≤–∞ (–Ω–∞ –ø—Ä–∏–º–µ—Ä–µ —Ä–µ–≥–∏–æ–Ω–æ–≤)?](#–∫–∞–∫-–ø–æ–ª—É—á–∏—Ç—å-—Å–ø–∏—Å–æ–∫-–Ω–∞–∑–≤–∞–Ω–∏–π-–ø—Ä–µ–¥–∫–æ–≤-–∏-–Ω–∞—Å–ª–µ–¥–Ω–∏–∫–æ–≤-–¥–ª—è-–∫–∞–∂–¥–æ–≥–æ-—É–∑–ª–∞-–¥–µ—Ä–µ–≤–∞-–Ω–∞-–ø—Ä–∏–º–µ—Ä–µ-—Ä–µ–≥–∏–æ–Ω–æ–≤)
      1. [–ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏–µ —Å–≤—è–∑–∏ –≤ –≥—Ä–∞—Ñ–µ?](#–∫–∞–∫-–ø–æ–ª—É—á–∏—Ç—å-—Ü–∏–∫–ª–∏—á–µ—Å–∫–∏–µ-—Å–≤—è–∑–∏-–≤-–≥—Ä–∞—Ñ–µ)
      1. [–ö–∞–∫ –∑–∞—â–∏—Ç–∏—Ç—å—Å—è –æ—Ç —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏—Ö —Å–≤—è–∑–µ–π –≤ –≥—Ä–∞—Ñ–µ?](#–∫–∞–∫-–∑–∞—â–∏—Ç–∏—Ç—å—Å—è-–æ—Ç-—Ü–∏–∫–ª–∏—á–µ—Å–∫–∏—Ö-—Å–≤—è–∑–µ–π-–≤-–≥—Ä–∞—Ñ–µ)
      1. [–ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏—è –≤—Å–µ—Ö —É—Ä–æ–≤–Ω–µ–π —Å—Ñ–µ—Ä—ã –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ 4-–≥–æ —É—Ä–æ–≤–Ω—è?](#–∫–∞–∫-–ø–æ–ª—É—á–∏—Ç—å-–Ω–∞–∑–≤–∞–Ω–∏—è-–≤—Å–µ—Ö-—É—Ä–æ–≤–Ω–µ–π-—Å—Ñ–µ—Ä—ã-–¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏-4-–≥–æ-—É—Ä–æ–≤–Ω—è)
   1. [–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤](#–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è-–≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è-–∑–∞–ø—Ä–æ—Å–æ–≤)
      1. [–ö–∞–∫ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –Ω–∞ –ø–ª–∞–Ω –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞ (EXPLAIN) –≤ –Ω–∞–≥–ª—è–¥–Ω–æ–º –≥—Ä–∞—Ñ–∏—á–µ—Å–∫–æ–º –≤–∏–¥–µ?](#–∫–∞–∫-–ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å-–Ω–∞-–ø–ª–∞–Ω-–≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è-–∑–∞–ø—Ä–æ—Å–∞-explain-–≤-–Ω–∞–≥–ª—è–¥–Ω–æ–º-–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–æ–º-–≤–∏–¥–µ)
      1. [–ö–∞–∫ —É—Å–∫–æ—Ä–∏—Ç—å SELECT –∑–∞–ø—Ä–æ—Å—ã —Å —Ç—ã—Å—è—á–∞–º–∏ –∑–Ω–∞—á–µ–Ω–∏–π –≤ IN(...)?](#–∫–∞–∫-—É—Å–∫–æ—Ä–∏—Ç—å-select-–∑–∞–ø—Ä–æ—Å—ã-c-—Ç—ã—Å—è—á–∞–º–∏-–∑–Ω–∞—á–µ–Ω–∏–π-–≤-in)
      1. [–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤—ã–≤–æ–¥ EXPLAIN –∑–∞–ø—Ä–æ—Å–∞ –≤ –¥—Ä—É–≥–æ–º –∑–∞–ø—Ä–æ—Å–µ?](#–∫–∞–∫-–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å-–≤—ã–≤–æ–¥-explain-–∑–∞–ø—Ä–æ—Å–∞-–≤-–¥—Ä—É–≥–æ–º-–∑–∞–ø—Ä–æ—Å–µ)
      1. [–ö–∞–∫ —É—Å–∫–æ—Ä–∏—Ç—å SELECT –∑–∞–ø—Ä–æ—Å –ø–æ—Å–ª–µ –ø–µ—Ä–µ–µ–∑–¥–∞ —Å PostgreSQL v10 –Ω–∞ v12?](#–∫–∞–∫-—É—Å–∫–æ—Ä–∏—Ç—å-select-–∑–∞–ø—Ä–æ—Å-–ø–æ—Å–ª–µ-–ø–µ—Ä–µ–µ–∑–¥–∞-—Å-postgresql-v10-–Ω–∞-v12)
      1. [–ö–∞–∫ —É—Å–∫–æ—Ä–∏—Ç—å SELECT COUNT(\*) –∑–∞–ø—Ä–æ—Å?](#–∫–∞–∫-—É—Å–∫–æ—Ä–∏—Ç—å-select-count-–∑–∞–ø—Ä–æ—Å)
      1. [–ö–∞–∫ –≤—ã–ø–æ–ª–Ω–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é N —Ç—ã—Å—è—á —Ä–∞–∑ –∏ –∏–∑–º–µ—Ä–∏—Ç—å —Å–∫–æ—Ä–æ—Å—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è?](#–∫–∞–∫-–≤—ã–ø–æ–ª–Ω–∏—Ç—å-—Ñ—É–Ω–∫—Ü–∏—é-n-—Ç—ã—Å—è—á-—Ä–∞–∑-–∏-–∏–∑–º–µ—Ä–∏—Ç—å-—Å–∫–æ—Ä–æ—Å—Ç—å-–≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è)
   1. [–ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å –∑–∞–ø–∏—Å–∏-–¥—É–±–ª–∏–∫–∞—Ç—ã –ø–æ –∑–Ω–∞—á–µ–Ω–∏—é –ø–æ–ª–µ–π?](#–∫–∞–∫-–ø–æ–ª—É—á–∏—Ç—å-–∑–∞–ø–∏—Å–∏-–¥—É–±–ª–∏–∫–∞—Ç—ã-–ø–æ-–∑–Ω–∞—á–µ–Ω–∏—é-–ø–æ–ª–µ–π)
   1. [–ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞ –≤ –µ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ?](#–∫–∞–∫-–ø–æ–ª—É—á–∏—Ç—å-–¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å-–≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è-–∑–∞–ø—Ä–æ—Å–∞-–≤-–µ–≥–æ-—Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ)
   1. [–ö–∞–∫ —Ä–∞–∑–±–∏—Ç—å –±–æ–ª—å—à—É—é —Ç–∞–±–ª–∏—Ü—É –ø–æ N —Ç—ã—Å—è—á –∑–∞–ø–∏—Å–µ–π?](#–∫–∞–∫-—Ä–∞–∑–±–∏—Ç—å-–±–æ–ª—å—à—É—é-—Ç–∞–±–ª–∏—Ü—É-–ø–æ-n-—Ç—ã—Å—è—á-–∑–∞–ø–∏—Å–µ–π)
   1. [–ö–∞–∫ –≤—ã–ø–æ–ª–Ω–∏—Ç—å —Å–ª–µ–¥—É—é—â–∏–π SQL –∑–∞–ø—Ä–æ—Å, –µ—Å–ª–∏ –ø—Ä–µ–¥—ã–¥—É—â–∏–π –Ω–µ –≤–µ—Ä–Ω—É–ª —Ä–µ–∑—É–ª—å—Ç–∞—Ç?](#–∫–∞–∫-–≤—ã–ø–æ–ª–Ω–∏—Ç—å-—Å–ª–µ–¥—É—é—â–∏–π-sql-–∑–∞–ø—Ä–æ—Å-–µ—Å–ª–∏-–ø—Ä–µ–¥—ã–¥—É—â–∏–π-–Ω–µ-–≤–µ—Ä–Ω—É–ª-—Ä–µ–∑—É–ª—å—Ç–∞—Ç)
   1. [–ö–∞–∫ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å –∑–∞–ø–∏—Å—å –≤ –Ω–∞–±–æ—Ä –∫–æ–ª–æ–Ω–æ–∫?](#–∫–∞–∫-—Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å-–∑–∞–ø–∏—Å—å-–≤-–Ω–∞–±–æ—Ä-–∫–æ–ª–æ–Ω–æ–∫)
   1. [–ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å –∏—Ç–æ–≥–æ–≤—É—é —Å—É–º–º—É –∏ –ø—Ä–æ—Ü–µ–Ω—Ç –¥–ª—è –∫–∞–∂–¥–æ–π –∑–∞–ø–∏—Å–∏ –≤ –æ–¥–Ω–æ–º –∑–∞–ø—Ä–æ—Å–µ?](#–∫–∞–∫-–ø–æ–ª—É—á–∏—Ç—å-–∏—Ç–æ–≥–æ–≤—É—é-—Å—É–º–º—É-–∏-–ø—Ä–æ—Ü–µ–Ω—Ç-–¥–ª—è-–∫–∞–∂–¥–æ–π-–∑–∞–ø–∏—Å–∏-–≤-–æ–¥–Ω–æ–º-–∑–∞–ø—Ä–æ—Å–µ)
   1. [–ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å –≤–æ–∑—Ä–∞—Å—Ç –ø–æ –¥–∞—Ç–µ —Ä–æ–∂–¥–µ–Ω–∏—è?](#–∫–∞–∫-–ø–æ–ª—É—á–∏—Ç—å-–≤–æ–∑—Ä–∞—Å—Ç-–ø–æ-–¥–∞—Ç–µ-—Ä–æ–∂–¥–µ–Ω–∏—è)
   1. [–ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å –¥–∞—Ç—É –∏–ª–∏ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ ISO-8601?](#–∫–∞–∫-–ø–æ–ª—É—á–∏—Ç—å-–¥–∞—Ç—É-–∏–ª–∏-–¥–∞—Ç—É-–∏-–≤—Ä–µ–º—è-–≤-—Ñ–æ—Ä–º–∞—Ç–µ-iso-8601)
   1. [–ö–∞–∫ –≤—ã—á–∏—Å–ª–∏—Ç—å –¥–∏—Å—Ç–∞–Ω—Ü–∏—é –º–µ–∂–¥—É 2-–º—è —Ç–æ—á–∫–∞–º–∏ –Ω–∞ –ó–µ–º–ª–µ –ø–æ –µ—ë –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏ –≤ –∫–∏–ª–æ–º–µ—Ç—Ä–∞—Ö?](#–∫–∞–∫-–≤—ã—á–∏—Å–ª–∏—Ç—å-–¥–∏—Å—Ç–∞–Ω—Ü–∏—é-–º–µ–∂–¥—É-2-–º—è-—Ç–æ—á–∫–∞–º–∏-–Ω–∞-–∑–µ–º–ª–µ-–ø–æ-–µ—ë-–ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏-–≤-–∫–∏–ª–æ–º–µ—Ç—Ä–∞—Ö)
   1. [–ö–∞–∫ –Ω–∞–π—Ç–∏ –±–ª–∏–∂–∞–π—à–∏–µ –Ω–∞—Å–µ–ª—ë–Ω–Ω—ã–µ –ø—É–Ω–∫—Ç—ã –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∑–∞–¥–∞–Ω–Ω—ã—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç?](#–∫–∞–∫-–Ω–∞–π—Ç–∏-–±–ª–∏–∂–∞–π—à–∏–µ-–Ω–∞—Å–µ–ª—ë–Ω–Ω—ã–µ-–ø—É–Ω–∫—Ç—ã-–æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ-–∑–∞–¥–∞–Ω–Ω—ã—Ö-–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç)
   1. [–ö–∞–∫ –≤—ã—á–∏—Å–ª–∏—Ç—å –ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω—ã–π –æ–±—ä—ë–º –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ SELECT –∑–∞–ø—Ä–æ—Å–∞?](#–∫–∞–∫-–≤—ã—á–∏—Å–ª–∏—Ç—å-–ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω—ã–π-–æ–±—ä—ë–º-–¥–∞–Ω–Ω—ã—Ö-–¥–ª—è-—Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞-select-–∑–∞–ø—Ä–æ—Å–∞)
   1. [–ü–æ—á–µ–º—É –∑–∞–ø—Ä–æ—Å —Å –ø–æ–¥–∑–∞–ø—Ä–æ—Å–æ–º –≤ NOT IN() –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 0 –∑–∞–ø–∏—Å–µ–π?](#–ø–æ—á–µ–º—É-–∑–∞–ø—Ä–æ—Å-—Å-–ø–æ–¥–∑–∞–ø—Ä–æ—Å–æ–º-–≤-not-in-–≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç-0-–∑–∞–ø–∏—Å–µ–π)
   1. [–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è record –∏ NULL](#–æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏-—Å—Ä–∞–≤–Ω–µ–Ω–∏—è-record-–∏-null)
   1. [–ö–∞–∫ –æ—á–µ–Ω—å –±—ã—Å—Ç—Ä–æ –ø–æ–ª—É—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –≤ –±–æ–ª—å—à–æ–π —Ç–∞–±–ª–∏—Ü–µ?](#–∫–∞–∫-–æ—á–µ–Ω—å-–±—ã—Å—Ç—Ä–æ-–ø–æ–ª—É—á–∏—Ç—å-–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ-–∑–∞–ø–∏—Å–µ–π-–≤-–±–æ–ª—å—à–æ–π-—Ç–∞–±–ª–∏—Ü–µ)
   1. [–ö–∞–∫ —Å–¥–µ–ª–∞—Ç—å —Ä–µ–∫—É—Ä—Å–∏–≤–Ω—ã–π –∑–∞–ø—Ä–æ—Å?](#–∫–∞–∫-—Å–¥–µ–ª–∞—Ç—å-—Ä–µ–∫—É—Ä—Å–∏–≤–Ω—ã–π-–∑–∞–ø—Ä–æ—Å)

**[–ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö (DML)](#–º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö-–¥–∞–Ω–Ω—ã—Ö-dml)**
   1. [–ö–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å –∏–ª–∏ –æ–±–Ω–æ–≤–∏—Ç—å –∑–∞–ø–∏—Å–∏ –æ–¥–Ω–∏–º –∑–∞–ø—Ä–æ—Å–æ–º (UPSERT)?](#–∫–∞–∫-–¥–æ–±–∞–≤–∏—Ç—å-–∏–ª–∏-–æ–±–Ω–æ–≤–∏—Ç—å-–∑–∞–ø–∏—Å–∏-–æ–¥–Ω–∏–º-–∑–∞–ø—Ä–æ—Å–æ–º-upsert)
   1. [–ö–∞–∫ —Å–¥–µ–ª–∞—Ç—å `INSERT ... ON CONFLICT ...` –±–µ–∑ —É–≤–µ–ª–∏—á–µ–Ω–∏—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –¥–ª—è –¥—É–±–ª–∏–∫–∞—Ç–æ–≤?](#–∫–∞–∫-—Å–¥–µ–ª–∞—Ç—å-insert--on-conflict--–±–µ–∑-—É–≤–µ–ª–∏—á–µ–Ω–∏—è-–ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏-–¥–ª—è-–¥—É–±–ª–∏–∫–∞—Ç–æ–≤)
   1. [–ö–∞–∫ –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ç–∞–±–ª–∏—Ü–∞—Ö –∏ –≤–µ—Ä–Ω—É—Ç—å id –∑–∞—Ç—Ä–æ–Ω—É—Ç—ã—Ö –∑–∞–ø–∏—Å–µ–π –≤ –æ–¥–Ω–æ–º –∑–∞–ø—Ä–æ—Å–µ?](#–∫–∞–∫-–º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å-–¥–∞–Ω–Ω—ã–µ-–≤-–Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö-—Ç–∞–±–ª–∏—Ü–∞—Ö-–∏-–≤–µ—Ä–Ω—É—Ç—å-id-–∑–∞—Ç—Ä–æ–Ω—É—Ç—ã—Ö-–∑–∞–ø–∏—Å–µ–π-–≤-–æ–¥–Ω–æ–º-–∑–∞–ø—Ä–æ—Å–µ)
   1. [–ö–∞–∫ –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü–∞—Ö –æ–¥–Ω–∏–º –∑–∞–ø—Ä–æ—Å–æ–º?](#–∫–∞–∫-–º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å-–¥–∞–Ω–Ω—ã–µ-–≤-—Å–≤—è–∑–∞–Ω–Ω—ã—Ö-—Ç–∞–±–ª–∏—Ü–∞—Ö-–æ–¥–Ω–∏–º-–∑–∞–ø—Ä–æ—Å–æ–º)
   1. [–ö–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å —Å id, –∑–Ω–∞—á–µ–Ω–∏–µ –∫–æ—Ç–æ—Ä–æ–≥–æ –Ω—É–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –µ—â—ë –≤ –¥—Ä—É–≥–æ–º –ø–æ–ª–µ –≤ —Ç–æ–º –∂–µ INSERT –∑–∞–ø—Ä–æ—Å–µ?](#–∫–∞–∫-–¥–æ–±–∞–≤–∏—Ç—å-–∑–∞–ø–∏—Å—å-—Å-id-–∑–Ω–∞—á–µ–Ω–∏–µ-–∫–æ—Ç–æ—Ä–æ–≥–æ-–Ω—É–∂–Ω–æ-—Å–æ—Ö—Ä–∞–Ω–∏—Ç—å-–µ—â—ë-–≤-–¥—Ä—É–≥–æ–º-–ø–æ–ª–µ-–≤-—Ç–æ–º-–∂–µ-insert-–∑–∞–ø—Ä–æ—Å–µ)
   1. [–ö–∞–∫ —Å–¥–µ–ª–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥—É—é—â–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ —Å –ø–æ–ª—É—á–µ–Ω–Ω—ã–º –ø—Ä–∏ –≤—Å—Ç–∞–≤–∫–µ id –∏–∑ –ø–µ—Ä–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞?](#–∫–∞–∫-—Å–¥–µ–ª–∞—Ç—å-–Ω–µ—Å–∫–æ–ª—å–∫–æ-–ø–æ—Å–ª–µ–¥—É—é—â–∏—Ö-–∑–∞–ø—Ä–æ—Å–æ–≤-—Å-–ø–æ–ª—É—á–µ–Ω–Ω—ã–º-–ø—Ä–∏-–≤—Å—Ç–∞–≤–∫–µ-id-–∏–∑-–ø–µ—Ä–≤–æ–≥–æ-–∑–∞–ø—Ä–æ—Å–∞)
   1. [–ö–∞–∫ –Ω–µ –æ–±–Ω–æ–≤–ª—è—Ç—å –∑–∞–ø–∏—Å—å, –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –∏–∑ UPDATE –∑–∞–ø—Ä–æ—Å–∞ –∏ –≤ –ë–î —Å–æ–≤–ø–∞–¥–∞—é—Ç?](#–∫–∞–∫-–Ω–µ-–æ–±–Ω–æ–≤–ª—è—Ç—å-–∑–∞–ø–∏—Å—å-–µ—Å–ª–∏-–¥–∞–Ω–Ω—ã–µ-–∏–∑-update-–∑–∞–ø—Ä–æ—Å–∞-–∏-–≤-–±–¥-—Å–æ–≤–ø–∞–¥–∞—é—Ç)
   1. [–ö–∞–∫ –æ–±–Ω–æ–≤–∏—Ç—å –∑–∞–ø–∏—Å—å —Ç–∞–∫, —á—Ç–æ–±—ã –Ω–µ –∑–∞—Ç–µ—Ä–µ—Ç—å —á—É–∂–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è, —É–∂–µ —Å–¥–µ–ª–∞–Ω–Ω—ã–µ –∫–µ–º-—Ç–æ?](#–∫–∞–∫-–æ–±–Ω–æ–≤–∏—Ç—å-–∑–∞–ø–∏—Å—å-—Ç–∞–∫-—á—Ç–æ–±—ã-–Ω–µ-–∑–∞—Ç–µ—Ä–µ—Ç—å-—á—É–∂–∏–µ-–∏–∑–º–µ–Ω–µ–Ω–∏—è-—É–∂–µ-—Å–¥–µ–ª–∞–Ω–Ω—ã–µ-–∫–µ–º-—Ç–æ)
   1. [–ö–∞–∫ –æ–±–Ω–æ–≤–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –∑–∞–ø–∏—Å–µ–π —Ä–∞–∑–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –≤ –æ–¥–Ω–æ–º –∑–∞–ø—Ä–æ—Å–µ?](#–∫–∞–∫-–æ–±–Ω–æ–≤–∏—Ç—å-–Ω–µ—Å–∫–æ–ª—å–∫–æ-–∑–∞–ø–∏—Å–µ–π-—Ä–∞–∑–Ω—ã–º–∏-–¥–∞–Ω–Ω—ã–º–∏-–≤-–æ–¥–Ω–æ–º-–∑–∞–ø—Ä–æ—Å–µ)
   1. [–ö–∞–∫ –æ–±–Ω–æ–≤–∏—Ç—å –∏–ª–∏ —É–¥–∞–ª–∏—Ç—å –º–∏–ª–ª–∏–æ–Ω—ã –∑–∞–ø–∏—Å–µ–π –≤ —Ç–∞–±–ª–∏—Ü–µ –Ω–µ –±–ª–æ–∫–∏—Ä—É—è –≤—Å–µ –∑–∞–ø–∏—Å–∏ –∏ –Ω–µ –Ω–∞–≥—Ä—É–∂–∞—è –ë–î?](#–∫–∞–∫-–æ–±–Ω–æ–≤–∏—Ç—å-–∏–ª–∏-—É–¥–∞–ª–∏—Ç—å-–º–∏–ª–ª–∏–æ–Ω—ã-–∑–∞–ø–∏—Å–µ–π-–≤-—Ç–∞–±–ª–∏—Ü–µ-–Ω–µ-–±–ª–æ–∫–∏—Ä—É—è-–≤—Å–µ-–∑–∞–ø–∏—Å–∏-–∏-–Ω–µ-–Ω–∞–≥—Ä—É–∂–∞—è-–±–¥)
   1. [–ö–∞–∫ —É–¥–∞–ª–∏—Ç—å –¥–µ—Å—è—Ç–∫–∏ —Ç—ã—Å—è—á –∑–∞–ø–∏—Å–µ–π –≤ —Ç–∞–±–ª–∏—Ü–µ –Ω–µ –±–ª–æ–∫–∏—Ä—É—è –≤—Å–µ –∑–∞–ø–∏—Å–∏ –∏ –Ω–µ –Ω–∞–≥—Ä—É–∂–∞—è –ë–î?](#–∫–∞–∫-—É–¥–∞–ª–∏—Ç—å-–¥–µ—Å—è—Ç–∫–∏-—Ç—ã—Å—è—á-–∑–∞–ø–∏—Å–µ–π-–≤-—Ç–∞–±–ª–∏—Ü–µ-–Ω–µ-–±–ª–æ–∫–∏—Ä—É—è-–≤—Å–µ-–∑–∞–ø–∏—Å–∏-–∏-–Ω–µ-–Ω–∞–≥—Ä—É–∂–∞—è-–±–¥)
   1. [–ö–∞–∫ –¥–ª—è –æ–¥–Ω–æ–π —Å—É—â–Ω–æ—Å—Ç–∏ —Å–¥–µ–ª–∞—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –Ω–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—Å—Ç–∞–≤–ª—è–µ–º—ã—Ö –∑–∞–≤–∏—Å–∏–º—ã—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π?](#–∫–∞–∫-–¥–ª—è-–æ–¥–Ω–æ–π-—Å—É—â–Ω–æ—Å—Ç–∏-—Å–¥–µ–ª–∞—Ç—å-–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ-–Ω–∞-–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ-–≤—Å—Ç–∞–≤–ª—è–µ–º—ã—Ö-–∑–∞–≤–∏—Å–∏–º—ã—Ö-—Å—É—â–Ω–æ—Å—Ç–µ–π)
   1. [–ö–∞–∫ —Å–¥–µ–ª–∞—Ç—å –∂—É—Ä–Ω–∞–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π —Ç–∞–±–ª–∏—Ü—ã?](#–∫–∞–∫-—Å–¥–µ–ª–∞—Ç—å-–∂—É—Ä–Ω–∞–ª–∏—Ä–æ–≤–∞–Ω–∏–µ-–∏–∑–º–µ–Ω–µ–Ω–∏–π-—Ç–∞–±–ª–∏—Ü—ã)
   1. [–ö–∞–∫ —Å–¥–µ–ª–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ–º–æ–µ –ø–æ–ª–µ `updated_at`?](#–∫–∞–∫-—Å–¥–µ–ª–∞—Ç—å-–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏-–æ–±–Ω–æ–≤–ª—è–µ–º–æ–µ-–ø–æ–ª–µ-updated_at)

**[–ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è —Å—Ö–µ–º—ã –¥–∞–Ω–Ω—ã—Ö (DDL)](#–º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è-—Å—Ö–µ–º—ã-–¥–∞–Ω–Ω—ã—Ö-ddl)**
   1. [–ö–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å –∫–æ–ª–æ–Ω–∫—É –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Ç–∞–±–ª–∏—Ü—É –±–µ–∑ –µ—ë –±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∏—è?](#–∫–∞–∫-–¥–æ–±–∞–≤–∏—Ç—å-–∫–æ–ª–æ–Ω–∫—É-–≤-—Å—É—â–µ—Å—Ç–≤—É—é—â—É—é-—Ç–∞–±–ª–∏—Ü—É-–±–µ–∑-–µ—ë-–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∏—è)
   1. [–ö–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã, –µ—Å–ª–∏ –æ–Ω–æ –µ—â—ë –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç?](#–∫–∞–∫-–¥–æ–±–∞–≤–∏—Ç—å-–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ-—Ç–∞–±–ª–∏—Ü—ã-–µ—Å–ª–∏-–æ–Ω–æ-–µ—â—ë-–Ω–µ-—Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
   1. [–ö–∞–∫ –∏–∑–º–µ–Ω–∏—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –≤–Ω–µ—à–Ω–µ–≥–æ –∫–ª—é—á–∞ –±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã?](#–∫–∞–∫-–∏–∑–º–µ–Ω–∏—Ç—å-–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ-–≤–Ω–µ—à–Ω–µ–≥–æ-–∫–ª—é—á–∞-–±–µ–∑-–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∏—è-—Ç–∞–±–ª–∏—Ü—ã)
   1. [–ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∏–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∑–∞–ø–∏—Å–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã N –ø–æ–ª–µ–π –∏–∑ M –≤–æ–∑–º–æ–∂–Ω—ã—Ö?](#–∫–∞–∫-–ø—Ä–æ–≤–µ—Ä–∏—Ç—å-—á—Ç–æ-–ø—Ä–∏-–¥–æ–±–∞–≤–ª–µ–Ω–∏–∏-–∏–ª–∏-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏-–∑–∞–ø–∏—Å–∏-–∑–∞–ø–æ–ª–Ω–µ–Ω—ã-n-–ø–æ–ª–µ–π-–∏–∑-m-–≤–æ–∑–º–æ–∂–Ω—ã—Ö)
   1. [–ö–∞–∫ –∏–∑ enum —Ç–∏–ø–∞ —É–¥–∞–ª–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ?](#–∫–∞–∫-–∏–∑-enum-—Ç–∏–ø–∞-—É–¥–∞–ª–∏—Ç—å-–∑–Ω–∞—á–µ–Ω–∏–µ)
   1. [–ö–∞–∫ –Ω–∞–π—Ç–∏ –≤—Å–µ —É–ø–æ–º–∏–Ω–∞–Ω–∏—è –Ω–∞–∑–≤–∞–Ω–∏—è –æ–±—ä–µ–∫—Ç–∞ –ë–î –ø–æ –≤—Å–µ–π –ë–î?](#–∫–∞–∫-–Ω–∞–π—Ç–∏-–≤—Å–µ-—É–ø–æ–º–∏–Ω–∞–Ω–∏—è-–Ω–∞–∑–≤–∞–Ω–∏—è-–æ–±—ä–µ–∫—Ç–∞-–±–¥-–ø–æ-–≤—Å–µ–π-–±–¥)
   1. [–ö–∞–∫ –∏–∑–º–µ–Ω–∏—Ç—å —Ç–∏–ø –∫–æ–ª–æ–Ω–∫–∏ —Å `int` –Ω–∞ `bigint`?](#–∫–∞–∫-–∏–∑–º–µ–Ω–∏—Ç—å-—Ç–∏–ø-–∫–æ–ª–æ–Ω–∫–∏-—Å-int-–Ω–∞-bigint)
   1. [–ö–∞–∫ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏, –µ—Å–ª–∏ –æ–Ω–æ –æ—Ç—Å—Ç–∞–ª–æ?](#–∫–∞–∫-–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å-–∑–Ω–∞—á–µ–Ω–∏–µ-–ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏-–µ—Å–ª–∏-–æ–Ω–æ-–æ—Ç—Å—Ç–∞–ª–æ)
  
**[–ò–Ω–¥–µ–∫—Å—ã](#–∏–Ω–¥–µ–∫—Å—ã)**
   1. [–ö–∞–∫ —Å–æ–∑–¥–∞—Ç—å –∏–ª–∏ –ø–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å –∏–Ω–¥–µ–∫—Å –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Ç–∞–±–ª–∏—Ü–µ –±–µ–∑ –µ—ë –±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∏—è?](#–∫–∞–∫-—Å–æ–∑–¥–∞—Ç—å-–∏–ª–∏-–ø–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å-–∏–Ω–¥–µ–∫—Å-–≤-—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π-—Ç–∞–±–ª–∏—Ü–µ-–±–µ–∑-–µ—ë-–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∏—è)
   1. [–ö–∞–∫ —Å–¥–µ–ª–∞—Ç—å —Å–æ—Å—Ç–∞–≤–Ω–æ–π —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å, –≥–¥–µ –æ–¥–Ω–æ –∏–∑ –ø–æ–ª–µ–π –º–æ–∂–µ—Ç –±—ã—Ç—å null?](#–∫–∞–∫-—Å–¥–µ–ª–∞—Ç—å-—Å–æ—Å—Ç–∞–≤–Ω–æ–π-—É–Ω–∏–∫–∞–ª—å–Ω—ã–π-–∏–Ω–¥–µ–∫—Å-–≥–¥–µ-–æ–¥–Ω–æ-–∏–∑-–ø–æ–ª–µ–π-–º–æ–∂–µ—Ç-–±—ã—Ç—å-null)
   1. [–ö–∞–∫ –ø–æ—á–∏–Ω–∏—Ç—å —Å–ª–æ–º–∞–Ω—ã–π —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å, –∏–º–µ—é—â–∏–π –¥—É–±–ª–∏–∫–∞—Ç—ã?](#–∫–∞–∫-–ø–æ—á–∏–Ω–∏—Ç—å-—Å–ª–æ–º–∞–Ω—ã–π-—É–Ω–∏–∫–∞–ª—å–Ω—ã–π-–∏–Ω–¥–µ–∫—Å-–∏–º–µ—é—â–∏–π-–¥—É–±–ª–∏–∫–∞—Ç—ã)
   1. [–ö–∞–∫ –≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å –∏–Ω–¥–µ–∫—Å?](#–∫–∞–∫-–≤—Ä–µ–º–µ–Ω–Ω–æ-–æ—Ç–∫–ª—é—á–∏—Ç—å-–∏–Ω–¥–µ–∫—Å)
   1. [–ö–∞–∫ —Å–¥–µ–ª–∞—Ç—å –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å –Ω–∞ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –ø–æ–ª–µ?](#–∫–∞–∫-—Å–¥–µ–ª–∞—Ç—å-–∫–æ–º–ø–∞–∫—Ç–Ω—ã–π-—É–Ω–∏–∫–∞–ª—å–Ω—ã–π-–∏–Ω–¥–µ–∫—Å-–Ω–∞-—Ç–µ–∫—Å—Ç–æ–≤–æ–µ-–ø–æ–ª–µ)

**[–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ](#–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ)**
   1. [–ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ —Å SQL –∑–∞–ø—Ä–æ—Å–∞–º–∏, –≤—ã–ø–æ–ª–Ω—è—é—â–∏—Ö—Å—è —Å–µ–π—á–∞—Å?](#–∫–∞–∫-–ø–æ–ª—É—á–∏—Ç—å-—Å–ø–∏—Å–æ–∫-–ø—Ä–æ—Ü–µ—Å—Å–æ–≤-—Å-sql-–∑–∞–ø—Ä–æ—Å–∞–º–∏-–≤—ã–ø–æ–ª–Ω—è—é—â–∏—Ö—Å—è-—Å–µ–π—á–∞—Å)
   1. [–ö–∞–∫ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–ª–∏ –∑–∞–≤–µ—Ä—à–∏—Ç—å —Ä–∞–±–æ—Ç—É –ø—Ä–æ—Ü–µ—Å—Å–æ–≤?](#–∫–∞–∫-–æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å-–∏–ª–∏-–∑–∞–≤–µ—Ä—à–∏—Ç—å-—Ä–∞–±–æ—Ç—É-–ø—Ä–æ—Ü–µ—Å—Å–æ–≤)
   1. [–ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Ñ—É–Ω–∫—Ü–∏–π –ë–î, –≤–∫–ª—é—á–∞—è —Ç—Ä–∏–≥–≥–µ—Ä–Ω—ã–µ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã?](#–∫–∞–∫-–ø–æ–ª—É—á–∏—Ç—å-—Å–ø–∏—Å–æ–∫-–≤—Å–µ—Ö-—Ñ—É–Ω–∫—Ü–∏–π-–±–¥-–≤–∫–ª—é—á–∞—è-—Ç—Ä–∏–≥–≥–µ—Ä–Ω—ã–µ-–ø—Ä–æ—Ü–µ–¥—É—Ä—ã)
   1. [–ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (–≤–Ω–µ—à–Ω–∏—Ö –∫–ª—é—á–µ–π) –º–µ–∂–¥—É —Ç–∞–±–ª–∏—Ü–∞–º–∏ –ë–î?](#–∫–∞–∫-–ø–æ–ª—É—á–∏—Ç—å-—Å–ø–∏—Å–æ–∫-–≤—Å–µ—Ö-–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π-–≤–Ω–µ—à–Ω–∏—Ö-–∫–ª—é—á–µ–π-–º–µ–∂–¥—É-—Ç–∞–±–ª–∏—Ü–∞–º–∏-–±–¥)
   1. [–ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∏–Ω–¥–µ–∫—Å–æ–≤?](#–∫–∞–∫-–ø–æ–ª—É—á–∏—Ç—å-—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É-–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è-–∏–Ω–¥–µ–∫—Å–æ–≤)
   1. [–ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π (extensions)?](#–∫–∞–∫-–ø–æ–ª—É—á–∏—Ç—å-—Å–ø–∏—Å–æ–∫-—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö-—Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π-extensions)
   1. [–ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ç–∞–±–ª–∏—Ü —Å —Ä–∞–∑–º–µ—Ä–æ–º –∑–∞–Ω–∏–º–∞–µ–º–æ–≥–æ –º–µ—Å—Ç–∞ –∏ –ø—Ä–∏–º–µ—Ä–Ω—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —Å—Ç—Ä–æ–∫?](#–∫–∞–∫-–ø–æ–ª—É—á–∏—Ç—å-—Å–ø–∏—Å–æ–∫-—Ç–∞–±–ª–∏—Ü-—Å-—Ä–∞–∑–º–µ—Ä–æ–º-–∑–∞–Ω–∏–º–∞–µ–º–æ–≥–æ-–º–µ—Å—Ç–∞-–∏-–ø—Ä–∏–º–µ—Ä–Ω—ã–º-–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º-—Å—Ç—Ä–æ–∫)
   1. [–ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Å–∞–º—ã—Ö —Ä–µ—Å—É—Ä—Å–æ—ë–º–∫–∏—Ö SQL –∑–∞–ø—Ä–æ—Å–æ–≤?](#–∫–∞–∫-–ø–æ–ª—É—á–∏—Ç—å-—Å–ø–∏—Å–æ–∫-—Å–∞–º—ã—Ö-—Ä–µ—Å—É—Ä—Å–æ—ë–º–∫–∏—Ö-sql-–∑–∞–ø—Ä–æ—Å–æ–≤)
   1. [–ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ SQL –∑–∞–ø—Ä–æ—Å–æ–≤, —Å–æ–∑–¥–∞—é—â–∏—Ö –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã?](#–∫–∞–∫-–ø–æ–ª—É—á–∏—Ç—å-—Å–ø–∏—Å–æ–∫-sql-–∑–∞–ø—Ä–æ—Å–æ–≤-—Å–æ–∑–¥–∞—é—â–∏—Ö-–≤—Ä–µ–º–µ–Ω–Ω—ã–µ-—Ñ–∞–π–ª—ã)
   1. [–ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å –∏ –∏–∑–º–µ–Ω–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è?](#–∫–∞–∫-–ø–æ–ª—É—á–∏—Ç—å-–∏-–∏–∑–º–µ–Ω–∏—Ç—å-–∑–Ω–∞—á–µ–Ω–∏—è-–ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤-–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏-–≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è)
   1. [–ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –≤ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –ø—Ä–æ—Ü–µ—Å—Å—ã –∞–≤—Ç–æ–≤–∞–∫—É—É–ºa –∏ –≤—Ä–µ–º—è –∏—Ö —Ä–∞–±–æ—Ç—ã?](#–∫–∞–∫-–ø–æ–ª—É—á–∏—Ç—å-–≤—Å–µ-–∞–∫—Ç–∏–≤–Ω—ã–µ-–≤-–¥–∞–Ω–Ω—ã–π-–º–æ–º–µ–Ω—Ç-–ø—Ä–æ—Ü–µ—Å—Å—ã-–∞–≤—Ç–æ–≤–∞–∫—É—É–ºa-–∏-–≤—Ä–µ–º—è-–∏—Ö-—Ä–∞–±–æ—Ç—ã)
   1. [–ö–∞–∫ —É–∑–Ω–∞—Ç—å, –ø–æ—á–µ–º—É –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ –æ—Ç –±–∞–∑—ã –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –ø–∞–¥–∞–µ—Ç?](#–∫–∞–∫-—É–∑–Ω–∞—Ç—å-–ø–æ—á–µ–º—É-–≤—Ä–µ–º—è-–æ—Ç–≤–µ—Ç–∞-–æ—Ç-–±–∞–∑—ã-–ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏-–ø–∞–¥–∞–µ—Ç)
   1. [–ö–∞–∫ –æ–±–µ–∑–æ–ø–∞—Å–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ—Ç —Ç—è–∂—ë–ª—ã—Ö –º–∏–≥—Ä–∞—Ü–∏–π, –ø—Ä–∏–≤–æ–¥—è—â–∏—Ö –∫ –±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∏—é –∑–∞–ø—Ä–æ—Å–æ–≤?](#–∫–∞–∫-–æ–±–µ–∑–æ–ø–∞—Å–∏—Ç—å-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ-–æ—Ç-—Ç—è–∂—ë–ª—ã—Ö-–º–∏–≥—Ä–∞—Ü–∏–π-–ø—Ä–∏–≤–æ–¥—è—â–∏—Ö-–∫-–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∏—é-–∑–∞–ø—Ä–æ—Å–æ–≤)
   1. [Simple index checking](#simple-index-checking)
   1. [–ö–∞–∫ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö?](#–∫–∞–∫-—Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å-–±–∞–∑—É-–¥–∞–Ω–Ω—ã—Ö)
   1. [–ö–∞–∫ –≤—ã–≥—Ä—É–∑–∏—Ç—å —Ç–∞–±–ª–∏—Ü—ã –∏–∑ –ë–î?](#–∫–∞–∫-–≤—ã–≥—Ä—É–∑–∏—Ç—å-—Ç–∞–±–ª–∏—Ü—ã-–∏–∑-–±–¥)
   1. [–ö–∞–∫ –≤—ã–≥—Ä—É–∑–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç SELECT –∑–∞–ø—Ä–æ—Å–∞ –≤ CSV?](#–∫–∞–∫-–≤—ã–≥—Ä—É–∑–∏—Ç—å-—Ä–µ–∑—É–ª—å—Ç–∞—Ç-select-–∑–∞–ø—Ä–æ—Å–∞-–≤-csv) 
   1. [–ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–∏–Ω—Ç–∞–∫—Å–∏—Å SQL –∫–æ–¥–∞ –±–µ–∑ –µ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è?](#–∫–∞–∫-–ø—Ä–æ–≤–µ—Ä–∏—Ç—å-—Å–∏–Ω—Ç–∞–∫—Å–∏—Å-sql-–∫–æ–¥–∞-–±–µ–∑-–µ–≥–æ-–≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è)
   1. [–ö–∞–∫ –æ—Ç–∫–∞—Ç–∏—Ç—å —á–∞—Å—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤–Ω—É—Ç—Ä–∏ —Ñ—É–Ω–∫—Ü–∏–∏ –∏–ª–∏ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã?](#–∫–∞–∫-–æ—Ç–∫–∞—Ç–∏—Ç—å-—á–∞—Å—Ç—å-—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏-–≤–Ω—É—Ç—Ä–∏-—Ñ—É–Ω–∫—Ü–∏–∏-–∏–ª–∏-–ø—Ä–æ—Ü–µ–¥—É—Ä—ã)
   1. [–ö–∞–∫ —Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞—Ç—å –¥–æ–ª–≥–∏–µ –ø—Ä–æ—Å—Ç–∞–∏–≤–∞—é—â–∏–µ –±–µ–∑ –¥–µ–ª–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î?](#–∫–∞–∫-—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞—Ç—å-–¥–æ–ª–≥–∏–µ-–ø—Ä–æ—Å—Ç–∞–∏–≤–∞—é—â–∏–µ-–±–µ–∑-–¥–µ–ª–∞-–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è-–∫-–±–¥)
   1. [–ö–∞–∫ —Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞—Ç—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã, –æ–±—Ä–∞–∑—É—é—â–∏–µ –æ—á–µ—Ä–µ–¥—å?](#–∫–∞–∫-—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞—Ç—å-–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ-–æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ-–∑–∞–ø—Ä–æ—Å—ã-–æ–±—Ä–∞–∑—É—é—â–∏–µ-–æ—á–µ—Ä–µ–¥—å)
   1. [–ö–∞–∫ –∂—É—Ä–Ω–∞–ª–∏—Ä–æ–≤–∞—Ç—å DDL –∫–æ–º–∞–Ω–¥—ã –≤ —Ç–∞–±–ª–∏—Ü—É –ë–î?](#–∫–∞–∫-–∂—É—Ä–Ω–∞–ª–∏—Ä–æ–≤–∞—Ç—å-ddl-–∫–æ–º–∞–Ω–¥—ã-–≤-—Ç–∞–±–ª–∏—Ü—É-–±–¥)
   1. [–ö–∞–∫ —É–∑–Ω–∞—Ç—å, –∫–∞–∫–∏–µ —Å–∞–º—ã–µ —á–∞—Å—Ç—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –≤ —Ç–∞–±–ª–∏—Ü–µ —Å–æ–≤–µ—Ä—à–∞—é—Ç—Å—è?](#–∫–∞–∫-—É–∑–Ω–∞—Ç—å-–∫–∞–∫–∏–µ-—Å–∞–º—ã–µ-—á–∞—Å—Ç—ã–µ-–¥–µ–π—Å—Ç–≤–∏—è-–≤-—Ç–∞–±–ª–∏—Ü–µ-—Å–æ–≤–µ—Ä—à–∞—é—Ç—Å—è)
   1. [–ö–∞–∫ —É–∑–Ω–∞—Ç—å –æ—Ç—Å—Ç–∞–≤–∞–Ω–∏–µ —Ä–µ–ø–ª–∏–∫?](#–∫–∞–∫-—É–∑–Ω–∞—Ç—å-–æ—Ç—Å—Ç–∞–≤–∞–Ω–∏–µ-—Ä–µ–ø–ª–∏–∫)
   1. [–ö–∞–∫ —É–∑–Ω–∞—Ç—å –ø—Ä–æ—Ü–µ–Ω—Ç –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Å–≤–æ–µ–≥–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–µ–π?](#–∫–∞–∫-—É–∑–Ω–∞—Ç—å-–ø—Ä–æ—Ü–µ–Ω—Ç-–¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è-—Å–≤–æ–µ–≥–æ-–º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ-–∑–Ω–∞—á–µ–Ω–∏—è-–¥–ª—è-–ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–µ–π)
   1. [–ö–∞–∫ —É–¥–∞–ª–∏—Ç—å –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ WAL —Ñ–∞–π–ª—ã?](#–∫–∞–∫-—É–¥–∞–ª–∏—Ç—å-–Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ-WAL-—Ñ–∞–π–ª—ã)

## –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö

### –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ –¥–æ–º–µ–Ω—ã

#### –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å email –Ω–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å?

–î–æ–º–µ–Ω [`email.sql`](domains/email.sql) (–≤–∞–ª–∏–¥–∞—Ü–∏—è –±–∞–∑–æ–≤–∞—è –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è, –Ω–æ –±—ã—Å—Ç—Ä–∞—è) –∏ —Ñ—É–Ω–∫—Ü–∏—è [`is_email.sql`](functions/is/is_email.sql) (–≤–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ—á—Ç–∏ –ø–æ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏, –Ω–æ –º–µ–¥–ª–µ–Ω–Ω–∞—è)

#### –ö–∞–∫ –Ω–∞–π—Ç–∏ –≤—Å–µ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–µ email –≤ —Ç–∞–±–ª–∏—Ü–µ?

```sql
SELECT email
FROM person_email
WHERE email IS NOT NULL    -- skip NULL
      AND email !~ '^\s*$' -- skip empty (similar NULL for NOT NULL column)
      NOT(
        AND octet_length(email) BETWEEN 6 AND 320 -- https://en.wikipedia.org/wiki/Email_address
        AND email LIKE '_%@_%.__%'                -- rough, but quick check email syntax
        AND is_email(email)                       -- accurate, but slow check email syntax
    )
```

–§—É–Ω–∫—Ü–∏—è [`is_email.sql`](functions/is/is_email.sql)

#### –ö–∞–∫ —É–¥–∞–ª–∏—Ç—å –≤—Å–µ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–µ email –∏–∑ –±–æ–ª—å—à–æ–π —Ç–∞–±–ª–∏—Ü—ã?

–ï—Å–ª–∏ —Å—Ç—Ä–æ–∫ –≤ —Ç–∞–±–ª–∏—Ü–µ –Ω–µ–º–Ω–æ–≥–æ –∏ –∑–∞–ø—Ä–æ—Å —Ä–∞–±–æ—Ç–∞–µ—Ç –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –±—ã—Å—Ç—Ä–æ, —Ç–æ –ø–æ–¥–æ–π–¥—ë—Ç –ø—Ä–æ—Å—Ç–æ–π `DELETE FROM table_name WHERE ...`.
–ï—Å–ª–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ –º–∏–ª–ª–∏–æ–Ω—ã —Å—Ç—Ä–æ–∫, —Ç–æ –ø—Ä–æ—Ü–µ—Å—Å –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—É—Ç—å—Å—è –Ω–∞–¥–æ–ª–≥–æ.
–ü—Ä–∏ —ç—Ç–æ–º –∑–∞–ø–∏—Å–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ —Ç–∞–∫ –∂–µ –∑–∞–±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è –Ω–∞–¥–æ–ª–≥–æ, –∞ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—é –∑–∞–ø–∏—Å–µ–π, –∫–æ—Ç–æ—Ä—ã–µ —Å–≤—è–∑–∞–Ω—ã —Å —ç—Ç–æ–π —Ç–∞–±–ª–∏—Ü–µ–π, –≤—ã—Å—Ç—Ä–æ—è—Ç—Å—è –≤ –æ—á–µ—Ä–µ–¥—å.
–†–µ—à–µ–Ω–∏–µ ‚Äî —É–¥–∞–ª—è—Ç—å –Ω—É–∂–Ω–æ –Ω–µ –≤—Å—ë —Å—Ä–∞–∑—É, –∞ –ø–æ —á–∞—Å—Ç—è–º.
–ü—Ä–∏–º–µ—Ä —Å–º. [`loop_execute`](procedures/loop_execute)

#### –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å CSS —Ü–≤–µ—Ç –Ω–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å?

–î–æ–º–µ–Ω: [`css_color.sql`](domains/css_color.sql)

#### –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∫–≤–∏–∑–∏—Ç—ã –∫–æ–º–ø–∞–Ω–∏–∏ (–ò–ù–ù, –ö–ü–ü, –û–ì–†–ù, –û–ì–†–ù–ò–ü) –Ω–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å?

##### –ò–ù–ù
–î–æ–º–µ–Ω—ã: [`inn.sql`](domains/inn.sql), [`inn10.sql`](domains/inn10.sql), [`inn12.sql`](domains/inn12.sql).
–§—É–Ω–∫—Ü–∏–∏: [`is_inn.sql`](functions/is/is_inn.sql), [`is_inn10.sql`](functions/is/is_inn10.sql), [`is_inn12.sql`](functions/is/is_inn12.sql).

##### –ö–ü–ü
–î–æ–º–µ–Ω: [`kpp.sql`](domains/kpp.sql).
–§—É–Ω–∫—Ü–∏—è: [`is_kpp.sql`](functions/is/is_kpp.sql).

##### –û–ì–†–ù
–î–æ–º–µ–Ω: [`ogrn.sql`](domains/ogrn.sql).
–§—É–Ω–∫—Ü–∏—è: [`is_ogrn.sql`](functions/is/is_ogrn.sql).

##### –û–ì–†–ù–ò–ü
–î–æ–º–µ–Ω: [`ogrnip.sql`](domains/ogrnip.sql).
–§—É–Ω–∫—Ü–∏—è: [`is_ogrnip.sql`](functions/is/is_ogrnip.sql).

#### –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –±–∞–Ω–∫–æ–≤—Å–∫–∏–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã (–ë–ò–ö, —Ä–∞—Å—á—ë—Ç–Ω—ã–π —Å—á—ë—Ç, –∫–æ—Ä—Ä–µ—Å–ø–æ–Ω–¥–µ–Ω—Ç—Å–∫–∏–π —Å—á—ë—Ç) –Ω–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å?

##### –ë–ò–ö
–î–æ–º–µ–Ω: [`bik.sql`](domains/bik.sql).
–§—É–Ω–∫—Ü–∏—è: [`is_bik.sql`](functions/is/is_bik.sql).

##### –ë–∞–Ω–∫–æ–≤—Å–∫–∏–π —Ä–∞—Å—á—ë—Ç–Ω—ã–π (–∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π) —Å—á—ë—Ç (—Ä/—Å)
–î–æ–º–µ–Ω: [`client_account.sql`](domains/client_account.sql).
–§—É–Ω–∫—Ü–∏—è: [`is_client_account.sql`](functions/is/is_client_account.sql).

##### –ë–∞–Ω–∫–æ–≤—Å–∫–∏–π –∫–æ—Ä—Ä–µ—Å–ø–æ–Ω–¥–µ–Ω—Ç–∫–∏–π —Å—á—ë—Ç (–∫/—Å)
–î–æ–º–µ–Ω: [`correspondent_account.sql`](domains/correspondent_account.sql).
–§—É–Ω–∫—Ü–∏—è: [`is_correspondent_account.sql`](functions/is/is_correspondent_account.sql).

#### –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –°–ù–ò–õ–° –Ω–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å?

–î–æ–º–µ–Ω: [`snils.sql`](domains/snils.sql).
–§—É–Ω–∫—Ü–∏—è: [`is_snils.sql`](functions/is/is_snils.sql).


#### –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –Ω–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å?

–î–æ–º–µ–Ω [`phone.sql`](domains/phone.sql) –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –≤ –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ E.164

–°–º. –µ—â—ë —Ñ—É–Ω–∫—Ü–∏–∏:
  1. [`phone_normalize.sql`](functions/phone/phone_normalize.sql)
  1. [`phone_parse.sql`](functions/phone/phone_parse.sql)
  1. [`phone_format.sql`](functions/phone/phone_format.sql)
  1. [`phone_format_record.sql`](functions/phone/phone_format_record.sql)

#### –ö–∞–∫ –ø—Ä–æ–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ–ª—è, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω–æ —è–≤–Ω–æ —É–∫–∞–∑–∞–Ω–æ –≤ UPDATE –∑–∞–ø—Ä–æ—Å–µ?

–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è [`CHECK()`](https://postgrespro.ru/docs/postgresql/12/ddl-constraints#DDL-CONSTRAINTS-CHECK-CONSTRAINTS) –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—è —Ç–∞–±–ª–∏—Ü—ã —Å—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç –∫–∞–∂–¥—ã–π —Ä–∞–∑ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∏–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∑–∞–ø–∏—Å–∏ —Ç–∞–±–ª–∏—Ü—ã. –ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∑–∞–ø–∏—Å–∏ –≤—Å—ë –ª–æ–≥–∏—á–Ω–æ ‚Äî –∑–Ω–∞—á–µ–Ω–∏–µ –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, –¥–∞–∂–µ –µ—Å–ª–∏ —ç—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ-—É–º–æ–ª—á–∞–Ω–∏—é. –û–¥–Ω–∞–∫–æ, –≤ –∑–∞–ø—Ä–æ—Å–µ –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω—ã—Ö –¥–∞–∂–µ –Ω–µ–≤–∞–∂–Ω–æ, –∏–∑–º–µ–Ω–∏–ª–æ—Å—å –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ–ª—è –Ω–∞ —Å–∞–º–æ–º –¥–µ–ª–µ –∏–ª–∏ –Ω–µ—Ç (–Ω—É –ø–æ—á–µ–º—É [—Ç–∞–∫ —Å–¥–µ–ª–∞–Ω–æ](test/check_constraint_stupid_demo.sql)?). –ï—Å–ª–∏ –≤ `CHECK` –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ—Å—É—Ä—Å–æ—ë–º–∞—è, —Ç–æ –æ–Ω–∞ –º–æ–∂–µ—Ç —Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω–æ –∑–∞–º–µ–¥–ª–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–æ–ª—å—à–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∑–∞–ø–∏—Å–µ–π –≤ —Ç–∞–±–ª–∏—Ü–µ. –ü—Ä–∏–º–µ—Ä —Ä–µ—Å—É—Ä—Å–æ—ë–º–∫–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ ‚Äî –≤–∞–ª–∏–¥–∞—Ü–∏—è —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ email —Ñ—É–Ω–∫—Ü–∏–µ–π [`is_email()`](functions/is/is_email.sql).

–û–±–æ–π—Ç–∏ –¥–∞–Ω–Ω—É—é –ø—Ä–æ–±–ª–µ–º—É –º–æ–∂–Ω–æ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤. 
–ü—Ä–µ–¥–ø–æ–ª–æ–∂–∏–º, –µ—Å—Ç—å —Ç–∞–±–ª–∏—Ü–∞ `person` —Å –∫–æ–ª–æ–Ω–∫–æ–π `email`.

```sql
CREATE OR REPLACE FUNCTION person_email_check() RETURNS TRIGGER
    LANGUAGE plpgsql AS
$$
BEGIN
    IF NOT is_email(NEW.email) THEN
        RAISE EXCEPTION 'Email % is not valid', NEW.email;
    END IF;
    RETURN NEW;
END;
$$;

-- –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ
DROP TRIGGER IF EXISTS person_email_check_insert ON person_email;
CREATE TRIGGER person_email_check_insert
    BEFORE INSERT ON person
    FOR EACH ROW
    WHEN (NEW.email IS NOT NULL
          AND NEW.email !~ '^\s*$')
    EXECUTE PROCEDURE person_email_check();

--–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
DROP TRIGGER IF EXISTS person_email_check_update ON person_email;
CREATE TRIGGER person_email_check_update
    BEFORE UPDATE OF email ON person -- –ø–æ–ª–µ —è–≤–Ω–æ —É–∫–∞–∑–∞–Ω–æ –≤ UPDATE –∑–∞–ø—Ä–æ—Å–µ!
    FOR EACH ROW
    WHEN (NEW.email IS NOT NULL
          AND NEW.email !~ '^\s*$'
          AND NEW.email IS DISTINCT FROM OLD.email) -- –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å
    EXECUTE PROCEDURE person_email_check();
```

### –ü–µ—Ä–µ–µ–∑–¥ –∏–∑ MySQL –≤ PostgreSQL

>There isn‚Äôt anything MySQL can do that PostgreSQL can‚Äôt do.
>However, there are things that PostgreSQL can do that MySQL can‚Äôt do.
http://mysqltopgsql.com/

#### –ö–∞–∫ —Å–¥–µ–ª–∞—Ç—å –∞–Ω–∞–ª–æ–≥ —Ñ—É–Ω–∫—Ü–∏–∏ `group_concat()` –∏–∑ MySQL

```sql
SELECT STRING_AGG(DISTINCT s, ', ' ORDER BY s) AS field_alias FROM (VALUES ('b'), ('a'), ('b')) AS t(s); -- a, b

SELECT ARRAY_TO_STRING(ARRAY_AGG(DISTINCT s ORDER BY s), ', ') AS field_alias FROM (VALUES ('b'), ('a'), ('b')) AS t(s); -- a, b
```

#### –ö–∞–∫ —Å–¥–µ–ª–∞—Ç—å –∞–Ω–∞–ª–æ–≥ —Ç–∏–ø–∞ `set` –∏–∑ MySQL?

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–±–∏–Ω–∞—Ü–∏—é –ø–µ—Ä–µ—á–∏—Å–ª—è–µ–º–æ–≥–æ —Ç–∏–ø–∞ –∏ –º–∞—Å—Å–∏–≤–∞. –ü—Ä–∏–º–µ—Ä: 

```sql
CREATE TYPE finger_type AS ENUM ('one', 'two', 'three', 'four', 'five');
CREATE TABLE my_table (
    fingers finger_type[] CHECK(/*cardinality(fingers) > 0 and*/
                                cardinality(array_unique(fingers)) = cardinality(fingers) --–ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å
                               )
);
```
–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ —Å–º–æ—Ç—Ä–∏ [`array_unique.sql`](functions/array/array_unique.sql)

#### –ö–∞–∫ —Å–¥–µ–ª–∞—Ç—å –∞–Ω–∞–ª–æ–≥ —Ñ—É–Ω–∫—Ü–∏–∏ `make_set()` –∏–∑ MySQL?

```sql
select to_json(array_agg(name))
from unnest(array['a','b','c', 'd']::text[]) with ordinality as s(name, num)
where 10 & (1 << (num::int-1)) > 0;

select array_agg(name)
from unnest(string_to_array('a,b,c,d', ',')) with ordinality as s(name, num)
where 10 & (1 << (num::int-1)) > 0;
```

### –°—Ç—Ä–æ–∫–∏

#### –ö–∞–∫ [—Ç—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∏—Ä–æ–≤–∞—Ç—å](https://ru.wikipedia.org/wiki/%D0%A2%D1%80%D0%B0%D0%BD%D1%81%D0%BB%D0%B8%D1%82%D0%B5%D1%80%D0%B0%D1%86%D0%B8%D1%8F) —Ä—É—Å—Å–∫–∏–µ –±—É–∫–≤—ã –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ?

[–í—Å—ë –æ —Ç—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏–∏](https://habr.com/ru/post/499574/)

–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Ç—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏–∏ –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ "[–Æ–ª–∏—è](https://github.com/nalgeon/iuliia)":
1. [iuliia_translate_mosmetro.sql](functions/iuliia_translate.sql)
2. [iuliia_translate_wikipedia.sql](functions/iuliia_translate.sql)

–£—Å—Ç–∞—Ä–µ–≤—à–∞—è —Ñ—É–Ω–∫—Ü–∏–∏ —Ç—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏–∏ [slugify_ru.sql](functions/slugify_ru.sql)

#### –ö–∞–∫ —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å CSV —Å—Ç—Ä–æ–∫—É –≤ —Ç–∞–±–ª–∏—Ü—É?

PostgreSQL —É–º–µ–µ—Ç —á–∏—Ç–∞—Ç—å –∏ –ø–∏—Å–∞—Ç—å CSV –≤ —Ñ–∞–π–ª –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –ë–î. –ê —ç—Ç–æ –ø–∞—Ä—Å–µ—Ä CSV –∏–∑ —Å—Ç—Ä–æ–∫–∏. –°–º–æ—Ç—Ä–∏ [`csv_parse.sql`](functions/csv_parse.sql)

–û–±–ª–∞—Å—Ç—å –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è ‚Äî –º–∞—Å—Å–æ–≤–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π –≤ —Ç–∞–±–ª–∏—Ü–∞—Ö –ë–î —á–µ—Ä–µ–∑ SQL –º–∏–≥—Ä–∞—Ü–∏–∏ –ë–î –∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã.

[–í—ã–ø–æ–ª–Ω–∏—Ç—å SQL](http://sqlfiddle.postgrespro.ru/#!22/0/17354) –∏–ª–∏ [–í—ã–ø–æ–ª–Ω–∏—Ç—å SQL](https://www.db-fiddle.com/f/eqsGTTqAmH1QoQ8LL63jM/1)

–ó–∞–ø—Ä–æ—Å

```sql
select
    CASE WHEN row[1] ~ '^\d+$' THEN row[1]::integer ELSE NULL END AS id,
    row[2] AS kladr_id,
    row[3] AS name
from csv_parse($$
id; kladr_id; name
501 ; 8300000000000 ; ";–ê–≤—Ç–æ–Ω–æ–º–Ω—ã–π ;"";–æ–∫—Ä—É–≥""
  ""–ù–µ–Ω–µ—Ü–∫–∏–π"";";unknown
      751;8600800000000; "  –ê–≤—Ç–æ–Ω–æ–º–Ω—ã–π –æ–∫—Ä—É–≥ ""–•–∞–Ω—Ç—ã-–ú–∞–Ω—Å–∏–π—Å–∫–∏–π"", –†–∞–π–æ–Ω –°–æ–≤–µ—Ç—Å–∫–∏–π" ;
     1755;8700300000000;  –ê–≤—Ç–æ–Ω–æ–º–Ω—ã–π –æ–∫—Ä—É–≥ –ß—É–∫–æ—Ç—Å–∫–∏–π, –†–∞–π–æ–Ω –ë–∏–ª–∏–±–∏–Ω—Å–∫–∏–π
     1725;7501900000000;–ö—Ä–∞–π –ó–∞–±–∞–π–∫–∞–ª—å—Å–∫–∏–π, –†–∞–π–æ–Ω –ü–µ—Ç—Ä–æ–≤—Å–∫-–ó–∞–±–∞–π–∫–∞–ª—å—Å–∫–∏–π

  ;;
       711;2302100000000;–ö—Ä–∞–π –ö—Ä–∞—Å–Ω–æ–¥–∞—Ä—Å–∫–∏–π, –†–∞–π–æ–Ω –õ–∞–±–∏–Ω—Å–∫–∏–π
       729;2401600000000;–ö—Ä–∞–π –ö—Ä–∞—Å–Ω–æ—è—Ä—Å–∫–∏–π, –†–∞–π–æ–Ω –ò–ª–∞–Ω—Å–∫–∏–π
       765;2700700000000;–ö—Ä–∞–π –•–∞–±–∞—Ä–æ–≤—Å–∫–∏–π, –†–∞–π–æ–Ω –í—è–∑–µ–º—Å–∫–∏–π
       765;;
$$, ';', false) as row;
```

–†–µ–∑—É–ª—å—Ç–∞—Ç

id|kladr_id|name
-:|:-------|:---
\<null>|kladr_id|name
501|8300000000000|;–ê–≤—Ç–æ–Ω–æ–º–Ω—ã–π ;";–æ–∫—Ä—É–≥"\n"–ù–µ–Ω–µ—Ü–∫–∏–π";
751|8600800000000|&nbsp;&nbsp;–ê–≤—Ç–æ–Ω–æ–º–Ω—ã–π –æ–∫—Ä—É–≥ "–•–∞–Ω—Ç—ã-–ú–∞–Ω—Å–∏–π—Å–∫–∏–π"| –†–∞–π–æ–Ω –°–æ–≤–µ—Ç—Å–∫–∏–π
1755|8700300000000|–ê–≤—Ç–æ–Ω–æ–º–Ω—ã–π –æ–∫—Ä—É–≥ –ß—É–∫–æ—Ç—Å–∫–∏–π| –†–∞–π–æ–Ω –ë–∏–ª–∏–±–∏–Ω—Å–∫–∏–π
1725|7501900000000|–ö—Ä–∞–π –ó–∞–±–∞–π–∫–∞–ª—å—Å–∫–∏–π| –†–∞–π–æ–Ω –ü–µ—Ç—Ä–æ–≤—Å–∫-–ó–∞–±–∞–π–∫–∞–ª—å—Å–∫–∏–π
711|2302100000000|–ö—Ä–∞–π –ö—Ä–∞—Å–Ω–æ–¥–∞—Ä—Å–∫–∏–π| –†–∞–π–æ–Ω –õ–∞–±–∏–Ω—Å–∫–∏–π
729|2401600000000|–ö—Ä–∞–π –ö—Ä–∞—Å–Ω–æ—è—Ä—Å–∫–∏–π| –†–∞–π–æ–Ω –ò–ª–∞–Ω—Å–∫–∏–π
765|2700700000000|–ö—Ä–∞–π –•–∞–±–∞—Ä–æ–≤—Å–∫–∏–π| –†–∞–π–æ–Ω –í—è–∑–µ–º—Å–∫–∏–π
765|\<null>|\<null>

#### –ö–∞–∫ –∑–∞–≥—Ä—É–∑–∏—Ç—å –≤ —Ç–∞–±–ª–∏—Ü—É –±–æ–ª—å—à–æ–π —Ñ–∞–π–ª-–∞—Ä—Ö–∏–≤ –≤ —Ñ–æ—Ä–º–∞—Ç–µ `csv.xz`?

–í–æ—Å–ø–æ–ª—å–∑—É–π—Ç–µ—Å—å —É—Ç–∏–ª–∏—Ç–æ–π [`psql`](https://postgrespro.ru/docs/postgresql/14/app-psql).
–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—å –º–µ—Ç–∞-–∫–æ–º–∞–Ω–¥—ã [`\copy`](https://postgrespro.ru/docs/postgresql/14/app-psql#APP-PSQL-META-COMMANDS-COPY) –≤ —Ç–æ–º, —á—Ç–æ –æ–Ω–∞ —á–∏—Ç–∞–µ—Ç —Ñ–∞–π–ª –∏–∑ ***–ª–æ–∫–∞–ª—å–Ω–æ–π —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã*** –∏ –ø–µ—Ä–µ—Å—ã–ª–∞–µ—Ç –µ–≥–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä –Ω–∞ –≤—Ö–æ–¥ SQL –∫–æ–º–∞–Ω–¥–µ [`COPY`](https://postgrespro.ru/docs/postgresql/14/sql-copy).

```sql
\copy test.regions from program 'xzcat regions.csv.xz' with (format csv, header false);
```


#### –ö–∞–∫ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ–ª –ø–æ –§–ò–û (—Ñ–∞–º–∏–ª–∏–∏, –∏–º–µ–Ω–∏, –æ—Ç—á–µ—Å—Ç–≤—É) –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ?

* [`gender_by_name`](functions/gender_by_name/)

#### –ö–∞–∫ –∑–∞–∫–≤–æ—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—Ç—Ä–æ–∫—É –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ —Ä–µ–≥—É–ª—è—Ä–Ω–æ–º –≤—ã—Ä–∞–∂–µ–Ω–∏–∏?

–°–º–æ—Ç—Ä–∏ [`quote_regexp.sql`](functions/quote_regexp.sql)

#### –ö–∞–∫ –∑–∞–∫–≤–æ—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—Ç—Ä–æ–∫—É –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –æ–ø–µ—Ä–∞—Ç–æ—Ä–µ LIKE?

–°–º–æ—Ç—Ä–∏ [`quote_like.sql`](functions/quote_like.sql)

### JSON

#### –ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å –∑–∞–ø–∏—Å–∏, –∫–æ—Ç–æ—Ä—ã–µ —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä—è—é—Ç —É—Å–ª–æ–≤–∏—è–º –∏–∑ JSON –º–∞—Å—Å–∏–≤–∞?

```sql
SELECT * FROM (
    VALUES ('[{"id" : 1, "created_at" : "2003-07-01", "name": "Sony"}, 
              {"id" : 2, "created_at" : "2008-10-27", "name": "Samsung"}]'::jsonb),
           ('[{"id" : 3, "created_at" : "2010-03-30", "name": "LG"},   
             {"id" : 4, "created_at" : "2018-12-09", "name": "Apple"}]'::jsonb)
) AS t
WHERE EXISTS(
          SELECT *
          FROM jsonb_to_recordset(t.column1) AS x(id int, created_at timestamp, name text)
          WHERE x.id IN (1, 3) AND x.created_at > '2000-01-01' AND name NOT LIKE 'P%'
      )
```

#### –ö–∞–∫ —Å—Ä–∞–≤–Ω–∏—Ç—å 2 JSON –æ–±—ä–µ–∫—Ç–∞ –∏ –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–ª–∏—á–∏—è?

–°–º–æ—Ç—Ä–∏ [` jsonb_object_diff.sql`](functions/json/jsonb_object_diff.sql)

### –ú–∞—Å—Å–∏–≤—ã

#### –ê–≥—Ä–µ–≥–∞—Ç–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∫–æ–Ω–∫–∞—Ç–µ–Ω–∞—Ü–∏–∏ (–æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è) –º–∞—Å—Å–∏–≤–æ–≤

–°–º–æ—Ç—Ä–∏ [`array_cat_agg.sql`](functions/array/array_cat_agg.sql)

#### –ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –º–∞—Å—Å–∏–≤–æ–≤ (–ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ –º–∞—Å—Å–∏–≤–æ–≤)?

```sql
-- –¥–ª—è 2-—Ö –º–∞—Å—Å–∏–≤–æ–≤
select array_agg(a) 
from unnest(array[1, 2, 3, 4, 5]) a 
where a = any(array[4, 5, 6, 7, 8]); -- {4,5}

-- –¥–ª—è N –º–∞—Å—Å–∏–≤–æ–≤
select array_agg(a1)
from unnest(array[1, 2, 3, 4, 5]) a1
inner join unnest(array[3, 4, 5, 6, 7]) a2 on a1 = a2
inner join unnest(array[4, 5, 6, 7, 8]) a3 on a1 = a3; -- {4,5}
```

#### –ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –º–∞—Å—Å–∏–≤–∞ –∏–ª–∏ –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∏—Ö?

–î–ª—è `int[]` –ª—É—á—à–µ –≤–æ—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –≥–æ—Ç–æ–≤—ã–º–∏ —Ñ—É–Ω–∫—Ü–∏—è–º–∏ `uniq()` –∏ `sort()` –∏–∑ –º–æ–¥—É–ª—è [intarray](https://postgrespro.ru/docs/postgresql/12/intarray).

```sql
-- —Å–ø–æ—Å–æ–± 1
SELECT ARRAY_AGG(DISTINCT a ORDER BY a) FROM UNNEST(ARRAY[1,2,3,2,1]) t(a); -- {1,2,3}

-- —Å–ø–æ—Å–æ–± 2
SELECT ARRAY(SELECT DISTINCT UNNEST(ARRAY[1,2,3,2,1]) ORDER BY 1); -- {1,2,3}

-- –≥–æ—Ç–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è
CREATE FUNCTION array_unique(anyarray) RETURNS anyarray AS $$
SELECT array_agg(DISTINCT x ORDER BY x) FROM unnest($1) t(x);
$$ LANGUAGE SQL IMMUTABLE;
```

#### –ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–ª–∏—á–∞—é—â–∏–µ—Å—è —ç–ª–µ–º–µ–Ω—Ç—ã –¥–≤—É—Ö –º–∞—Å—Å–∏–≤–æ–≤?

```sql
create or replace function array_diff(anyarray, anyarray)
    returns anyarray
    language sql
as $$
select array(
    select *
    from (select unnest($1) as element) t
    where element not in (select unnest($2))
);
$$;

-- –ø–æ–≤–µ–¥–µ–Ω–∏–µ –æ–¥–∏–Ω–∞–∫–æ–≤–æ–µ —Å –æ–¥–Ω–æ–∏–º—ë–Ω–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–µ–π –Ω–∞ PHP
select array_diff(array[2, 4, 7, 8], array[1, 2, 3, 4, 5]); -- {7,8}
```

#### –ö–∞–∫ —Å–¥–µ–ª–∞—Ç—å –≤–Ω–µ—à–Ω–∏–π –∫–ª—é—á –Ω–∞ —ç–ª–µ–º–µ–Ω—Ç—ã –º–∞—Å—Å–∏–≤–∞?

–ù–µ–ª—å–∑—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–æ–ª–æ–Ω–∫—É-–º–∞—Å—Å–∏–≤ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤, –∑–Ω–∞—á–µ–Ω–∏—è –∫–æ—Ç–æ—Ä—ã—Ö —Å—Å—ã–ª–∞—é—Ç—Å—è –Ω–∞ –∑–Ω–∞—á–µ–Ω–∏—è –∫–æ–ª–æ–Ω–∫–∏ –∏–∑ –¥—Ä—É–≥–æ–π —Ç–∞–±–ª–∏—Ü—ã –ø–æ –≤–Ω–µ—à–Ω–µ–º—É –∫–ª—é—á—É (FK). –≠—Ç–æ –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç [–ø–µ—Ä–≤–æ–π –Ω–æ—Ä–º–∞–ª—å–Ω–æ–π —Ñ–æ—Ä–º–µ](https://ru.wikipedia.org/wiki/%D0%9F%D0%B5%D1%80%D0%B2%D0%B0%D1%8F_%D0%BD%D0%BE%D1%80%D0%BC%D0%B0%D0%BB%D1%8C%D0%BD%D0%B0%D1%8F_%D1%84%D0%BE%D1%80%D0%BC%D0%B0) –≤ —Ä–µ–ª—è—Ü–∏–æ–Ω–Ω–æ–π –º–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö. –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é —Ç–∞–±–ª–∏—Ü—É –≤ –æ—Ç–Ω–æ—à–µ–Ω–∏–∏ "–æ–¥–∏–Ω –∫–æ –º–Ω–æ–≥–∏–º". –¢–∞–∫ –∂–µ –≤ —ç—Ç–æ–º —Å–ª—É—á–∞–µ –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ –≤–Ω–µ—à–Ω–∏–º –∫–ª—é—á–∞–º –∏ –∏—Å–∫–ª—é—á–µ–Ω–∏—é –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –¥–æ—Å—Ç—É–ø–Ω—ã —à—Ç–∞—Ç–Ω—ã–µ –º–µ—Ö–∞–Ω–∏–∑–º—ã.

–û–¥–Ω–∞–∫–æ, —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏ —ç—Ç–æ –≤–æ–∑–º–æ–∂–Ω–æ. –ù–∏–∂–µ –ø—Ä–∏–º–µ—Ä –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–Ω–∞—á–µ–Ω–∏–π –º–∞—Å—Å–∏–≤–∞ –±–µ–∑ —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ –Ω–∞ PostgreSQL 10.5.
–¢.–∫. FK –¥–ª—è –º–∞—Å—Å–∏–≤–æ–≤ –¥–µ–ª–∞—Ç—å –Ω–µ–ª—å–∑—è, –∫–æ–¥ —Ñ—É–Ω–∫—Ü–∏–∏ –≥–æ–¥–∏—Ç—Å—è –∫–∞–∫ —à–∞–±–ª–æ–Ω –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ —Å–ª–æ–∂–Ω—ã—Ö –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –º–∞—Å—Å–∏–≤–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä [ltree](https://postgrespro.ru/docs/postgrespro/12/ltree)).

```sql
create schema if not exists test;

CREATE OR REPLACE FUNCTION test.check_foreign_key_array(data anyarray, ref_schema text, ref_table text, ref_column text)
    RETURNS BOOL
    RETURNS NULL ON NULL INPUT
    LANGUAGE plpgsql
AS
$body$
DECLARE
    fake_id text;
    sql text default format($$
            select id::text
            from unnest($1) as x(id)
            where id is not null
              and id not in (select %3$I
                             from %1$I.%2$I
                             where %3$I = any($1))
            limit 1;
        $$, ref_schema, ref_table, ref_column);
BEGIN
    EXECUTE sql USING data INTO fake_id;

    IF (fake_id IS NOT NULL) THEN
        RAISE NOTICE 'Array element value % does not exist in column %.%.%', fake_id, ref_schema, ref_table, ref_column;
        RETURN false;
    END IF;

    RETURN true;
END
$body$;

drop table if exists test.t1, test.t2;

create table test.t1 (
    id integer generated by default as identity primary key
);

create table test.t2 (
    id integer generated by default as identity primary key,
    t1_ids integer[] not null check (test.check_foreign_key_array(t1_ids, 'test', 't1', 'id'))
);

insert into test.t1 (id) values (default), (default), (default); --ok
insert into test.t2 (id, t1_ids) values (default, array[1,2,3]); --ok
insert into test.t2 (id, t1_ids) values (default, array[1,2,3,555]); --error
```

–ü—Ä–∏–º–µ—Ä –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –¥–ª—è —Ç–∏–ø–∞ –ø–æ–ª—è [ltree](https://postgrespro.ru/docs/postgrespro/12/ltree):
```sql
alter table region
    add constraint region_tree_path_ids_check
        check (
                tree_path_ids::text ~ '^\d+(\.\d+)*$|^$' -- —Å–ø–∏—Å–æ–∫ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏—Ö id —á–µ—Ä–µ–∑ —Ç–æ—á–∫—É
                and check_foreign_key_array(string_to_array(tree_path_ids::text, '.')::int[], 'public', 'region', 'id')
        )
        not valid; --–ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
```

### –ü–æ–∏—Å–∫ –ø–æ —Ñ—Ä–∞–∑–µ (—Ç–æ—á–Ω—ã–π –∏ –Ω–µ—Ç–æ—á–Ω—ã–π)

#### –ö–∞–∫ –Ω–∞–π—Ç–∏ —Å–ø–∏—Å–æ–∫ —Å—Ç—Ä–æ–∫, —Å–æ–≤–ø–∞–¥–∞—é—â–∏—Ö —Å–æ —Å–ø–∏—Å–∫–æ–º —à–∞–±–ª–æ–Ω–æ–≤?
```sql
-- –±—ã–ª–æ
SELECT *
FROM (VALUES
      ('foo bar zap bing'),
      ('man foo'),
      ('bar zap'),
      ('bing'),
      ('foo bar')) AS t(words)
WHERE words LIKE '%bar%' OR words LIKE '%zap%' OR words LIKE '%fix%' OR words LIKE '%new%';

-- —Å—Ç–∞–ª–æ
SELECT *
FROM (VALUES
      ('foo bar zap bing'),
      ('man foo'),
      ('bar zap'),
      ('bing'),
      ('foo bar')) AS t(words)
WHERE words LIKE ANY (ARRAY['%bar%', '%zap%', '%fix%', '%new%']);
```

#### –ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏—è —Å—É—â–Ω–æ—Å—Ç–µ–π –ø–æ –ø–æ–∏—Å–∫–æ–≤–æ–π —Ñ—Ä–∞–∑–µ —Å —É—á—ë—Ç–æ–º –Ω–∞—á–∞–ª–∞ —Å–ª–æ–≤ (–ø–æ–∏—Å–∫–æ–≤—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏)?

–°–º. —Ç–∞–∫ –∂–µ [–ø–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤—ã–π –ø–æ–∏—Å–∫](https://postgrespro.ru/docs/postgresql/11/textsearch).

```sql
CREATE INDEX /*CONCURRENTLY*/ t_name_trigram_index ON t USING GIN (lower(name) gin_trgm_ops);

WITH
normalize AS (
    SELECT ltrim(REGEXP_REPLACE(LOWER('–±–∞—Ä '), '[^–∞-—è—ëa-z0-9]+', ' ', 'gi')) AS query
),
vars AS (
    SELECT CONCAT('%', REPLACE(quote_like(trim(normalize.query)), ' ', '_%'), '%') AS query_like,
           --CONCAT('(?<![–∞-—è—ëa-z0-9])', REPLACE(quote_regexp(normalize.query), ' ', '(?:[^–∞-—è—ëa-z0-9]+|$)')) AS query_regexp
           CONCAT('\m', REPLACE(quote_regexp(normalize.query), ' ', '(?:[^–∞-—è—ëa-z0-9]+|$)')) AS query_regexp
    FROM normalize
)
SELECT 
  t.name,
  lower(t.name) LIKE RTRIM(normalize.query) AS is_leading
FROM t, vars, normalize
WHERE
  length(rtrim(normalize.query)) > 0 -- –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏
  AND lower(t.name) LIKE vars.query_like -- –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏
  AND lower(t.name) ~* vars.query_regexp -- –¥–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏
ORDER BY 
  is_leading DESC,
  LENGTH(name), 
  name
LIMIT 100
```
–§—É–Ω–∫—Ü–∏–∏ [`quote_like.sql`](functions/quote_like.sql), [`quote_regexp.sql`](functions/quote_regexp.sql)

#### –ö–∞–∫ –¥–ª—è —Å–ª–æ–≤–∞ —Å –æ–ø–µ—á–∞—Ç–∫–æ–π (–æ—à–∏–±–∫–æ–π) –ø–æ–ª—É—á–∏—Ç—å –Ω–∞–∏–±–æ–ª–µ–µ –ø–æ–¥—Ö–æ–¥—è—â–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã —Å–ª–æ–≤ –¥–ª—è –∑–∞–º–µ–Ω—ã (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–ø–µ—á–∞—Ç–æ–∫)?

–°–º–æ—Ç—Ä–∏ [`typos_correct`](functions/typos_correct/)

**–ü—Ä–∏–º–µ—Ä —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –∑–∞–ø—Ä–æ—Å–∞**

word_num|word_from|is_mistake|can_correct|words_to|words_details
-------:|:--------|:---------|:----------|:-------------|:-------------
1 |–≤–∞–¥–∏—Ç–ª—å|true|true|\["–≤–æ–¥–∏—Ç–µ–ª—å"]|NULL
2 |–¥–∏—Ñ–µ–∫—Ç–æ–ª–æ–≥|true|false|\["–¥–µ—Ñ–µ–∫—Ç–æ–ª–æ–≥", "–¥–∏—Ä–µ–∫—Ç–æ–ª–æ–≥", "–¥–∏–µ—Ç–æ–ª–æ–≥"]|NULL
3 |—Ñ–æ—Ä–º–æ–≤—à–∏—Ü–∞|true|true|\["—Ñ–æ—Ä–º–æ–≤—â–∏—Ü–∞"]|NULL
4 |—Ñ—Ä–º–æ–≤—â–∏—Ü–∞|true|true|\["—Ñ–æ—Ä–º–æ–≤—â–∏—Ü–∞"]|NULL
5 |–±—Ö—É–≥–∞–ª—Ç–µ—Ä|true|true|\["–±—É—Ö–≥–∞–ª—Ç–µ—Ä"]|NULL
6 |–ª–∫—Ç–æ—Ä|true|true|\["–ª–µ–∫—Ç–æ—Ä"]|NULL
7 |–¥–∏–∫—Ç–æ|true|true|\["–¥–∏–∫—Ç–æ—Ä"]|NULL
8 |–≤—Ä–∞|true|true|\["–≤—Ä–∞—á"]|NULL
9 |–ø—Ä–∞–≥—Ä–æ–º–∏—Å—Ç|true|true|\["–ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç"]|NULL
10|–∑–∞—Ç–µ–π–Ω–∏–∫|false|false|NULL|NULL
11|—Å–º–æ—Ç—Ä–∏—Ç–µ–ª—å|false|false|NULL|NULL
12|unknown|true|false|NULL|NULL

**–û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞**
1. –ó–∞–ø—Ä–æ—Å —Ç–∞–∫ –∂–µ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–∏—Å–∫–æ–≤—ã—Ö –ø–æ–¥—Å–∫–∞–∑–æ–∫ (—Å —É—á—ë—Ç–æ–º –Ω–∞—á–∞–ª–∞ —Å–ª–æ–≤), –µ—Å–ª–∏ –µ–≥–æ –Ω–µ–º–Ω–æ–≥–æ –º–æ–¥–µ—Ä–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å. –ü—Ä–∞–∫—Ç–∏–∫–∏ –ø–æ–∫–∞ –Ω–µ—Ç, –∞ –≤ —Ç–µ–æ—Ä–∏–∏ –Ω—É–∂–Ω–æ —É–±—Ä–∞—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–æ –¥–∏—Å—Ç–∞–Ω—Ü–∏–∏ –õ–µ–≤–µ–Ω—à—Ç–µ–π–Ω–∞.
1. –ó–∞–ø—Ä–æ—Å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç GIN –∏–Ω–¥–µ–∫—Å, –ø–æ—ç—Ç–æ–º—É —Ä–∞–±–æ—Ç–∞–µ—Ç –±—ã—Å—Ç—Ä–æ.
1. –°—Ä–µ–¥–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –¥–µ–ª–∞—é—Ç –æ–ø–µ—á–∞—Ç–∫–∏, –µ—Å—Ç—å —Ç–µ, –∫–æ—Ç–æ—Ä—ã–µ –¥–µ–ª–∞—é—Ç –≥—Ä–∞–º–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏. –ü–æ—ç—Ç–æ–º—É, –ø—Ä–∏ —Ä–∞—Å—á—ë—Ç–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è –õ–µ–≤–µ–Ω—à—Ç–µ–π–Ω–∞, —Ü–µ–Ω–∞ –≤—Å—Ç–∞–≤–∫–∏ –∏ —É–¥–∞–ª–µ–Ω–∏—è –±—É–∫–≤—ã –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤—ã—à–µ, —á–µ–º –∑–∞–º–µ–Ω—ã. –¶–µ–Ω—ã –æ–ø–µ—Ä–∞—Ü–∏–π —è–≤–ª—è–µ—é—Ç—Å—è —Ü–µ–ª–æ—á–∏—Å–ª–µ–Ω–Ω—ã–º–∏ —á–∏—Å–ª–∞–º–∏, –∫–æ—Ç–æ—Ä—ã–µ –Ω–∞–º –Ω–µ –æ—á–µ–Ω—å –ø–æ–¥—Ö–æ–¥—è—Ç, –ø–æ—ç—Ç–æ–º—É –ø—Ä–∏—Ö–æ–¥–∏—Ç—Å—è –¥–µ–ª–∞—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Ä–∞—Å—á—ë—Ç.
1. –ü–æ—Ä–æ–≥–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ–¥–æ–±—Ä–∞–Ω—ã –æ–ø—ã—Ç–Ω—ã–º –ø—É—Ç—ë–º.
1. –ï—Å–ª–∏ —É –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –ø–æ–¥—Ä—è–¥ —Ä–µ–π—Ç–∏–Ω–≥ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –Ω–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ, —Ç–æ —ç—Ç–æ –Ω–µ —Ç–æ—á–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (–∞–≤—Ç–æ–∏—Å–ø—Ä–∞–≤–ª—è—Ç—å –Ω–µ–ª—å–∑—è, —Ç–æ–ª—å–∫–æ –ø—Ä–µ–¥–ª–∞–≥–∞—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç—ã)

–ê–ª–≥–æ—Ä–∏—Ç–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—à–∏–±–æ–∫ –∏ –æ–ø–µ—á–∞—Ç–æ–∫ –æ—Å–Ω–æ–≤–∞–Ω –ø–æ–∏—Å–∫–µ —Å–æ–≤–ø–∞–¥–∞—é—â–∏—Ö —Ç—Ä–∏–≥—Ä–∞–º–º (—É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è "–ø–æ—Ö–æ–∂–µ—Å—Ç—å" —Å–ª–æ–≤–∞) –∏ –Ω–∞ –≤—ã—á–∏—Å–ª–µ–Ω–∏–∏ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è [–õ–µ–≤–µ–Ω—à—Ç–µ–π–Ω–∞](https://ru.wikipedia.org/wiki/–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ_–õ–µ–≤–µ–Ω—à—Ç–µ–π–Ω–∞).
–¢–æ—á–Ω–æ—Å—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–ª–æ–≤–∞ –∑–∞–≤–∏—Å–∏—Ç –≤ —Ç.—á. –æ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –±—É–∫–≤ –≤ —Å–ª–æ–≤–µ.
–ü–æ–ª—É—á–∞—Ç—å —Å–ª–æ–≤–∞-–∫–∞–Ω–¥–∏–¥–∞—Ç—ã –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—à–∏–±–æ–∫ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–ª—è `R > 0.55` –∏ `D < 5`

–î–ª–∏–Ω–∞ —Å–ª–æ–≤–∞, –±—É–∫–≤ (L) | –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–∏—Å—Ç–∞–Ω—Ü–∏—è –õ–µ–≤–µ–Ω—à—Ç–µ–π–Ω–∞ (D) | –î–æ–ª—è R = (1 ‚àí (D √∑ L))
---:|--:|:--
2	|0	|1
3	|1	|0.6666
4	|1	|0.75
5	|2	|0.6
6	|2	|0.6666
7	|3	|0.5714
8	|3	|0.625
9	|3	|0.6666
10	|4	|0.6
11	|4	|0.6363
12	|4	|0.6666
13	|4	|0.6923
14 –∏ –±–æ–ª–µ–µ	|4	|0.7142

### –î–µ—Ä–µ–≤—å—è –∏ –≥—Ä–∞—Ñ—ã

#### –ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –Ω–∞–∑–≤–∞–Ω–∏–π –ø—Ä–µ–¥–∫–æ–≤ –∏ –Ω–∞—Å–ª–µ–¥–Ω–∏–∫–æ–≤ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —É–∑–ª–∞ –¥–µ—Ä–µ–≤–∞ (–Ω–∞ –ø—Ä–∏–º–µ—Ä–µ —Ä–µ–≥–∏–æ–Ω–æ–≤)?

![XPath-axes](XPath-axes.png)

```sql
SELECT
    id,
    nlevel(ltree_path) AS level,
    ltree_path AS id_path,
    (SELECT array_agg(st.name ORDER BY nlevel(st.ltree_path)) FROM region AS st WHERE st.ltree_path @> t.ltree_path AND st.ltree_path != t.ltree_path) AS ancestors,
    name AS self,
    (SELECT array_agg(st.name ORDER BY nlevel(st.ltree_path)) FROM region AS st WHERE st.ltree_path <@ t.ltree_path AND st.ltree_path != t.ltree_path) AS descendants
    --, t.*
FROM region AS t
WHERE nlevel(ltree_path) >= 2
ORDER BY nlevel(ltree_path) ASC, ancestors
LIMIT 1000;
```

#### –ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏–µ —Å–≤—è–∑–∏ –≤ –≥—Ä–∞—Ñ–µ?

```sql
WITH paths_with_cycle(depth, path) AS (
 WITH RECURSIVE search_graph(parent_id, child_id, depth, path, cycle) AS (
   SELECT g.parent_id, g.child_id, 1,
     ARRAY[g.parent_id],
     false
   FROM custom_query_group_relationship AS g
   UNION ALL
   SELECT g.parent_id, g.child_id, sg.depth + 1,
     path || g.parent_id,
     g.parent_id = ANY(path)
   FROM custom_query_group_relationship AS g, search_graph sg
   WHERE g.parent_id = sg.child_id AND cycle IS FALSE
 )
 SELECT depth, path FROM search_graph WHERE cycle IS TRUE
 ORDER BY depth
)
SELECT DISTINCT path FROM paths_with_cycle
WHERE depth = (SELECT MIN(depth) FROM paths_with_cycle)
```

#### –ö–∞–∫ –∑–∞—â–∏—Ç–∏—Ç—å—Å—è –æ—Ç —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏—Ö —Å–≤—è–∑–µ–π –≤ –≥—Ä–∞—Ñ–µ?

SQL-–∑–∞–ø—Ä–æ—Å—ã `WITH RECURSIVE...` –¥–æ–ª–∂–Ω—ã –∏–º–µ—Ç—å [–∑–∞—â–∏—Ç—É –æ—Ç –∑–∞—Ü–∏–∫–ª–∏–≤–∞–Ω–∏—è](https://stackoverflow.com/questions/51025607/prevent-infinite-loop-in-recursive-query-in-postgresql)! –ö–æ–≥–¥–∞ –∑–∞–ø—Ä–æ—Å –∑–∞—Ü–∏–∫–ª–∏—Ç—Å—è, –æ–Ω –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –æ—á–µ–Ω—å –¥–æ–ª–≥–æ, —Å—ä–µ–¥–∞—è —Ä–µ—Å—É—Ä—Å—ã –ë–î. –ê –µ—â—ë —Ç–∞–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –±—É–¥–µ—Ç –º–Ω–æ–≥–æ. –ü–æ–≤–µ–∑—ë—Ç, –µ—Å–ª–∏ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç –∑–∞—â–∏—Ç–∞ —Å–∞–º–æ–≥–æ PostgreSQL.

#### –ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏—è –≤—Å–µ—Ö —É—Ä–æ–≤–Ω–µ–π —Å—Ñ–µ—Ä—ã –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ 4-–≥–æ —É—Ä–æ–≤–Ω—è?

```sql
SELECT ot1.name AS name_1, ot2.name as name_2, ot3.name as name_3, ot4.id as id
    FROM offer_trade ot4
    INNER JOIN offer_trade ot3 ON ot4.order_tree <@ ot3.order_tree AND nlevel(ot3.order_tree) = 3
    INNER JOIN offer_trade ot2 ON ot4.order_tree <@ ot2.order_tree AND nlevel(ot2.order_tree) = 2
    INNER JOIN offer_trade ot1 ON ot4.order_tree <@ ot1.order_tree AND nlevel(ot1.order_tree) = 1
```

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤

#### –ö–∞–∫ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –Ω–∞ –ø–ª–∞–Ω –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞ (EXPLAIN) –≤ –Ω–∞–≥–ª—è–¥–Ω–æ–º –≥—Ä–∞—Ñ–∏—á–µ—Å–∫–æ–º –≤–∏–¥–µ?

1. [–ß–µ–ª–æ–≤–µ–∫–æ–ø–æ–Ω—è—Ç–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ EXPLAIN –∏ —Å–æ–≤–µ—Ç—ã](https://explain.tensor.ru/)
1. [Postgres Explain Visualizer (Pev)](http://tatiyants.com/pev/) is a tool I wrote to make EXPLAIN output easier to grok. It creates a graphical representation of the query plan
1. [PostgreSQL's explain analyze made readable](https://explain.depesz.com/)

#### –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤—ã–≤–æ–¥ EXPLAIN –∑–∞–ø—Ä–æ—Å–∞ –≤ –¥—Ä—É–≥–æ–º –∑–∞–ø—Ä–æ—Å–µ?

–°–º–æ—Ç—Ä–∏ [`explain_json.sql`](functions/explain_json.sql)

#### –ö–∞–∫ —É—Å–∫–æ—Ä–∏—Ç—å SELECT –∑–∞–ø—Ä–æ—Å—ã c —Ç—ã—Å—è—á–∞–º–∏ –∑–Ω–∞—á–µ–Ω–∏–π –≤ IN(...)?

[–ò—Å—Ç–æ—á–Ω–∏–∫](http://highload.guide/blog/query_performance_postgreSQL.html)

–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –∑–Ω–∞—á–µ–Ω–∏–π –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é —É–≤–µ–ª–∏—á–∏—Ç —á–∏—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—å –∫–æ–¥–∞ (TODO: –∫–∞–∫ —ç—Ç–æ –ø–æ–≤–ª–∏—è–µ—Ç –Ω–∞ —Å–∫–æ—Ä–æ—Å—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞?).

```sql
-- –±—ã–ª–æ
SELECT * FROM t WHERE id < 1000 AND val IN (1, ..., 10000);

-- —Å—Ç–∞–ª–æ (—Å–ø–æ—Å–æ–± 1)
SELECT * FROM t WHERE id < 1000 AND val IN (VALUES (1), ..., (10000));

-- —Å—Ç–∞–ª–æ (—Å–ø–æ—Å–æ–± 2)
SELECT * FROM t JOIN (VALUES (1), ..., (10000)) AS t(val) UGING(val) WHERE id < 1000;

-- —Å—Ç–∞–ª–æ (—Å–ø–æ—Å–æ–± 3)
SELECT * FROM t JOIN UNNEST(ARRAY[1, ..., 10000]) AS t(val) UGING(val) WHERE id < 1000;

```

#### –ö–∞–∫ —É—Å–∫–æ—Ä–∏—Ç—å SELECT –∑–∞–ø—Ä–æ—Å –ø–æ—Å–ª–µ –ø–µ—Ä–µ–µ–∑–¥–∞ —Å PostgreSQL v10 –Ω–∞ v12?


```sql
-- –∏—Å—Ö–æ–¥–Ω—ã–π –º–µ–¥–ª–µ–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å
SELECT id
FROM t1
WHERE id NOT IN (
    SELECT DISTINCT t2.entity_id FROM t2 WHERE ...
);

-- –∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ MATERIALIZED –¥–æ–±–∞–≤–ª–µ–Ω–æ —Ç–æ–ª—å–∫–æ –≤ PostgreSQL 12, –∞ —É –Ω–∞—Å –ø–æ–∫–∞ 10, –ø–æ—ç—Ç–æ–º—É —Å–º. —Å–ª–µ–¥—É—é—â–∏–π –∑–∞–ø—Ä–æ—Å
WITH t AS MATERIALIZED (
    SELECT DISTINCT t2.entity_id FROM t2 WHERE ...
)
SELECT id
FROM t1
WHERE id NOT IN (SELECT entity_id FROM t);

-- –∏—Å–ø–æ–ª—å–∑—É–µ–º –º–∞—Å—Å–∏–≤ –≤–º–µ—Å—Ç–æ –∫–æ–ª–æ–Ω–∫–∏
SELECT id
FROM t1
WHERE id != ALL(ARRAY( --performance workaround for PostgreSQL 12
    SELECT DISTINCT t2.entity_id FROM t2 WHERE ...
));
```

#### –ö–∞–∫ —É—Å–∫–æ—Ä–∏—Ç—å SELECT COUNT(\*) –∑–∞–ø—Ä–æ—Å?


–°—Ü–µ–Ω–∞—Ä–∏–π –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è: SQL –∑–∞–ø—Ä–æ—Å, –≤—ã—á–∏—Å–ª—è—é—â–∏–π –∫–æ–ª-–≤–æ –∑–∞–ø–∏—Å–µ–π –ø–æ —É—Å–ª–æ–≤–∏—é –∏–ª–∏ —Å—Ä–µ–¥–Ω–µ–µ —á–∏—Å–ª–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ.

–û–±—ä—ë–º –¥–∞–Ω–Ω—ã—Ö —Ä–∞—Å—Ç—ë—Ç, –∞ –æ—Ç–≤–µ—Ç –∫–ª–∏–µ–Ω—Ç—É –≤—Å–µ–≥–¥–∞ –Ω—É–∂–Ω–æ –æ—Ç–¥–∞–≤–∞—Ç—å –æ—á–µ–Ω—å –±—ã—Å—Ç—Ä–æ.
–ï—Å–ª–∏ SQL –∑–∞–ø—Ä–æ—Å –æ–ø—Ç–∏–º–∏–∑–∏—Ü–∏–∏ —É–∂–µ –Ω–µ –ø–æ–¥–¥–∞—ë—Ç—Å—è –∏–ª–∏ –æ—á–µ–Ω—å –º–Ω–æ–≥–æ –¥–∞–Ω–Ω—ã—Ö, —Ç–æ –µ–≥–æ –º–æ–∂–Ω–æ —É—Å–∫–æ—Ä–∏—Ç—å —á–µ—Ä–µ–∑ –ø—Ä–∏–±–ª–∏–∂—ë–Ω–Ω—ã–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è.
–í —Ç–∞–∫–æ–º –∑–∞–ø—Ä–æ—Å–µ –±—É–¥–µ—Ç –ø–æ–≥—Ä–µ—à–Ω–æ—Å—Ç—å –≤—ã—á–∏—Å–ª–µ–Ω–∏–π. –ß–µ–º –±—ã—Å—Ç—Ä–µ–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ, —Ç–µ–º –±–æ–ª—å—à–µ –ø–æ–≥—Ä–µ—à–Ω–æ—Å—Ç—å.
–ù–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞—Ö `> 1,000` —É–∂–µ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–∏–±–ª–∏–∂—ë–Ω–Ω—ã–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –¥–ª—è –∑–∞–¥–∞—á, —Ç—Ä–µ–±—É—é—â–∏—Ö –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ (–∑–∞–¥–∞—á–∏ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏).
`1,000` –∏–ª–∏ `1,050` - –Ω–µ —Ç–∞–∫ –≤–∞–∂–Ω–æ. –ü—Ä–∏ —Ç–∞–∫–∏—Ö –∑–Ω–∞—á–µ–Ω–∏—è—Ö —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Ü–µ–Ω–∫–∏ –∏ –ø—Ä–∏–Ω—è—Ç–∏—è —Ä–µ—à–µ–Ω–∏—è.
–ê –≤ GUI –ø–µ—Ä–µ–¥ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏, –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏, –∑–Ω–∞—á–µ–Ω–∏–µ –º–æ–∂–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ç–∞–∫: `1,000+` –∏–ª–∏ `‚âà1,050` –∏–ª–∏ `1 —Ç—ã—Å.`.

##### –†–µ—à–µ–Ω–∏–µ 1

```sql
create schema if not exists test;

drop table if exists test.count_approximate;

create table if not exists test.count_approximate as
select md5(i::text) as s from generate_series(1, 10000000) as t(i);

create unique index on test.count_approximate (i);

select count(*)
from (
    select
    from test.count_approximate
    where s ~ 'aa$'
    LIMIT 1000 + 1
) t;
--1 row retrieved starting from 1 in 273 ms (execution: 218 ms, fetching: 55 ms)

-- –µ—Å–ª–∏ –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∑–∞–ø—Ä–æ—Å –≤–µ—Ä–Ω—É–ª <= 1000 –∑–∞–ø–∏—Å–µ–π, —Ç–æ –±–æ–ª—å—à–µ –Ω–∏—á–µ–≥–æ –¥–µ–ª–∞—Ç—å –Ω–µ –Ω—É–∂–Ω–æ
-- –∏–Ω–∞—á–µ —Å—á–∏—Ç–∞–µ–º –ø—Ä–∏–±–ª–∏–∂—ë–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏–µ–π

select count(*) * 100 --39200
from test.count_approximate tablesample bernoulli(1) repeatable (37)
where s ~ 'aa$';
--1 row retrieved starting from 1 in 528 ms (execution: 489 ms, fetching: 39 ms)

select count(*) * 100 --42500
from test.count_approximate tablesample system(1) repeatable (37)
where s ~ 'aa$';
--1 row retrieved starting from 1 in 139 ms (execution: 100 ms, fetching: 39 ms)

-- PostgreSQL < 9.5 ?
select (count(*) filter (where  s ~ 'aa$')) * 100 --38300
from test.count_approximate
where (i % 100) = 0;
--1 row retrieved starting from 1 in 1 s 790 ms (execution: 1 s 767 ms, fetching: 23 ms)

-- –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è, –ø–æ–¥—Å—á—ë—Ç —Ç–æ—á–Ω–æ–≥–æ –∫–æ–ª-–≤–∞ –∑–∞–ø–∏—Å–µ–π —Ä–∞–±–æ—Ç–∞–µ—Ç –º–µ–¥–ª–µ–Ω–Ω–æ:
select count(*) --38823
from test.count_approximate
where s ~ 'aa$';
--1 row retrieved starting from 1 in 6 s 941 ms (execution: 6 s 899 ms, fetching: 42 ms)

```
–°–º. [Tablesample In PostgreSQL](https://www.2ndquadrant.com/en/blog/tablesample-in-postgresql-9-5-2/)

##### –†–µ—à–µ–Ω–∏–µ 2

PostgreSQL [extension](https://github.com/citusdata/postgresql-hll) adding HyperLogLog data structures as a native data type.

#### –ö–∞–∫ –≤—ã–ø–æ–ª–Ω–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é N —Ç—ã—Å—è—á —Ä–∞–∑ –∏ –∏–∑–º–µ—Ä–∏—Ç—å —Å–∫–æ—Ä–æ—Å—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è?

–ê–Ω–∞–ª–æ–≥ —Ñ—É–Ω–∫—Ü–∏–∏ `benchmark()` –≤ MySQL.
–°–º–æ—Ç—Ä–∏ [`benchmark.sql`](functions/benchmark.sql)


### –ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å –∑–∞–ø–∏—Å–∏-–¥—É–±–ª–∏–∫–∞—Ç—ã –ø–æ –∑–Ω–∞—á–µ–Ω–∏—é –ø–æ–ª–µ–π?

```sql
-- —á–µ—Ä–µ–∑ –ø–æ–¥–∑–∞–ø—Ä–æ—Å —Å EXISTS —ç—Ç–æ–π –∂–µ —Ç–∞–±–ª–∏—Ü—ã
SELECT
    ROW_NUMBER() OVER w AS duplicate_num, -- –Ω–æ–º–µ—Ä –¥—É–±–ª—è
    *
FROM person AS d
WHERE EXISTS(SELECT
             FROM person AS t
             WHERE t.name = d.name -- –≤ –∏–¥–µ–∞–ª–µ –Ω–∞ —ç—Ç–æ –ø–æ–ª–µ –¥–æ–ª–∂–µ–Ω —Å—Ç–æ—è—Ç—å –∏–Ω–¥–µ–∫—Å
                   -- –µ—Å–ª–∏ –Ω–µ—Ç –ø–µ—Ä–≤–∏—á–Ω–æ–≥–æ –∫–ª—é—á–∞, –∑–∞–º–µ–Ω–∏—Ç–µ "id" –Ω–∞ "ctid"
                   AND d.id != t.id -- –æ—Ä–∏–≥–∏–Ω–∞–ª –∏ –¥—É–±–ª–∏–∫–∞—Ç—ã
                   -- AND d.id > t.id -- —Ç–æ–ª—å–∫–æ –¥—É–±–ª–∏–∫–∞—Ç—ã
            )
WINDOW w AS (PARTITION BY name ORDER BY id)
ORDER BY name, duplicate_num
```

```sql
-- –ø–æ–ª—É—á–∏—Ç—å ID –∑–∞–ø–∏—Å–µ–π, –∏–º–µ—é—â–∏—Ö –¥—É–±–ª–∏–∫–∞—Ç—ã –ø–æ –ø–æ–ª—é lower(name)
SELECT id_original, unnest(id_doubles) AS id_double
FROM (
    SELECT min(id) AS id_original,
           (array_agg(id order by id))[2:] AS id_doubles
    FROM skill
    GROUP BY lower(name)
    HAVING count(*) > 1
    ORDER BY count(*) DESC
) AS t;
```

```sql
-- –ø–æ–ª—É—á–∏—Ç—å ID –∑–∞–ø–∏—Å–µ–π, –ù–ï –∏–º–µ—é—â–∏—Ö –¥—É–±–ª–∏–∫–∞—Ç—ã –ø–æ –ø–æ–ª—é slugify(name)
SELECT max(id) AS id
FROM region
GROUP BY slugify(name)
HAVING count(*) = 1;
```

```sql
-- –ø–æ–ª—É—á–∏—Ç—å —Ä–∞–∑–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è –Ω–∞—Å–µ–ª—ë–Ω–Ω—ã—Ö –ø—É–Ω–∫—Ç–æ–≤ —Å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º–∏ kladr_id
SELECT ROW_NUMBER() OVER(PARTITION BY kladr_id ORDER BY address ASC) AS duplicate_num, -- –Ω–æ–º–µ—Ä –¥—É–±–ª—è
       *
FROM (
    SELECT kladr_id,
           unnest(array_agg(address)) AS address
    FROM d
    GROUP BY kladr_id
    HAVING count(*) > 1
) AS t
ORDER BY kladr_id, duplicate_num
```

### –ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞ –≤ –µ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ?

```sql
SELECT extract(seconds FROM clock_timestamp() - now()) AS execution_duration FROM pg_sleep(1.5);
```
–≠—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç, –ø–æ—Ç–æ–º—É —á—Ç–æ `now()` –≤—ã—á–∏—Å–ª–∏—Ç—Å—è –µ—â—ë –Ω–∞ —ç—Ç–∞–ø–µ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞, –∞ `clock_timestamp()` –Ω–∞ —ç—Ç–∞–ø–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è.

### –ö–∞–∫ —Ä–∞–∑–±–∏—Ç—å –±–æ–ª—å—à—É—é —Ç–∞–±–ª–∏—Ü—É –ø–æ N —Ç—ã—Å—è—á –∑–∞–ø–∏—Å–µ–π?

–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ: –≤—ã–≥—Ä—É–∑–∫–∞ –∏–∑ –ë–î –±–æ–ª—å—à–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏–º–µ—Ä–Ω–æ –æ–¥–Ω–æ–≥–æ –æ–±—ä—ë–º–∞ –≤ –∫–∞–∂–¥–æ–π –ø–∞—á–∫–µ. –ù–∞–ø—Ä–∏–º–µ—Ä, –∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ –ø–æ–∏—Å–∫–æ–≤—ã—Ö –¥–≤–∏–∂–∫–∞—Ö —Ç–∏–ø–∞ [Manticore](https://manticoresearch.com/), [Sphinx](http://sphinxsearch.com/), [Solr](https://solr.apache.org/), [Elastic Search](https://www.elastic.co/) –∏ [–¥—Ä—É–≥–∏—Ö](https://typesense.org/typesense-vs-algolia-vs-elasticsearch-vs-meilisearch/). –ò–ª–∏ –≤—ã–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ [DWH](https://en.wikipedia.org/wiki/Data_warehouse).

**–í–∞—Ä–∏–∞–Ω—Ç 1**

–°–ø–æ—Å–æ–±, –∫–æ–≥–¥–∞ –Ω–µ –Ω—É–∂–Ω–æ –∑–∞—Ä–∞–Ω–µ–µ –≤—ã—á–∏—Å–ª—è—Ç—å –¥–∏–∞–ø–∞–∑–æ–Ω—ã id.

```sql
SELECT *
FROM resume
WHERE is_publish_status = TRUE
  AND is_spam = FALSE
  AND id > :id
  --AND use_parallel(id, :core_num, :core_max) -- –µ—Å–ª–∏ –Ω—É–∂–Ω–æ —Ä–∞—Å–ø–∞—Ä–∞–ª–ª–µ–ª–∏—Ç—å –∑–∞–ø—Ä–æ—Å –ø–æ —è–¥—Ä–∞–º –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞
ORDER BY id
LIMIT 10000
```

–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ —É—Å–ª–æ–≤–∏–µ ‚Äî –¥–ª—è –∫–æ–ª–æ–Ω–∫–∏ id –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–µ—Ä–≤–∏—á–Ω—ã–π –∏–ª–∏ —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å –∏ –æ–Ω –¥–æ–ª–∂–µ–Ω –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –≤ –ø–ª–∞–Ω–µ –∑–∞–ø—Ä–æ—Å–∞. –ó–Ω–∞—á–µ–Ω–∏—è id –º–æ–≥—É—Ç –±—ã—Ç—å —á–∏—Å–ª–æ–≤—ã–º–∏ –∏–ª–∏ —Ç–µ–∫—Å—Ç–æ–≤—ã–º–∏. –ó–∞–ø—Ä–æ—Å –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –≤ –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–º —Ü–∏–∫–ª–µ. –ù–∞ –ø–µ—Ä–≤–æ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏ –¥–ª—è —á–∏—Å–ª–æ–≤–æ–≥–æ —Ç–∏–ø–∞ –≤–º–µ—Å—Ç–æ `:id` –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ–º `0` (–∏–ª–∏ –¥—Ä—É–≥–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ, –º–µ–Ω—å—à–µ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ –≤ —Ç–∞–±–ª–∏—Ü–µ); –¥–ª—è —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —Ç–∏–ø–∞ –≤–º–µ—Å—Ç–æ `:id` –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ–º –ø—É—Å—Ç–æ–µ –∑–∞—á–µ–Ω–∏–µ (`''`). –ù–∞ –≤—Ç–æ—Ä–æ–π –∏ –ø–æ—Å–ª–µ–¥—É—é—â–∏—Ö –∏—Ç–µ—Ä–∞—Ü–∏—è—Ö –≤–º–µ—Å—Ç–æ `:id` –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ–º id –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–µ–π –∑–∞–ø–∏—Å–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –∑–∞–ø—Ä–æ—Å–∞ (—ç—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –±—É–¥–µ—Ç —è–≤–ª—è—Ç—å—Å—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º –≤ —Ä–∞–º–∫–∞—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –∑–∞–ø—Ä–æ—Å–∞). –ù–∞ –∫–∞–∂–¥–æ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏ —Ü–∏–∫–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º: –µ—Å–ª–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–æ–∑–≤—Ä–∞—â—ë–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π –º–µ–Ω—å—à–µ, —á–µ–º —É–∫–∞–∑–∞–Ω–æ –≤ LIMIT, —Ç–æ —Ü–∏–∫–ª –ø—Ä–µ—Ä—ã–≤–∞–µ–º. –î–ª—è —Ä–∞—Å–ø–∞—Ä–∞–ª–ª–µ–ª–∏–≤–∞–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é [`use_parallel.sql`](functions/use_parallel.sql).

**–í–∞—Ä–∏–∞–Ω—Ç 2a**

–°–ø–æ—Å–æ–±, –∫–æ–≥–¥–∞ –Ω—É–∂–Ω–æ –∑–∞—Ä–∞–Ω–µ–µ –≤—ã—á–∏—Å–ª—è—Ç—å –¥–∏–∞–ø–∞–∑–æ–Ω—ã id. –≠—Ç–æ—Ç —Å–ø–æ—Å–æ–± —Ä–∞–±–æ—Ç–∞–µ—Ç –º–µ–¥–ª–µ–Ω–Ω–µ–µ –∏ –≤—ã–≥–ª—è–¥–∏—Ç —Å–ª–æ–∂–Ω–µ–µ. –ù–æ –º–æ–∂–µ—Ç –ø–æ–¥–æ–π—Ç–∏, –µ—Å–ª–∏ –ø–æ –∫–∞–∫–∏–º-—Ç–æ –ø—Ä–∏—á–∏–Ω–∞–º –ø–µ—Ä–≤—ã–π –≤–∞—Ä–∏–∞–Ω—Ç –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∫–æ–≥–¥–∞ –ø–ª–∞–Ω –∑–∞–ø—Ä–æ—Å–∞ —É–ø–æ—Ä–Ω–æ –Ω–µ —Ö–æ—á–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–µ—Ä–≤–∏—á–Ω—ã–π –∏–ª–∏ —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å –ø–æ –∫–æ–ª–æ–Ω–∫–µ id).

```sql
WITH
-- –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤—ã–≤–∞–µ–º –ª–∏—à–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –∏ –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –∫–æ–ª–æ–Ω–∫—É id
result1 AS (
    SELECT id
    FROM resume
    WHERE is_publish_status = TRUE
      AND is_spam = FALSE
),
-- –¥–ª—è –∫–∞–∂–¥–æ–≥–æ id –ø–æ–ª—É—á–∞–µ–º –Ω–æ–º–µ—Ä –ø–∞—á–∫–∏
result2 AS (
    SELECT
       id,
       ((row_number() OVER (ORDER BY id) - 1) / 100000)::integer AS part
    FROM result1
)
-- –≥—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –Ω–æ–º–µ—Ä—É –ø–∞—á–∫–∏ –∏ –ø–æ–ª—É—á–∞–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ id
SELECT
    MIN(id) AS min_id,
    MAX(id) AS max_id,
    -- ARRAY_AGG(id) AS ids, -- —Å–ø–∏—Å–æ–∫ id –≤ –ø–∞—á–∫–µ, –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
    COUNT(id) AS total -- –∫–æ–ª-–≤–æ –∑–∞–ø–∏—Å–µ–π –≤ –ø–∞—á–∫–µ (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏, –º–æ–∂–Ω–æ –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —ç—Ç—É —Å—Ç—Ä–æ–∫—É)
FROM result2
GROUP BY part
ORDER BY 1;
```

–ü—Ä–∏–º–µ—Ä —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

‚Ññ | min_id | max_id | total
--:|--:|--:|--:
1 | 162655 | 6594323 | 100000 
2 | 6594329 | 6974938 | 100000 
3 | 6974949 | 7332884 | 100000 
... |  ... | ... | ... 
83 | 24276878 | 24427703 | 100000 
84 | 24427705 | 24542589 | 77587 

–î–∞–ª–µ–µ –º–æ–∂–Ω–æ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ –∏–ª–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –≤—ã–ø–æ–ª–Ω—è—Ç—å SQL –∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–∏–∞–ø–∞–∑–æ–Ω–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä:

```sql
SELECT *
FROM resume
WHERE id BETWEEN 162655 AND 6594323
  AND is_publish_status = TRUE
  AND is_spam = FALSE;
```

**–í–∞—Ä–∏–∞–Ω—Ç 2b**

–ï—Å–ª–∏ —É—Å–ª–æ–≤–∏–µ –≤ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –æ—á–µ–Ω—å —Ç—è–∂—ë–ª–æ–µ, —Ç–æ –ª—É—á—à–µ –≤—ã–±–∏—Ä–∞—Ç—å –ø–æ —Å–ø–∏—Å–∫–∞–º id –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–∏–∞–ø–∞–∑–æ–Ω–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä:

```sql

--–æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤—ã–≤–∞–µ–º –ª–∏—à–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –∏ –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –∫–æ–ª–æ–Ω–∫—É id, –¥–ª—è –∫–∞–∂–¥–æ–≥–æ id –ø–æ–ª—É—á–∞–µ–º –Ω–æ–º–µ—Ä –ø–∞—á–∫–∏
CREATE TABLE {table}_{JiraTaskId} AS
SELECT id,
       ((row_number() OVER (ORDER BY id) - 1) / 100000)::integer AS part
FROM company
WHERE is_check_moderator = TRUE
  AND is_spam = FALSE;

--—Å—Ç—Ä–æ–∏–º –∏–Ω–¥–µ–∫—Å –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è –≤—ã–±–æ—Ä–æ–∫ –≤ –ø–æ—Å–ª–µ–¥—É—é—â–∏—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö
CREATE UNIQUE INDEX {table}_{JiraTaskId}_uniq ON {table}_{JiraTaskId} (part, id);

--–¥–∞–ª–µ–µ –º–æ–∂–Ω–æ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ –∏–ª–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –≤—ã–ø–æ–ª–Ω—è—Ç—å SQL –∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–∏–∞–ø–∞–∑–æ–Ω–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä:
select *
from company as c
where id in (select id from {table}_{JiraTaskId} where part = 0)
```

### –ö–∞–∫ –≤—ã–ø–æ–ª–Ω–∏—Ç—å —Å–ª–µ–¥—É—é—â–∏–π SQL –∑–∞–ø—Ä–æ—Å, –µ—Å–ª–∏ –ø—Ä–µ–¥—ã–¥—É—â–∏–π –Ω–µ –≤–µ—Ä–Ω—É–ª —Ä–µ–∑—É–ª—å—Ç–∞—Ç?

```sql
-- how to execute a sql query only if another sql query has no results
WITH r AS (
  SELECT * FROM film WHERE length = 120
)
SELECT * FROM r
UNION ALL
SELECT * FROM film
WHERE length = 130
AND NOT EXISTS (SELECT * FROM r)
```

### –ö–∞–∫ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å –∑–∞–ø–∏—Å—å –≤ –Ω–∞–±–æ—Ä –∫–æ–ª–æ–Ω–æ–∫?

```sql
SELECT (a).*, (b).* -- unnesting the records again
FROM (
    SELECT
         a, -- nesting the first table as record
         b  -- nesting the second table as record
    FROM (VALUES (1, 'q'), (2, 'w')) AS a (id, name),
         (VALUES (7, 'e'), (8, 'r')) AS b (id, name)
) AS t;
```

### –ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å –∏—Ç–æ–≥–æ–≤—É—é —Å—É–º–º—É –∏ –ø—Ä–æ—Ü–µ–Ω—Ç –¥–ª—è –∫–∞–∂–¥–æ–π –∑–∞–ø–∏—Å–∏ –≤ –æ–¥–Ω–æ–º –∑–∞–ø—Ä–æ—Å–µ?

```sql
SELECT
   array_agg(x) over() as frame,
   x,
   sum(x) over() as total_sum,
   round(x * 100 / sum(x) over(), 2) as percent
FROM generate_series(1, 4) as t (x);
```

### –ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å –≤–æ–∑—Ä–∞—Å—Ç –ø–æ –¥–∞—Ç–µ —Ä–æ–∂–¥–µ–Ω–∏—è?

```sql
SELECT EXTRACT(YEAR FROM age('1977-09-10'::date))
```

### –ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å –¥–∞—Ç—É –∏–ª–∏ –¥–∞—Ç—É –∏ –≤—Ä–µ–º—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ ISO-8601?

```sql
-- format date or timestamp to ISO 8601
SELECT trim(both '"' from to_json(birthday)::text),
       trim(both '"' from to_json(created_at)::text)
FROM (
    SELECT '1977-10-09'::date AS birthday, now() AS created_at
) AS t
```

–ü—Ä–∏–º–µ—Ä —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:

birthday   | created_at
--         | --
1977-10-09 | 2019-10-24T13:34:38.858211+00:00


### –ö–∞–∫ –≤—ã—á–∏—Å–ª–∏—Ç—å –¥–∏—Å—Ç–∞–Ω—Ü–∏—é –º–µ–∂–¥—É 2-–º—è —Ç–æ—á–∫–∞–º–∏ –Ω–∞ –ó–µ–º–ª–µ –ø–æ –µ—ë –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏ –≤ –∫–∏–ª–æ–º–µ—Ç—Ä–∞—Ö?

–ï—Å–ª–∏ –µ—Å—Ç—å –º–æ–¥—É–ª—å [earthdistance](https://postgrespro.ru/docs/postgresql/10/earthdistance), —Ç–æ `(point(lon1, lat1) <@> point(lon2, lat2)) * 1.609344 AS distance_km`.
–ò–Ω–∞—á–µ `gc_dist(lat1, lon1, lat2, lon2) AS distance_km`, —Å–º–æ—Ç—Ä–∏ [`gc_dist.sql`](functions/gc_dist.sql)

```sql
-- select * from pg_available_extensions where installed_version is not null;

with t as (
    SELECT 37.61556 AS msk_x, 55.75222 AS msk_y, -- –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Ü–µ–Ω—Ç—Ä–∞ –ú–æ—Å–∫–≤—ã
           30.26417 AS spb_x, 59.89444 AS spb_y, -- –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Ü–µ–Ω—Ç—Ä–∞ –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥–∞
           1.609344 AS mile_to_kilometre_ratio
)
select (point(msk_x, msk_y) <@> point(spb_x, spb_y)) * mile_to_kilometre_ratio AS dist1_km,
       gc_dist(msk_y, msk_x, spb_y, spb_x) AS dist2_km
from t;
```
–ü—Ä–∏–º–µ—Ä —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:

dist1_km | dist2_km
--:       | --:
633.045646835722 | 633.0469500660282

### –ö–∞–∫ –Ω–∞–π—Ç–∏ –±–ª–∏–∂–∞–π—à–∏–µ –Ω–∞—Å–µ–ª—ë–Ω–Ω—ã–µ –ø—É–Ω–∫—Ç—ã –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∑–∞–¥–∞–Ω–Ω—ã—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç?

```sql
-- –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã (–¥–æ–ª–≥–æ—Ç—É, —à–∏—Ä–æ—Ç—É) –ª—É—á—à–µ —Å—Ä–∞–∑—É —Ö—Ä–∞–Ω–∏—Ç—å –Ω–µ –≤ 2-—Ö –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –ø–æ–ª—è—Ö, –∞ –≤ –æ–¥–Ω–æ–º –ø–æ–ª–µ —Å —Ç–∏–ø–æ–º point
create index region_point_idx on region using gist(point(map_center_x, map_center_y));

--explain
with t as (
    SELECT 37.61556 AS msk_x, 55.75222 AS msk_y, -- –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Ü–µ–Ω—Ç—Ä–∞ –ú–æ—Å–∫–≤—ã
           1.609344 AS mile_to_kilometre_ratio
)
select (point(msk_x, msk_y) <@> point(map_center_x, map_center_y)) * mile_to_kilometre_ratio AS dist_km,
       name
from region, t
order by (select point(msk_x, msk_y) from t) <-> point(map_center_x, map_center_y)
limit 10;
```

–°–º. —Ç–∞–∫ –∂–µ https://tapoueh.org/blog/2018/05/postgresql-data-types-point/

### –ö–∞–∫ –≤—ã—á–∏—Å–ª–∏—Ç—å –ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω—ã–π –æ–±—ä—ë–º –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ SELECT –∑–∞–ø—Ä–æ—Å–∞?

```sql
SELECT pg_size_pretty(SUM(OCTET_LENGTH(t::text) + 1))
FROM (
    -- —Å—é–¥–∞ –Ω—É–∂–Ω–æ –ø–æ–º–µ—Å—Ç–∏—Ç—å –≤–∞—à –∑–∞–ø—Ä–æ—Å, –Ω–∞–ø—Ä–∏–º–µ—Ä:
    SELECT * FROM region LIMIT 50000
) AS t
```

### –ü–æ—á–µ–º—É –∑–∞–ø—Ä–æ—Å —Å –ø–æ–¥–∑–∞–ø—Ä–æ—Å–æ–º –≤ NOT IN() –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 0 –∑–∞–ø–∏—Å–µ–π?

```sql
SELECT COUNT(*) FROM unnest(ARRAY[1,2,3,4,5,6]) as x(id) WHERE id IN (
    SELECT id FROM unnest(ARRAY[1,2,NULL]) as y(id)
); --2

SELECT COUNT(*) FROM unnest(ARRAY[1,2,3,4,5,6]) as x(id) WHERE id NOT IN (
    SELECT id FROM unnest(ARRAY[1,2,NULL]) as y(id)
); --0 !!!

SELECT COUNT(*) FROM unnest(ARRAY[1,2,3,4,5,6]) as x(id) WHERE id NOT IN (
    SELECT id FROM unnest(ARRAY[1,2,NULL]) as y(id) WHERE id IS NOT NULL
); --4

SELECT COUNT(*) FROM unnest(ARRAY[1,2,3,4,5,6]) as x(id) WHERE NOT EXISTS(
    SELECT FROM unnest(ARRAY[1,2,NULL]) as y(id) WHERE x.id = y.id
); --4
```

–í–º–µ—Å—Ç–æ `NOT IN(...)` –ª—É—á—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `NOT EXISTS(...)`

### –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è record –∏ NULL

Testing a ROW expression with IS NULL only reports TRUE if every single column is NULL.
–ù—É–∂–Ω–æ –æ–± —ç—Ç–æ–º –∑–Ω–∞—Ç—å, —á—Ç–æ–±—ã –Ω–∞ –Ω–∞–ø–æ—Ä–æ—Ç—å—Å—è –Ω–∞ –æ—à–∏–±–∫–∏ –≤ —Å–≤–æ—ë–º –∫–æ–¥–µ.

```sql
SELECT 
      (NULL, NULL) IS NULL as "(NULL, NULL) IS NULL", --true
      (NULL, NULL) IS NOT NULL as "(NULL, NULL) IS NOT NULL", --false
      NOT (NULL, NULL) IS NULL as "NOT (NULL, NULL) IS NULL", --false

      (1, NULL) IS NULL as "(1, NULL) IS NULL", --false
      (1, NULL) IS NOT NULL as "(1, NULL) IS NOT NULL", --false --!!!
      NOT (1, NULL) IS NULL as "NOT (1, NULL) IS NULL" --true --!!!
```

–°–º. —Ç–∞–∫ –∂–µ [NULL-–∑–Ω–∞—á–µ–Ω–∏—è –≤ PostgreSQL: –ø—Ä–∞–≤–∏–ª–∞ –∏ –∏—Å–∫–ª—é—á–µ–Ω–∏—è](https://habr.com/ru/companies/postgrespro/articles/697300/)

### –ö–∞–∫ –æ—á–µ–Ω—å –±—ã—Å—Ç—Ä–æ –ø–æ–ª—É—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –≤ –±–æ–ª—å—à–æ–π —Ç–∞–±–ª–∏—Ü–µ?

–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ: –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ–±—â–µ–≥–æ –∫–æ–ª-–≤–∞ –∑–∞–ø–∏—Å–µ–π –≤ –∞–¥–º–∏–Ω–∫–∞—Ö.

```sql
-- –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ—á–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π, –Ω–æ –º–µ–¥–ª–µ–Ω–Ω–æ
select count(*) as exact_count from table_name;

-- –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π, –Ω–æ –±—ã—Å—Ç—Ä–æ
-- —Ç–æ—á–Ω–æ—Å—Ç—å –±–æ–ª—å—à–µ, —á–µ–º –≤ —Å–ª–µ–¥—É—é—â–µ–º –∑–∞–ø—Ä–æ—Å–µ, –Ω–æ –æ—Ç –ë–î —Ç—Ä–µ–±—É–µ—Ç—Å—è –∞–∫—Ç—É–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ç–∞–±–ª–∏—Ü–µ
select reltuples::bigint as estimate_count
from pg_class
where  oid = 'public.table_name'::regclass;

-- –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π, –Ω–æ –±—ã—Å—Ç—Ä–æ
-- —Ç–æ—á–Ω–æ—Å—Ç—å –º–µ–Ω—å—à–µ, —á–µ–º –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–º –∑–∞–ø—Ä–æ—Å–µ, –Ω–æ –æ—Ç –ë–î –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è –∞–∫—Ç—É–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ç–∞–±–ª–∏—Ü–µ
-- –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ —ç—Ç–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞ –≤ —Ç–æ–º, —á—Ç–æ –º–æ–∂–Ω–æ –∑–∞–¥–∞–≤–∞—Ç—å —É—Å–ª–æ–≤–∏–µ –≤—ã–±–æ—Ä–∫–∏
select 100 * count(*) as estimate_count 
from table_name tablesample system (1)
where ...;
```

### –ö–∞–∫ —Å–¥–µ–ª–∞—Ç—å —Ä–µ–∫—É—Ä—Å–∏–≤–Ω—ã–π –∑–∞–ø—Ä–æ—Å?

–ü—Ä–∏–º–µ—Ä –Ω–∞ [–≥–∏–ø–æ—Ç–µ–∑–µ –ö–æ–ª–ª–∞—Ç—Ü–∞](https://ru.wikipedia.org/wiki/–ì–∏–ø–æ—Ç–µ–∑–∞_–ö–æ–ª–ª–∞—Ç—Ü–∞)

```sql
with recursive t (x) as (
    select 27 --–Ω–∞—á–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
    --select 989345275647
    union all
    select case x % 2 when 0 then x / 2 else 3 * x + 1 end
    from t
    where x > 1
)
select max(x), count(x)
from t
```

## –ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö (DML)

### –ö–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å –∏–ª–∏ –æ–±–Ω–æ–≤–∏—Ç—å –∑–∞–ø–∏—Å–∏ –æ–¥–Ω–∏–º –∑–∞–ø—Ä–æ—Å–æ–º (UPSERT)?

* –°–º. [INSERT ... ON CONFLICT DO NOTHING/UPDATE](https://habr.com/post/264281/) (Habr)
* –≠–ª–µ–≥–∞–Ω—Ç–Ω–∞—è [—Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞ PL/pgSQL](https://postgrespro.ru/docs/postgresql/12/plpgsql-control-structures#PLPGSQL-UPSERT-EXAMPLE) –∏–∑ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ PostgreSQL

### –ö–∞–∫ —Å–¥–µ–ª–∞—Ç—å `INSERT ... ON CONFLICT ...` –±–µ–∑ —É–≤–µ–ª–∏—á–µ–Ω–∏—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –¥–ª—è –¥—É–±–ª–∏–∫–∞—Ç–æ–≤?

```sql
drop table if exists t1;

--truncate t1;
--alter sequence t1_id_seq restart with 1;

create table t1 (
   id   integer      GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY, -- –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å t1_id_seq
   name varchar(255) NOT NULL UNIQUE
);
insert into t1 (name) values ('a'), ('b');
table t1_id_seq; -- "last_value" is 2

-- –ë–´–õ–û - –ø—Ä–∏ –¥—É–±–ª–∏–∫–∞—Ç–∞—Ö –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤—Å–µ–≥–¥–∞ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è,
-- –ø—Ä–∏ –∞–∫—Ç–∏–≤–Ω–æ–π –≤—Å—Ç–∞–≤–∫–µ –º–æ–∂–Ω–æ –¥–æ—Å—Ç–∏—á—å –µ—ë –ø—Ä–µ–¥–µ–ª–∞, –Ω–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ —Ç–∞–∫–æ–µ –±—ã–≤–∞–µ—Ç!

-- –∑–¥–µ—Å—å –±—É–¥–µ—Ç –æ—à–∏–±–∫–∞
insert into t1 (name) values ('c'), ('a');

table t1_id_seq; -- "last_value" is 4 (–∑—Ä—è —É–≤–µ–ª–∏—á–∏–ª–∏ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –Ω–∞ 2)

-- –∑–¥–µ—Å—å –æ—à–∏–±–∫–∏ –Ω–µ –±—É–¥–µ—Ç
insert into t1 (name) values ('c'), ('a') 
on conflict do nothing 
returning id;
-- 1 row affected

table t1_id_seq; -- "last_value" is 6 (–∑—Ä—è —É–≤–µ–ª–∏—á–∏–ª–∏ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –Ω–∞ 1)

-- –°–¢–ê–õ–û

insert into t1 as t (name)
select * from (values ('c'), ('a')) as v(name)
-- –ø—Ä–∏ –¥—É–±–ª–∏–∫–∞—Ç–∞—Ö –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∑—Ä—è –Ω–µ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è, –Ω–æ —Ç–æ–ª—å–∫–æ –≤ —Ç–æ–π –∂–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
where not exists (select from t1 as d where d.name = v.name)
-- –ø—Ä–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –≤–æ–∑–º–æ–∂–Ω–æ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏, –Ω–æ —ç—Ç–æ —É–∂–µ —Ä–µ–¥–∫–∞—è —Å–∏—Ç—É–∞—Ü–∏—è
on conflict do nothing
-- id –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π
returning id;
-- 1 row affected

table t1_id_seq; -- "last_value" is 3
```

### –ö–∞–∫ –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ç–∞–±–ª–∏—Ü–∞—Ö –∏ –≤–µ—Ä–Ω—É—Ç—å id –∑–∞—Ç—Ä–æ–Ω—É—Ç—ã—Ö –∑–∞–ø–∏—Å–µ–π –≤ –æ–¥–Ω–æ–º –∑–∞–ø—Ä–æ—Å–µ?

```sql
WITH
updated AS (
    UPDATE table1
    SET x = 5, y = 6 WHERE z > 7
    RETURNING id
),
inserted AS (
    INSERT INTO table2 (x, y, z) VALUES (5, 7, 10)
    RETURNING id
)
SELECT 'table1_updated' AS action, id
FROM updated
UNION ALL
SELECT 'table2_inserted' AS action, id
FROM inserted;
```

### –ö–∞–∫ –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü–∞—Ö –æ–¥–Ω–∏–º –∑–∞–ø—Ä–æ—Å–æ–º?

–ü—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Å—É—â–Ω–æ—Å—Ç–µ–π –≤–æ–∑–Ω–∏–∫–∞–µ—Ç –∑–∞–¥–∞—á–∞ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –Ω–µ —Ç–æ–ª—å–∫–æ –≤ –æ—Å–Ω–æ–≤–Ω—É—é —Ç–∞–±–ª–∏—Ü—É –ë–î, –Ω–æ –µ—â—ë –≤ —Å–≤—è–∑–∞–Ω–Ω—ã–µ. –í –∑–∞–ø—Ä–æ—Å–µ –Ω–∏–∂–µ "—Å—Ç–∞—Ä—ã–µ" —Å–≤—è–∑–∏ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã, "–Ω–æ–≤—ã–µ" ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω—ã, –∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –æ—Å—Ç–∞–Ω—É—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π. –°—á—ë—Ç—á–∏–∫–∏ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–µ–π –¥–ª—è –ø–æ–ª–µ–π-–∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤ (id) –∑—Ä—è –Ω–µ —É–≤–µ–ª–∏—á–∞—Ç—Å—è. –ü—Ä–∏–≤–µ–¥—ë–Ω –ø—Ä–∏–º–µ—Ä —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–≥–∏–æ–Ω–æ–≤ –≤–∞–∫–∞–Ω—Å–∏–∏.

```sql
WITH
    -- —É —Ç–∞–±–ª–∏—Ü—ã vacancy_region –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á vacancy_id+region_id
    -- —Å–Ω–∞—á–∞–ª–∞ —É–¥–∞–ª—è–µ–º –≤—Å–µ –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–µ (–Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ) —Ä–µ–≥–∏–æ–Ω—ã —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –¥–ª—è –≤–∞–∫–∞–Ω—Å–∏–∏
    -- –¥–ª—è ?l –≤ –∫–æ–Ω–µ—Ü –º–∞—Å—Å–∏–≤–∞ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤ —Ä–µ–≥–∏–æ–Ω–æ–≤ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å 0, —á—Ç–æ–±—ã –∑–∞–ø—Ä–æ—Å—ã –Ω–µ —Å–ª–æ–º–∞–ª–∏—Å—å
    deleted AS (
        DELETE FROM vacancy_region
        WHERE vacancy_id = ?0
        AND region_id NOT IN (?l1)
        -- AND ROW(region_id, some_field) NOT IN (ROW(3, 'a'), ROW(8, 'b'), ...) -- –ø—Ä–∏–º–µ—Ä –¥–ª—è —Å–ª—É—á–∞—è, –µ—Å–ª–∏ —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø–æ–ª–µ–π
        RETURNING id
    ),
    -- –ø–æ—Ç–æ–º –¥–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ —Ä–µ–≥–∏–æ–Ω—ã —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –¥–ª—è –≤–∞–∫–∞–Ω—Å–∏–∏
    -- –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ id —Ä–µ–≥–∏–æ–Ω–æ–≤ –∏ –¥—É–±–ª–∏–∫–∞—Ç—ã –±—É–¥—É—Ç –ø—Ä–æ–∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω—ã, –æ—à–∏–±–∫–∏ –Ω–µ –±—É–¥–µ—Ç
    -- select –Ω—É–∂–µ–Ω, —á—Ç–æ–±—ã –∑–∞–ø—Ä–æ—Å –Ω–µ —Å–ª–æ–º–∞–ª—Å—è –ø–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è–º –≤–Ω–µ—à–Ω–∏–π –∫–ª—é—á–µ–π, –µ—Å–ª–∏ –≤ —Å–ø–∏—Å–∫–µ region_id –µ—Å—Ç—å "–ª–µ–≤–∞–∫–∏", –æ–Ω–∏ –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç—Å—è
    inserted AS (
        INSERT INTO vacancy_region (vacancy_id, region_id)
        SELECT ?0 AS vacancy_id, id AS region_id FROM region WHERE id IN (?l1)
        ON CONFLICT DO NOTHING
        RETURNING id
    )
SELECT
    -- –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø—Ä–µ—á–∏—Å–ª–µ–Ω–∏—è –ø–æ–ª–µ–π –≤–∞–∂–Ω–∞: —Å–Ω–∞—á–∞–ª–∞ —É–¥–∞–ª–µ–Ω–∏–µ, –ø–æ—Ç–æ–º –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ, –∏–Ω–∞—á–µ –±—É–¥–µ—Ç –æ—à–∏–±–∫–∞
    (SELECT COUNT(*) FROM deleted) AS deleted, -- –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–¥–∞–ª—ë–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π
    (SELECT COUNT(*) FROM inserted) AS updated -- –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π
```

### –ö–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å —Å id, –∑–Ω–∞—á–µ–Ω–∏–µ –∫–æ—Ç–æ—Ä–æ–≥–æ –Ω—É–∂–Ω–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –µ—â—ë –≤ –¥—Ä—É–≥–æ–º –ø–æ–ª–µ –≤ —Ç–æ–º –∂–µ INSERT –∑–∞–ø—Ä–æ—Å–µ?

–ü–æ –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º [Stackoverflow: Reference value of serial column in another column during same INSERT](https://stackoverflow.com/questions/12433075/reference-value-of-serial-column-in-another-column-during-same-insert/12433285). –ê –≤–æ–æ–±—â–µ —ç—Ç–æ –æ—à–∏–±–∫–∞ –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–Ω–∞—Ä—É—à–µ–Ω–∏–µ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–π —Ñ–æ—Ä–º—ã)!

```sql
WITH t AS (
   SELECT nextval(pg_get_serial_sequence('region', 'id')) AS id
)
INSERT INTO region (id, ltree_path, ?r)
SELECT id,
       CAST(?s || '.' || id AS ltree) AS ltree_path,
       ?l
FROM t
RETURNING ltree_path
```

### –ö–∞–∫ —Å–¥–µ–ª–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥—É—é—â–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ —Å –ø–æ–ª—É—á–µ–Ω–Ω—ã–º –ø—Ä–∏ –≤—Å—Ç–∞–≤–∫–µ id –∏–∑ –ø–µ—Ä–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞?

```sql
DO $$
DECLARE t1Id integer;
BEGIN
  INSERT INTO t1 (a, b) VALUES ('a', 'b') RETURNING id INTO t1Id;
  INSERT INTO t2 (c, d, t1_id) VALUES ('c', 'd', t1Id);
END $$;
```

### –ö–∞–∫ –Ω–µ –æ–±–Ω–æ–≤–ª—è—Ç—å –∑–∞–ø–∏—Å—å, –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –∏–∑ UPDATE –∑–∞–ø—Ä–æ—Å–∞ –∏ –≤ –ë–î —Å–æ–≤–ø–∞–¥–∞—é—Ç?

–ó–∞–ø—Ä–æ—Å —Ç–∏–ø–∞ `UPDATE t SET id = 123 WHERE id = 123` –ø–æ —Å—É—Ç–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –æ–±–Ω–æ–≤–∏—Ç, –Ω–æ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏ –ë–î –≤—Å—ë —Ä–∞–≤–Ω–æ —É–¥–∞–ª–∏—Ç —Å—Ç–∞—Ä—É—é –≤–µ—Ä—Å–∏—é –∑–∞–ø–∏—Å–∏ –∏ —Å–æ–∑–¥–∞—Å—Ç –Ω–æ–≤—É—é. –ü—Ä–∏ —ç—Ç–æ–º –æ—Ç—Ä–∞–±–æ—Ç–∞—é—Ç –≤—Å–µ —Ç—Ä–∏–≥–≥–µ—Ä—ã (–µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å), –∞ –∑–∞–ø–∏—Å—å –Ω–∞ –≤—Ä–µ–º—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±—É–¥–µ—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞. –í —Å–ª—É—á–∞–µ –±–æ–ª—å—à–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã—Ö UPDATE –∑–∞–ø—Ä–æ—Å–æ–≤ –æ–Ω–∏ –º–æ–≥—É—Ç –≤—Å—Ç–∞—Ç—å –≤ –æ—á–µ—Ä–µ–¥—å. –°—Ç–∞—Ä—ã–µ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –≤–µ—Ä—Å–∏–∏ –∑–∞–ø–∏—Å–µ–π –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è –µ—â—ë —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –ë–î, –∏—Ö –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–æ —É–¥–∞–ª—è–µ—Ç –ø—Ä–æ—Ü–µ–¥—É—Ä–∞ –≤–∞–∫—É—É–º–∏–∑–∞—Ü–∏–∏. –í—Å—ë —ç—Ç–æ –ª–∏—à–Ω–µ–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–æ–≤, –∫–æ—Ç–æ—Ä–æ–≥–æ –º–æ–∂–Ω–æ –∏–∑–±–µ–∂–∞—Ç—å. –î–ª—è —ç—Ç–æ–≥–æ –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, –æ—Ç–ª–∏—á–∞—é—Ç—Å—è –ª–∏ –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ–ª–µ–π, —É–∫–∞–∑–∞–Ω–Ω—ã–µ –≤ UPDATE –∑–∞–ø—Ä–æ—Å–µ, —Å–æ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏, –∫–æ—Ç–æ—Ä—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –∑–∞–ø–∏—Å–∏ —Ç–∞–±–ª–∏—Ü—ã –ë–î.

```sql
WITH v (col1, col2) AS (
    SELECT 'text1',  'text2'
)
UPDATE t AS u
SET col1 = v.col1, col2 = v.col2
FROM v
WHERE u.id = 123
  AND (u.col1, u.col2) IS DISTINCT FROM (v.col1, v.col2);
```


### –ö–∞–∫ –æ–±–Ω–æ–≤–∏—Ç—å –∑–∞–ø–∏—Å—å —Ç–∞–∫, —á—Ç–æ–±—ã –Ω–µ –∑–∞—Ç–µ—Ä–µ—Ç—å —á—É–∂–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è, —É–∂–µ —Å–¥–µ–ª–∞–Ω–Ω—ã–µ –∫–µ–º-—Ç–æ?

–ü–æ–ª—É—á–∞–µ–º –∑–∞–ø–∏—Å—å –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤ GUI:
```sql
SELECT col1, col2, updated_at
--, md5(t::text) AS record_md5 -- –µ—Å–ª–∏ –Ω–µ—Ç –∫–æ–ª–æ–Ω–∫–∏ updated_at, –≤—ã—á–∏—Å–ª—è–µ–º —Ö–µ—à –æ—Ç –¥–∞–Ω–Ω—ã—Ö –≤—Å–µ–π –∑–∞–ø–∏—Å–∏
FROM t 
WHERE id = 123
```

–ü–æ—Å–ª–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤ GUI –æ–±–Ω–æ–≤–ª—è–µ–º –∑–∞–ø–∏—Å—å –≤ –ë–î:

```sql
UPDATE t
SET col1 = 'val1',  col2 = 'val2', ...
WHERE id = 123
AND updated_at = '2019-11-08 00:58:33' -- —Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Å–æ –∑–Ω–∞—á–µ–Ω–∏–µ–º –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ SELECT –∑–∞–ø—Ä–æ—Å–∞
--AND md5(t::text) = '1BC29B36F623BA82AAF6724FD3B16718' -- –µ—Å–ª–∏ –Ω–µ—Ç –∫–æ–ª–æ–Ω–∫–∏ updated_at, –≤—ã—á–∏—Å–ª—è–µ–º —Ö–µ—à –æ—Ç –¥–∞–Ω–Ω—ã—Ö –≤—Å–µ–π –∑–∞–ø–∏—Å–∏ –∏ —Å—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Å–æ –∑–Ω–∞—á–µ–Ω–∏–µ–º –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ SELECT –∑–∞–ø—Ä–æ—Å–∞
RETURNING *
```

–ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –≤–µ—Ä–Ω—É–ª —Ä–µ–∑—É–ª—å—Ç–∞—Ç (–æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É), –∑–Ω–∞—á–∏—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±—ã–ª–æ.
–ò–Ω–∞—á–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–µ –±—ã–ª–æ, –∑–Ω–∞—á–∏—Ç –∫—Ç–æ-—Ç–æ –æ–±–Ω–æ–≤–∏–ª –∑–∞–ø–∏—Å—å –≤ –ë–î —Ä–∞–Ω—å—à–µ.

### –ö–∞–∫ –æ–±–Ω–æ–≤–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –∑–∞–ø–∏—Å–µ–π —Ä–∞–∑–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –≤ –æ–¥–Ω–æ–º –∑–∞–ø—Ä–æ—Å–µ?

–°–º. [Stackoverflow](https://stackoverflow.com/questions/18797608/update-multiple-rows-in-same-query-using-postgresql)

```sql
UPDATE users AS u 
SET
  email = v.email,
  first_name = v.first_name,
  last_name = v.last_name
FROM (VALUES
  (1, 'hollis@weimann.biz', 'Hollis', 'O''Connell'),
  (2, 'robert@duncan.info', 'Robert', 'Duncan')
) as v(id, email, first_name, last_name)
WHERE u.id = v.id;
```

### –ö–∞–∫ –æ–±–Ω–æ–≤–∏—Ç—å –∏–ª–∏ —É–¥–∞–ª–∏—Ç—å –º–∏–ª–ª–∏–æ–Ω—ã –∑–∞–ø–∏—Å–µ–π –≤ —Ç–∞–±–ª–∏—Ü–µ –Ω–µ –±–ª–æ–∫–∏—Ä—É—è –≤—Å–µ –∑–∞–ø–∏—Å–∏ –∏ –Ω–µ –Ω–∞–≥—Ä—É–∂–∞—è –ë–î?

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä–æ—Ü–µ–¥—É—Ä—É [`loop_execute()`](procedures/loop_execute/) –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å—Ç—Ä–æ–∫ –≤ –±–æ–ª—å—à–∏—Ö —Ç–∞–±–ª–∏—Ü–∞—Ö (—Ç—ã—Å—è—á–∏ –∏ –º–∏–ª–ª–∏–æ–Ω—ã —Å—Ç—Ä–æ–∫) —Å –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º—ã–º –≤—Ä–µ–º–µ–Ω–µ–º –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —Å—Ç—Ä–æ–∫ –Ω–∞ –∑–∞–ø–∏—Å—å.
–ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã ‚Äî –≤—ã–ø–æ–ª–Ω—è–µ—Ç –≤ —Ü–∏–∫–ª–µ CTE DML –∑–∞–ø—Ä–æ—Å, –∫–æ—Ç–æ—Ä—ã–π –¥–æ–±–∞–≤–ª—è–µ—Ç, –æ–±–Ω–æ–≤–ª—è–µ—Ç –∏–ª–∏ —É–¥–∞–ª—è–µ—Ç –∑–∞–ø–∏—Å–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ.
–í –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –∫–∞–∂–¥–æ–≥–æ —Ü–∏–∫–ª–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ñ–∏–∫—Å–∏—Ä—É—é—Ç—Å—è (–ª–∏–±–æ –æ—Ç–∫–∞—Ç—ã–≤–∞—é—Ç—Å—è –¥–ª—è —Ü–µ–ª–µ–π —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è, —ç—Ç–æ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è).
–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∞–¥–∞–ø—Ç–∏—Ä—É–µ—Ç—Å—è –ø–æ–¥ –Ω–∞–≥—Ä—É–∑–∫—É –Ω–∞ –ë–î. –ù–∞ —Ä–µ–ø–ª–∏–∫—É –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ –Ω–µ–±–æ–ª—å—à–∏–º–∏ –ø–æ—Ä—Ü–∏—è–º–∏, –∞ –Ω–µ –æ–¥–Ω–∏–º –æ–≥—Ä–æ–º–Ω—ã–º –∫—É—Å–∫–æ–º.

–í –ø—Ä–æ—Ü–µ—Å—Å–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤ psql –∫–æ–Ω—Å–æ–ª–∏:
   * –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∏ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π –≤ —Ç–∞–±–ª–∏—Ü–µ
   * —Å–∫–æ–ª—å–∫–æ –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–æ—à–ª–æ, —Å–∫–æ–ª—å–∫–æ –ø—Ä–∏–º–µ—Ä–Ω–æ –≤—Ä–µ–º–µ–Ω–∏ –æ—Å—Ç–∞–ª–æ—Å—å –¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è, –ø—Ä–æ–≥—Ä–µ—Å—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö

–ü—Ä–æ–≥—Ä–µ—Å—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö –¥–ª—è —Ä–∞–±–æ—Ç–∞—é—â–µ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –µ—â—ë –≤ –∫–æ–ª–æ–Ω–∫–µ `pg_stat_activity.application_name`!

–ü—Ä–æ—Ü–µ–¥—É—Ä–∞ –Ω–µ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, —Ç.–∫. —Å–∞–º–∞ –¥–µ–ª–∞–µ—Ç –º–Ω–æ–≥–æ –º–∞–ª–µ–Ω—å–∫–∏—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π.

### –ö–∞–∫ —É–¥–∞–ª–∏—Ç—å –¥–µ—Å—è—Ç–∫–∏ —Ç—ã—Å—è—á –∑–∞–ø–∏—Å–µ–π –≤ —Ç–∞–±–ª–∏—Ü–µ –Ω–µ –±–ª–æ–∫–∏—Ä—É—è –≤—Å–µ –∑–∞–ø–∏—Å–∏ –∏ –Ω–µ –Ω–∞–≥—Ä—É–∂–∞—è –ë–î?

[–î–∞–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å](old/modify_thousands_rows/demo.sql) —Ö–æ—Ä–æ—à–æ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è:

1. –æ–±—Ä–∞–±–æ—Ç–∫–∏ –±–æ–ª—å—à–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∑–∞–ø–∏—Å–µ–π –≤ "–∞–¥–º–∏–Ω–∫–∞—Ö" (–ø—Ä–æ–≥—Ä–∞–º–º–∞ –∏–ª–∏ –≤–µ–±-—Å—Ç—Ä–∞–Ω–∏—Ü–∞ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è —á–µ–≥–æ-—Ç–æ)
1. –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –≤—ã–ø–æ–ª–Ω—è–µ–º—ã—Ö –∑–∞–¥–∞—á –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é
1. –Ω–µ–±–æ–ª—å—à–∏—Ö –º–∏–≥—Ä–∞—Ü–∏–π –ë–î

–û–Ω –±—É–¥–µ—Ç –±–µ—Ä–µ–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å, –¥–∞–∂–µ –µ—Å–ª–∏ –µ–≥–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤ –≤–µ–±-–∞–¥–º–∏–Ω–∫–µ –∏–∑ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –≤–∫–ª–∞–¥–æ–∫ –±—Ä–∞—É–∑–µ—Ä–∞ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ).

–í—ã–ø–æ–ª–Ω—è—Ç—å —ç—Ç–æ—Ç –∑–∞–ø—Ä–æ—Å –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤ —Ü–∏–∫–ª–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
–ò—Å—Ö–æ–¥–Ω—ã–π –ª–∏–º–∏—Ç `4096` (–ø–æ–¥–æ–±—Ä–∞–Ω –æ–ø—ã—Ç–Ω—ã–º –ø—É—Ç—ë–º).
–õ–∏–º–∏—Ç –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏ —Ü–∏–∫–ª–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ –ø–æ–ª–µ `next_limit`.
–ï—Å–ª–∏ `next_limit = 0`, —Ç–æ –ø—Ä–µ—Ä—ã–≤–∞–µ–º —Ü–∏–∫–ª.

### –ö–∞–∫ –¥–ª—è –æ–¥–Ω–æ–π —Å—É—â–Ω–æ—Å—Ç–∏ —Å–¥–µ–ª–∞—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –Ω–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—Å—Ç–∞–≤–ª—è–µ–º—ã—Ö –∑–∞–≤–∏—Å–∏–º—ã—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π?

–ù–∞–ø—Ä–∏–º–µ—Ä, –∫–∞–∫ –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞ –º–∞–∫—Å–∏–º—É–º N –∑–∞–∫–∞–∑–∞–º–∏?

–í–∑—è—Ç–æ –∏ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–æ –∏–∑ –¥–æ–∫–ª–∞–¥–∞ –ò–≤–∞–Ω–∞ –§—Ä–æ–ª–∫–æ–≤–∞ ([–ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è](https://pgconf.ru/2021/288643), [–≤–∏–¥–µ–æ](https://youtu.be/zJP6FsfAlhI?t=847))

```sql

-- –ø—Ä–µ–¥–ø–æ–ª–æ–∂–∏–º, –µ—Å—Ç—å 2 —Ç–∞–±–ª–∏—Ü—ã client(id int, ...) –∏ order(id, client_id, ...)

create or replace function trg_only_5() returns trigger as
$code$
begin
    if tg_op = 'DELETE' or (tg_op = 'UPDATE' and old.client_id = new.client_id) then
        return;  
    end if;  
    
    -- –≤–∞–∂–Ω—ã–π –º–æ–º–µ–Ω—Ç —Å –±–ª–æ–∫–∏—Ä–æ–≤–∫–æ–π –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π (–æ–Ω–∏ –≤—Å—Ç–∞—é—Ç –≤ –æ—á–µ—Ä–µ–¥—å):
    perform pg_advisory_xact_lock('order'::regclass::oid::int, new.client_id);
    --perform from client c where c.id = new.client_id for update;  -- –∏–ª–∏ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç —Å –±–ª–æ–∫–∏—Ä–æ–≤–∫–æ–π –∑–∞–ø–∏—Å–∏, –Ω–æ –±–æ–ª–µ–µ –º–µ–¥–ª–µ–Ω–Ω—ã–π, —Ç.–∫. –±–ª–∏–∫–∏—Ä—É–µ—Ç —Å—Ç—Ä–æ–∫—É –≤ —Ç–∞–±–ª–∏—Ü–µ –æ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è—Ö (–æ–Ω–∏ –≤—Å—Ç–∞—é—Ç –≤ –æ—á–µ—Ä–µ–¥—å)
    
    if (select count(*) from order o where o.client_id = new.client_id) > 5 then
        /*
        https://postgrespro.ru/docs/postgresql/14/errcodes-appendix - —ç—Ç–æ –∫–æ–¥—ã –æ—à–∏–±–æ–∫ –≤ –ë–î
        –ë–î —É–º–µ–µ—Ç –∫–∏–¥–∞—Ç—å –æ—à–∏–±–∫–∏ —Å –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–º–∏ –∫–æ–¥–∞–º–∏, –ø–æ—ç—Ç–æ–º—É –¥–ª—è 23U01 –ø–æ–ª—É—á–∞–µ—Ç—Å—è —Ç–∞–∫:
        23 - —ç—Ç–æ –∫–ª–∞—Å—Å, U - user defined, 01 - –ø–æ—Ä—è–¥–∫–æ–≤—ã–π –Ω–æ–º–µ—Ä
        –ü–æ–ª—å–∑–∞ —Ç–∞–∫–∏—Ö –∫–æ–¥–æ–≤ –æ—à–∏–±–æ–∫ –≤ —Ç–æ–º, —á—Ç–æ –ø–æ –Ω–∏–º –º–æ–∂–Ω–æ –±—ã—Å—Ç—Ä–æ –Ω–∞–π—Ç–∏ –ø—Ä–æ–±–ª–µ–º–Ω–æ–µ –º–µ—Å—Ç–æ –≤ –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ–º –∫–æ–¥–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
        */
        raise sqlstate '23U01' using message='Too many orders';  
    end if;  
    return new;
end
$code$
language plpgsql;

create trigger only5 before insert or update on order for each row execute procedure trg_only_5();
```

### –ö–∞–∫ —Å–¥–µ–ª–∞—Ç—å –∂—É—Ä–Ω–∞–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π —Ç–∞–±–ª–∏—Ü—ã?

–î–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞–ø–∏—Å–µ–π –≤ —Ç–∞–±–ª–∏—Ü–µ-–∂—É—Ä–Ω–∞–ª–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–æ–¥—Ö–æ–¥ —Å–æ —Å–ª–µ–¥—É—é—â–∏–º–∏ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞–º–∏:
* –î–∞–Ω–Ω—ã–µ –≤ —Ç–∞–±–ª–∏—Ü–µ-–∂—É—Ä–Ω–∞–ª–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –Ω–∞–≥–ª—è–¥–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ "–±—ã–ª–æ-—Å—Ç–∞–ª–æ"
* –ü—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –≤ –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ –≤ —Ç–∞–±–ª–∏—Ü—É-–∂—É—Ä–Ω–∞–ª –∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ —Å—Ç–∞—Ä—ã–µ –∏ –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ, –∑–Ω–∞—á–µ–Ω–∏—è –∫–æ—Ç–æ—Ä—ã—Ö –æ—Ç–ª–∏—á–∞—é—Ç—Å—è
* –ü—Ä–æ—Å—Ç–∞—è —Å—Ö–µ–º–∞ —Ç–∞–±–ª–∏—Ü—ã-–∂—É—Ä–Ω–∞–ª–∞, –ø—Ä–æ—Å—Ç–æ–π –∫–æ–¥ —Ç—Ä–∏–≥–≥–µ—Ä–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏, —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ç—Ä–∏–≥–≥–µ—Ä
* –°—Ö–µ–º—É –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã –º–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å –≤ –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç, –∂—É—Ä–Ω–∞–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ —Å–ª–æ–º–∞–µ—Ç—Å—è

```sql
drop table if exists test;
create table test (
    id integer generated always as identity primary key,
    t text,
    i integer
);

drop table if exists test_history;
create table test_history
(
    id           integer generated always as identity primary key,
    reference_id integer not null, -- –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Å–≤—è–∑–∞–Ω–Ω–æ–π —Å—É—â–Ω–æ—Å—Ç–∏, FK –±—ã—Ç—å –Ω–µ –¥–æ–ª–∂–Ω–æ, —Ç.–∫. –∑–∞–ø–∏—Å—å –º.–±. —É–¥–∞–ª–µ–Ω–∞
    created_at   timestamp(0) with time zone not null default now() check (created_at <= now() + interval '10m'),
    old_data     jsonb check(jsonb_typeof(old_data) = 'object'),
    new_data     jsonb check(jsonb_typeof(new_data) = 'object'),
    check (not (old_data is null and new_data is null))
);

create index on test_history (reference_id);
create index on test_history using brin (created_at);

comment on column test_history.id is 'ID';
comment on column test_history.reference_id is 'ID –≤ —Ç–∞–±–ª–∏—Ü–µ test (—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∏–ª–∏ —É–¥–∞–ª—ë–Ω–Ω—ã–π)';
comment on column test_history.created_at is '–î–∞—Ç–∞-–≤—Ä–µ–º—è –¥–µ–π—Å—Ç–≤–∏—è';
comment on column test_history.old_data is '–°—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ (–¥–ª—è INSERT –≤—Å–µ–≥–¥–∞ NULL)';
comment on column test_history.new_data is '–ù–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ (–¥–ª—è DELETE –≤—Å–µ–≥–¥–∞ NULL)';

CREATE OR REPLACE FUNCTION test_history_save() RETURNS TRIGGER
    LANGUAGE plpgsql
AS
$$
BEGIN
    IF TG_OP = 'INSERT' THEN
        INSERT INTO test_history (reference_id, new_data) VALUES (NEW.id, to_jsonb(NEW));
    ELSIF TG_OP = 'DELETE' THEN
        INSERT INTO test_history (reference_id, old_data) VALUES (OLD.id, to_jsonb(OLD));
    ELSIF TG_OP = 'UPDATE' AND OLD IS DISTINCT FROM NEW THEN
        INSERT INTO test_history (reference_id, old_data, new_data)
        select OLD.id,
               jsonb_object_agg(o.key, o.value) as old_data,
               jsonb_object_agg(n.key, n.value) as new_data
        from jsonb_each(to_jsonb(OLD)) as o,
             jsonb_each(to_jsonb(NEW)) as n
        where o.key = n.key and o.value is distinct from n.value;
    END IF;

    RETURN NULL;
END;
$$;

DROP TRIGGER IF EXISTS test_history_save ON test;
CREATE TRIGGER test_history_save
    AFTER INSERT OR UPDATE OR DELETE ON test
    FOR EACH ROW
EXECUTE FUNCTION test_history_save();

insert into test (t, i) values ('one', 1), ('two', 2);
update test set t = 'three', i = null where t = 'one';
delete from test where t = 'two';

select * from test;
select * from test_history;
```

–î–∞–Ω–Ω—ã–µ –≤ —Ç–∞–±–ª–∏—Ü–∞—Ö –ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è SQL –∫–æ–¥–∞:

**`test`**
| id | t | i |
| :--- | :--- | :--- |
| 1 | three | NULL |


**`test_history`**
| id | reference\_id | triggered\_at | old\_data | new\_data |
| :--- | :--- | :--- | :--- | :--- |
| 1 | 1 | 2022-03-29 17:29:58 +03:00 | NULL | {"i": 1, "t": "one", "id": 1} |
| 2 | 2 | 2022-03-29 17:29:58 +03:00 | NULL | {"i": 2, "t": "two", "id": 2} |
| 3 | 1 | 2022-03-29 17:29:58 +03:00 | {"i": 1, "t": "one"} | {"i": null, "t": "three"} |
| 4 | 2 | 2022-03-29 17:29:58 +03:00 | {"i": 2, "t": "two", "id": 2} | NULL |

**–ó–∞–º–µ—á–∞–Ω–∏–µ**. 
–î–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —ç—Ç–æ–≥–æ —Ç–∏–ø–∞ –∂—É—Ä–Ω–∞–ª–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–ª–æ–Ω–∫–∏ —Å —Ç–∏–ø–æ–º `json` –Ω—É–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ –∫–æ–ª–æ–Ω–∫–∏ —Å —Ç–∏–ø–æ–º `jsonb`, 
–ø–æ—Ç–æ–º—É —á—Ç–æ –¥–ª—è 2-—Ö `json` –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä —Å—Ä–∞–≤–Ω–µ–Ω–∏—è (`=`, `!=`) 
–∏ –ª–æ–º–∞–µ—Ç—Å—è —Ç—Ä–∏–≥–≥–µ—Ä –Ω–∞ —Å–æ–±—ã—Ç–∏–µ `BEFORE UPDATE` —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π `NEW IS DISTINCT FROM OLD`, –∞ `UPDATE` –∑–∞–ø—Ä–æ—Å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—à–∏–±–∫—É: 
`[42883] ERROR: could not identify an equality operator for type json. Where: PL/pgSQL function updated_at_set_now() line 4 at IF`

### –ö–∞–∫ —Å–¥–µ–ª–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ–º–æ–µ –ø–æ–ª–µ `updated_at`?

–ß—Ç–æ–±—ã –≤ –ø–æ–ª–µ `updated_at` —Ö—Ä–∞–Ω–∏–ª–∞—Å—å –Ω–∞—Å—Ç–æ—è—â–∞—è –¥–∞—Ç–∞-–≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç—Ä–æ–∫–∏, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Ç–æ–≥–æ, –∫–∞–∫–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø—Ä–∏—à–ª–æ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞:

```sql
CREATE OR REPLACE FUNCTION updated_at_set_now() RETURNS TRIGGER LANGUAGE plpgsql AS
$$
BEGIN
    -- –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –≤ —Å–ª—É—á–∞–µ –Ω–∞—Å—Ç–æ—è—â–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –¥–∞–Ω–Ω—ã—Ö
    -- –í–ù–ò–ú–ê–ù–ò–ï! –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –≤–µ—Ä–Ω—ë—Ç –æ—à–∏–±–∫—É, –µ—Å–ª–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ –∏–º–µ–µ—Ç—Å—è –∫–æ–ª–æ–Ω–∫–∞ —Å —Ç–∏–ø–æ–º JSON (–æ–Ω –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä —Å—Ä–∞–≤–Ω–µ–Ω–∏—è)
    IF (TG_OP = 'INSERT' OR NEW IS DISTINCT FROM OLD) THEN
        NEW.updated_at = transaction_timestamp(); --–¢–µ–∫—É—â–∞—è –¥–∞—Ç–∞ –∏ –≤—Ä–µ–º—è (–Ω–∞ –º–æ–º–µ–Ω—Ç –Ω–∞—á–∞–ª–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏) = now()
        --NEW.updated_at = statement_timestamp(); --–¢–µ–∫—É—â–∞—è –¥–∞—Ç–∞ –∏ –≤—Ä–µ–º—è (–Ω–∞ –º–æ–º–µ–Ω—Ç –Ω–∞—á–∞–ª–∞ —Ç–µ–∫—É—â–µ–≥–æ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞)
        --NEW.updated_at = clock_timestamp(); --–¢–µ–∫—É—â–∞—è –¥–∞—Ç–∞ –∏ –≤—Ä–µ–º—è (–º–µ–Ω—è–µ—Ç—Å—è –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤)
    END IF;
    RETURN NEW;
END;
$$;
 
-- 1 –µ–¥–∏–Ω—ã–π —Ç—Ä–∏–≥–≥–µ—Ä
CREATE TRIGGER {table}_updated_at_set_now BEFORE INSERT OR UPDATE ON {table} FOR EACH ROW EXECUTE PROCEDURE updated_at_set_now();
 
-- –∏–ª–∏ 2 –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —Ç—Ä–∏–≥–≥–µ—Ä–∞
CREATE TRIGGER {table}_bi_updated_at_set_now BEFORE INSERT ON {table} FOR EACH ROW EXECUTE PROCEDURE updated_at_set_now(); --—á—Ç–æ–±—ã –Ω–µ –ø–æ–¥—Å—É–Ω—É–ª–∏ updated_at = null
CREATE TRIGGER {table}_bu_updated_at_set_now BEFORE UPDATE ON {table} FOR EACH ROW EXECUTE PROCEDURE updated_at_set_now();
```

## –ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è —Å—Ö–µ–º—ã –¥–∞–Ω–Ω—ã—Ö (DDL)

### –ö–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å –∫–æ–ª–æ–Ω–∫—É –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Ç–∞–±–ª–∏—Ü—É –±–µ–∑ –µ—ë –±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∏—è?

–°–º. [Stackoverflow](https://ru.stackoverflow.com/questions/721985/%D0%9A%D0%B0%D0%BA-%D0%B4%D0%BE%D0%B1%D0%B0%D0%B2%D0%B8%D1%82%D1%8C-%D0%BF%D0%BE%D0%BB%D0%B5-%D0%B2-%D0%B1%D0%BE%D0%BB%D1%8C%D1%88%D1%83%D1%8E-%D1%82%D0%B0%D0%B1%D0%BB%D0%B8%D1%86%D1%83-postgresql-%D0%B1%D0%B5%D0%B7-%D0%B1%D0%BB%D0%BE%D0%BA%D0%B8%D1%80%D0%BE%D0%B2%D0%BA%D0%B8)

### –ö–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã, –µ—Å–ª–∏ –æ–Ω–æ –µ—â—ë –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç?

–°–ø–æ—Å–æ–± 1.
–†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–º–∞–Ω–¥—ã `ALTER TABLE ... ADD CONSTRAINT IF NOT EXISTS ...`, –∫–æ—Ç–æ—Ä–∞—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ PostgreSQL 11.

```sql
-- Add constraint if it doesn't already exist
DO $$
DECLARE
    exception_message text;
    exception_context text;
BEGIN
    BEGIN
        ALTER TABLE company_awards 
            ADD CONSTRAINT company_awards_year CHECK(year between 1900 and date_part('year', CURRENT_DATE))
                NOT VALID -- —á—Ç–æ–±—ã –ë–î –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–ª–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –Ω–∞ –≤—Å–µ—Ö –∑–∞–ø–∏—Å—è—Ö –≤ —Ç–∞–±–ª–∏—Ü–µ (–∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ, –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏)
            ;
    EXCEPTION WHEN duplicate_object THEN
        GET STACKED DIAGNOSTICS
            exception_message = MESSAGE_TEXT,
            exception_context = PG_EXCEPTION_CONTEXT;
        RAISE NOTICE '%', exception_context;
        RAISE NOTICE '%', exception_message;
    END;

END $$;
```

–°–ø–æ—Å–æ–± 2.
```sql
ALTER TABLE company_awards 
    DROP CONSTRAINT IF EXISTS company_awards_year,
    ADD CONSTRAINT company_awards_year CHECK(year between 1900 and date_part('year', CURRENT_DATE))
        NOT VALID -- —á—Ç–æ–±—ã –ë–î –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–ª–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –Ω–∞ –≤—Å–µ—Ö –∑–∞–ø–∏—Å—è—Ö –≤ —Ç–∞–±–ª–∏—Ü–µ (–∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ, –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏)
    ;
```

### –ö–∞–∫ –∏–∑–º–µ–Ω–∏—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –≤–Ω–µ—à–Ω–µ–≥–æ –∫–ª—é—á–∞ –±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã?

```sql
ALTER TABLE group
    DROP CONSTRAINT group_company_id_fk,
    ADD CONSTRAINT group_company_id_fk
        FOREIGN KEY (company_id)
            REFERENCES company (id)
            ON UPDATE CASCADE
            ON DELETE CASCADE
        NOT VALID; -- https://postgrespro.ru/docs/postgresql/12/sql-altertable#SQL-ALTERTABLE-NOTES

ALTER TABLE group
    VALIDATE CONSTRAINT group_company_id_fk;
```

### –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∏–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∑–∞–ø–∏—Å–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã N –ø–æ–ª–µ–π –∏–∑ M –≤–æ–∑–º–æ–∂–Ω—ã—Ö?

```sql
CREATE TABLE table1
(
    field1 integer DEFAULT NULL,
    field2 integer DEFAULT NULL,
    field3 integer DEFAULT NULL,

    -- check that any N fields is required on INSERT or UPDATE
    CONSTRAINT table1 CHECK (
        -- –≤ –º–∞—Å—Å–∏–≤–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –¥–∞–Ω–Ω—ã–µ –æ–¥–Ω–æ–≥–æ —Ç–∏–ø–∞!
        array_length(array_remove(ARRAY[field1, field2, field3], null), 1) = 1
    )
);
```

### –ö–∞–∫ –∏–∑ enum —Ç–∏–ø–∞ —É–¥–∞–ª–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ?

PostgreSQL <= 12

```sql
# rename the existing type
ALTER TYPE status_enum RENAME TO status_enum_old;

# create the new type
CREATE TYPE status_enum AS ENUM('queued', 'running', 'done');

# update the columns to use the new type
ALTER TABLE job ALTER COLUMN job_status TYPE status_enum USING job_status::text::status_enum;
# if you get an error, see bottom of post

# remove the old type
DROP TYPE status_enum_old;
```

**Errors**

* `invalid input value for enum {enum name}: "{some value}"` - One or more rows have a value ("{some value}") that is not in your new type. You must handle these rows before you can update the column type.
* `default for column "{column_name}" cannot be cast automatically to type {enum_name}` - The default value for the column is not in your new type. You must change or remove the default value for the column before you can update the column type.

### –ö–∞–∫ –Ω–∞–π—Ç–∏ –≤—Å–µ —É–ø–æ–º–∏–Ω–∞–Ω–∏—è –Ω–∞–∑–≤–∞–Ω–∏—è –æ–±—ä–µ–∫—Ç–∞ –ë–î –ø–æ –≤—Å–µ–π –ë–î?

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –∑–∞–¥–∞—á–µ —É–¥–∞–ª–µ–Ω–∏—è –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ –ë–î (—Ç–∞–±–ª–∏—Ü, –∫–æ–ª–æ–Ω–æ–∫, —Ñ—É–Ω–∫—Ü–∏–π –∏ —Ç.–¥.), —á—Ç–æ–±—ã –Ω–∞–π—Ç–∏ –∑–∞–≤–∏—Å–∏–º—ã–µ –æ–±—ä–µ–∫—Ç—ã –ë–î. –¢.–æ. –º–∏–Ω–∏–º–∏–∑–∏—Ä—É—é—Ç—Å—è —Ä–∏—Å–∫–∏ —Å–ª–æ–º–∞—Ç—å —á—Ç–æ-–ª–∏–±–æ –≤ –ë–î –ø–æ—Å–ª–µ –Ω–∞–∫–∞—Ç—ã–≤–∞–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏.

–í—ã–≥—Ä—É–∂–∞–µ–º —Å—Ö–µ–º—É –ë–î –≤ —Ñ–∞–π–ª:

`$ pg_dump --user=postgres --dbname=my_database --schema-only > schema.sql`

–ò—â–µ–º —É–ø–æ–º–∏–Ω–∞–Ω–∏—è –≤ —Ñ–∞–π–ª–µ:

`$ reset && cat schema.sql | sed -E 's/^\-\-[^\r\n]*//g' | grep -P -A1 '\btable_name\b'`

### –ö–∞–∫ –∏–∑–º–µ–Ω–∏—Ç—å —Ç–∏–ø –∫–æ–ª–æ–Ω–∫–∏ —Å `int` –Ω–∞ `bigint`?

–ï—Å–ª–∏ –ø—Ä–æ—Å—Ç–æ–π alter –∑–∞–ø—Ä–æ—Å –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å > 1-3 —Å–µ–∫—É–Ω–¥, —ç—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –æ—á–µ—Ä–µ–¥–∏ –∑–∞–ø—Ä–æ—Å–æ–≤, –ø—É–ª –∫–æ—Ç–æ—Ä—ã—Ö –≤ –ë–î –º–æ–∂–µ—Ç –∑–∞–∫–æ–Ω—á–∏—Ç—å—Å—è. –ê —ç—Ç–æ –ø—Ä–∏–≤–µ–¥—ë—Ç –∫ –æ—Ç–∫–∞–∑—É –≤ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–∏.

–ü–æ—ç—Ç–æ–º—É –µ—Å—Ç—å –æ–±—Ö–æ–¥–Ω—ã–µ–∫ –ø—É—Ç–∏:
* https://stackoverflow.com/questions/54795701/migrating-int-to-bigint-in-postgressql-without-any-downtime
* http://zemanta.github.io/2021/08/25/column-migration-from-int-to-bigint-in-postgresql/
* https://engineering.silverfin.com/pg-zero-downtime-bigint-migration/
 
### –ö–∞–∫ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏, –µ—Å–ª–∏ –æ–Ω–æ –æ—Ç—Å—Ç–∞–ª–æ?

```sql
select setval(pg_get_serial_sequence('{schema}.{table}', 'id'), max(id), true)
from {schema}.{table};
```

## –ò–Ω–¥–µ–∫—Å—ã

### –ö–∞–∫ —Å–æ–∑–¥–∞—Ç—å –∏–ª–∏ –ø–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å –∏–Ω–¥–µ–∫—Å –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Ç–∞–±–ª–∏—Ü–µ –±–µ–∑ –µ—ë –±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∏—è?

–°–æ–∑–¥–∞–Ω–∏–µ –∏–ª–∏ —É–¥–∞–ª–µ–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–∞ –±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç—Å—è –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã–º —Ä–µ–∂–∏–º–æ–º –∏ —Ñ–ª–∞–≥–æ–º [`CONCURRENTLY`](https://postgrespro.ru/docs/postgresql/12/sql-createindex#SQL-CREATEINDEX-CONCURRENTLY). –ù–æ —É —ç—Ç–æ–≥–æ —Å–ø–æ—Å–æ–±–∞ –µ—Å—Ç—å –Ω–µ—Å—É—â–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–∏:
1. –ò–Ω–¥–µ–∫—Å —Å–æ–∑–¥–∞—ë—Ç—Å—è/—É–¥–∞–ª—è–µ—Ç—Å—è –¥–æ–ª—å—à–µ (2 —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã –≤–º–µ—Å—Ç–æ –æ–¥–Ω–æ–≥–æ).
1. –ó–∞–ø—É—Å–∫–∞—Ç—å —ç—Ç–∏ –∑–∞–ø—Ä–æ—Å—ã –Ω—É–∂–Ω–æ –ù–ï –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, –∞ –≤—Ä—É—á–Ω—É—é –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ. 
1. –í —Å–ª—É—á–∞–µ –Ω–µ—É–¥–∞—á–∏ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –∏–Ω–¥–µ–∫—Å–∞ –∏–ª–∏ –µ–≥–æ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω "–Ω–µ—Ä–∞–±–æ—á–∏–π/–±–∏—Ç—ã–π" –∏–Ω–¥–µ–∫—Å. –í —ç—Ç–æ–º —Å–ª—É—á–∞–µ –µ–≥–æ –Ω—É–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å –∏ —Å–æ–∑–¥–∞—Ç—å –∑–∞–Ω–æ–≤–æ.

–ï—Å–ª–∏ –ø—Ä–æ—Ü–µ—Å—Å —Å–æ–∑–¥–∞–Ω–∏—è –∏–Ω–¥–µ–∫—Å–∞ —É–±–∏—Ç—å –∏–∑ –¥—Ä—É–≥–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞, —Ç–æ –∏–Ω–¥–µ–∫—Å —Ç–æ—á–Ω–æ –±—É–¥–µ—Ç "–Ω–µ—Ä–∞–±–æ—á–∏–π/–±–∏—Ç—ã–π".

–ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö "–Ω–µ—Ä–∞–±–æ—á–∏—Ö/–±–∏—Ç—ã—Ö" –∏–Ω–¥–µ–∫—Å–æ–≤ –≤ –ë–î:
```sql
SELECT n.nspname              AS schemaname,
       c.relname              AS tablename,
       i.relname              AS indexname,
       t.spcname              AS tablespace,
       pg_get_indexdef(i.oid) AS indexdef
FROM pg_index x
JOIN pg_class c ON c.oid = x.indrelid
JOIN pg_class i ON i.oid = x.indexrelid
LEFT JOIN pg_namespace n ON n.oid = c.relnamespace
LEFT JOIN pg_tablespace t ON t.oid = i.reltablespace
WHERE (c.relkind = ANY (ARRAY ['r', 'm', 'p']))
  AND (i.relkind = ANY (ARRAY ['i', 'I']))
  AND not x.indisvalid;
```
–í –º–æ–º–µ–Ω—Ç —Ä–∞–±–æ—Ç—ã `create index concurrently` –≤ —Å–ø–∏—Å–∫–µ –±—É–¥—É—Ç –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–æ–≤–∞—Ç—å "–Ω–µ—Ä–∞–±–æ—á–∏–µ/–±–∏—Ç—ã–µ" –∏–Ω–¥–µ–∫—Å—ã!

–£–¥–∞–ª–∏—Ç—å –≤—Å–µ "–Ω–µ—Ä–∞–±–æ—á–∏–µ/–±–∏—Ç—ã–µ" –∏–Ω–¥–µ–∫—Å—ã –≤ –ë–î:
```sql
do $$
declare
    rec record;
begin

    for rec in
        select indrelid::regclass table_name,
               indexrelid::regclass index_name
        from pg_index
        where not indisvalid
        order by 1, 2
    loop
        raise notice 'Table "%", drop index "%"', rec.table_name, rec.index_name;
        execute format('drop index %I', rec.index_name);
    end loop;

end;
$$;
```

–ï—Å–ª–∏ –ë–î –≤ SQL –∑–∞–ø—Ä–æ—Å–µ —É–ø–æ—Ä–Ω–æ –Ω–µ —Ö–æ—á–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏–Ω–¥–µ–∫—Å, —Ö–æ—Ç—è –¥–æ–ª–∂–Ω–∞, —Ç–æ –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –∏–Ω–¥–µ–∫—Å –Ω–µ–±–∏—Ç—ã–π.

–¶–µ–ª—å –ø–µ—Ä–µ—Å—Ç—Ä–æ–µ–Ω–∏—è –∏–Ω–¥–µ–∫—Å–∞ - —É–º–µ–Ω—å—à–∏—Ç—å –∑–∞–Ω–∏–º–∞–µ–º—ã–π —Ä–∞–∑–º–µ—Ä –∏–∑-–∑–∞ [—Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞—Ü–∏–∏](https://github.com/ioguix/pgsql-bloat-estimation). –ö–æ–º–∞–Ω–¥–∞ REINDEX –∏–º–µ–µ—Ç –æ–ø—Ü–∏—é [CONCURRENTLY](https://www.postgresql.org/docs/12/sql-reindex.html), –∫–æ—Ç–æ—Ä–∞—è –ø–æ—è–≤–∏–ª–∞—Å—å —Ç–æ–ª—å–∫–æ –≤ PostgreSQL 12. –í –±–æ–ª–µ–µ —Ä–∞–Ω–Ω–∏—Ö –≤–µ—Ä—Å–∏—è—Ö –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å —Ç–∞–∫ (–Ω–µ–±–ª–æ–∫–∏—Ä—É—é—â–∞—è –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ –∫–æ–º–∞–Ω–¥–µ REINDEX):


```sql
-- –¥–ª—è –Ω–µ—É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ –∏–Ω–¥–µ–∫—Å–∞:
CREATE INDEX CONCURRENTLY tmp_index ON ...; -- –¥–µ–ª–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç –∏–Ω–¥–µ–∫—Å–∞ my_index
DROP INDEX CONCURRENTLY my_index;
ALTER INDEX tmp_index RENAME TO my_index;

-- –¥–ª—è –ø–µ—Ä–≤–∏—á–Ω–æ–≥–æ –∫–ª—é—á–∞:
CREATE UNIQUE INDEX CONCURRENTLY tmp_unique_index ON distributors (dist_id);
ALTER TABLE table_name
    DROP CONSTRAINT my_unique_index,
    ADD CONSTRAINT my_unique_index PRIMARY KEY USING INDEX tmp_unique_index;

-- –¥–ª—è —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ –∏–Ω–¥–µ–∫—Å–∞ (–µ—Å–ª–∏ –Ω–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –µ—Å—Ç—å —Å—Å—ã–ª–∞—é—â–∏–µ—Å—è –∑–∞–ø–∏—Å–∏ –ø–æ –≤–Ω–µ—à–Ω–µ–º—É –∫–ª—é—á—É –∏–∑ –¥—Ä—É–≥–∏—Ö —Ç–∞–±–ª–∏—Ü, —Ç–æ –±—É–¥–µ—Ç –æ—à–∏–±–∫–∞):
CREATE UNIQUE INDEX CONCURRENTLY tmp_unique_index ON ...;
ALTER TABLE table_name
    DROP CONSTRAINT my_unique_index,
    ADD CONSTRAINT my_unique_index UNIQUE USING INDEX tmp_unique_index;
```

### –ö–∞–∫ —Å–¥–µ–ª–∞—Ç—å —Å–æ—Å—Ç–∞–≤–Ω–æ–π —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å, –≥–¥–µ –æ–¥–Ω–æ –∏–∑ –ø–æ–ª–µ–π –º–æ–∂–µ—Ç –±—ã—Ç—å null?

```sql
create table test (
    a varchar not null,
    b varchar default null
);

-- –†–µ—à–µ–Ω–∏–µ 1. –ï—Å–ª–∏ –µ—Å—Ç—å –≤–Ω–µ—à–Ω–∏–µ –∫–ª—é—á–∏ –Ω–∞ –∫–æ–ª–æ–Ω–∫–∏ a –∏ b, —Ç–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∏–Ω–¥–µ–∫—Å–æ–≤ –¥–µ–ª–∞—Ç—å —É–∂–µ –Ω–µ –Ω—É–∂–Ω–æ.
create unique index on test (b, a) where b is not null;
create unique index on test (a) where b is null;

-- –†–µ—à–µ–Ω–∏–µ 2. –ï—Å—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç —Ç–∏–ø–∞ –¥–∞–Ω–Ω—ã—Ö, –Ω–æ –æ–¥–∏–Ω –∏–Ω–¥–µ–∫—Å –≤–º–µ—Å—Ç–æ –¥–≤—É—Ö.
create unique index on test(a, coalesce(b, '')) -- –¥–ª—è —á–∏—Å–µ–ª –≤–º–µ—Å—Ç–æ '' –Ω–∞–ø–∏—à–∏—Ç–µ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: 0 –∏–ª–∏ -1
```

### –ö–∞–∫ –ø–æ—á–∏–Ω–∏—Ç—å —Å–ª–æ–º–∞–Ω—ã–π —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å, –∏–º–µ—é—â–∏–π –¥—É–±–ª–∏–∫–∞—Ç—ã?

–ß–∏–Ω–∏–º –±–∏—Ç—ã–π —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å –Ω–∞ –ø–æ–ª–µ `skill.name`

```sql
-- EXPLAIN
WITH
skill AS (
   SELECT min(id) AS id_original,
          (array_agg(id order by id))[2:] AS id_doubles
   FROM skill
   GROUP BY lower(concat(name)) --–∏—Å–ø–æ–ª—å–∑—É–µ–º concat, —á—Ç–æ–±—ã –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è "–±–∏—Ç—ã–π" —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å –ø–æ lower(name)
   HAVING count(*) > 1
),

repair_resume_work_skill AS (
    -- —Å–æ–±–∏—Ä–∞–µ–º —Å–≤—è–∑–∏ —Å –¥—É–±–ª—è–º–∏ –≤ —Ç–∞–±–ª–∏—Ü—É
    SELECT t.resume_id, t.work_skill_id AS id_double, skill.id_original
    FROM skill
    INNER JOIN resume_work_skill AS t ON t.work_skill_id = ANY (skill.id_doubles)
),
deleted_resume_work_skill AS (
   -- —É–¥–∞–ª—è–µ–º —Å–≤—è–∑–∏ —Å –¥—É–±–ª—è–º–∏ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã
   DELETE FROM resume_work_skill
   USING repair_resume_work_skill AS t
   WHERE resume_work_skill.resume_id = t.resume_id
     AND resume_work_skill.work_skill_id = t.id_double
   RETURNING id
),
inserted_resume_work_skill AS (
   -- –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Å–≤—è–∑–∏, –ø—Ä–∏ —ç—Ç–æ–º —Ç–∞–∫–∞—è —Å–≤—è–∑—å —É–∂–µ –º–æ–∂–µ—Ç —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å
   INSERT INTO resume_work_skill (resume_id, work_skill_id)
   SELECT t.resume_id, t.id_original FROM repair_resume_work_skill AS t
   ON CONFLICT DO NOTHING
   RETURNING id
),

-- —É–¥–∞–ª—è–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã
deleted_skill AS (
   DELETE FROM skill
   USING skill AS t
   WHERE skill.id = ANY (t.id_doubles)
   RETURNING id
)

         SELECT 'resume_work_skill' AS table_name, 'deleted'  AS action, COUNT(*) FROM deleted_resume_work_skill
UNION ALL SELECT 'resume_work_skill' AS table_name, 'inserted' AS action, COUNT(*) FROM inserted_resume_work_skill

UNION ALL SELECT 'skill' AS table_name, 'deleted' AS action, COUNT(*) FROM deleted_skill
;

-- —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å
CREATE UNIQUE INDEX uniq_skill_name2 ON skill (lower(name));
-- —É–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –±–∏—Ç—ã–π –∏–Ω–¥–µ–∫—Å
DROP INDEX IF EXISTS skill.uniq_skill_name;
```

### –ö–∞–∫ –≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–∏—Ç—å –∏–Ω–¥–µ–∫—Å?

–°–ø–æ—Å–æ–± 1 (–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è postgres, –Ω–æ –±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏)
```sql
--Is it possible to temporarily disable an index in Postgres?
update pg_index set indisvalid = false where indexrelid = 'test_pkey'::regclass
```

–°–ø–æ—Å–æ–± 2 (–≤ –æ—Ç–¥–µ–ª—å–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, –Ω–æ —Å –±–ª–æ–∫–∏—Ä–æ–≤–∫–æ–π)
```sql
begin;
  drop index foo_ndx;
  explain analyze select * from foo;
rollback;
```
CAUTION: Dropping an index inside a transaction will lock out concurrent selects, inserts, updates, and deletes on the table while the transaction is active. Use with caution in test environments, and avoid on production databases.

### –ö–∞–∫ —Å–¥–µ–ª–∞—Ç—å –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å –Ω–∞ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –ø–æ–ª–µ?
```sql
-- –¥–ª—è –ø–æ–ª—è —Å —Ç–∏–ø–æ–º TEXT
-- md5, –ø—Ä–∏–≤–µ–¥—ë–Ω–Ω—ã–π –∫ —Ç–∏–ø—É uuid –∑–∞–Ω–∏–º–∞–µ—Ç 16 –±–∞–π—Ç –≤–º–µ—Å—Ç–æ 32 –±–∞–π—Ç
create unique index on table_name (cast(md5(lower(column_name)) as uuid));

-- –¥–ª—è –ø–æ–ª—è —Å —Ç–∏–ø–æ–º TEXT
-- –≤ —ç—Ç–æ–º –∏–Ω–¥–µ–∫—Å–µ –±—É–¥—É—Ç —É—á–∏—Ç—ã–≤–∞—Ç—å—Å—è —Å–ª–æ–≤–∞ (–±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã, —Ç–æ—á–∫–∞, –¥–µ—Ñ–∏—Å) –∏ –∏—Ö –ø–æ–∑–∏—Ü–∏–∏ –≤ —Ç–µ–∫—Å—Ç–µ, 
-- –Ω–æ –Ω–µ –±—É–¥–µ—Ç —É—á–∏—Ç—ã–≤–∞—Ç—å—Å—è —Ä–µ–≥–∏—Å—Ç—Ä —Å–ª–æ–≤ –∏ –ª—é–±—ã–µ –¥—Ä—É–≥–∏–µ —Å–∏–º–≤–æ–ª—ã
create unique index on table_name (cast(md5(cast(to_tsvector('simple', column_name) as text)) as uuid));

-- –¥–ª—è –ø–æ–ª—è —Å —Ç–∏–ø–æ–º JSONB
create unique index on table_name (cast(md5(lower(cast(column_name as text))) as uuid));
```

## –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ —Å SQL –∑–∞–ø—Ä–æ—Å–∞–º–∏, –≤—ã–ø–æ–ª–Ω—è—é—â–∏—Ö—Å—è —Å–µ–π—á–∞—Å?
–í PHPStorm –µ—Å—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –∑–∞–ø—Ä–æ—Å–∞ –∑–Ω–∞—á–µ–Ω–∏—è –≤ –∫–æ–ª–æ–Ω–∫–µ `application_name`–∏ –≤–ø–∏—Å–∞—Ç—å —Ç—É–¥–∞ –ü–û –∏ —Å–≤–æ—é —Ñ–∞–º–∏–ª–∏—é –¥–ª—è —Å–≤–æ–∏—Ö SQL –∑–∞–ø—Ä–æ—Å–æ–≤. –î–ª—è —ç—Ç–æ–≥–æ –Ω—É–∂–Ω–æ –æ—Ç–∫—Ä—ã—Ç—å –æ–∫–Ω–æ "Data Sources and Drivers", –≤—ã–±—Ä–∞—Ç—å –Ω—É–∂–Ω–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –ë–î –∏–∑ —Å–µ–∫—Ü–∏–∏ "Project Data Sources", –ø–µ—Ä–µ–π—Ç–∏ –Ω–∞ –≤–∫–ª–∞–¥–∫—É "Advanced", –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É –ø–æ –∫–æ–ª–æ–Ω–∫–µ "Name", –¥–ª—è "Name" —Ä–∞–≤–Ω–æ–º—É "Application Name", –∏–∑–º–µ–Ω–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ –≤ –∫–æ–ª–æ–Ω–∫–µ "Value" –Ω–∞ —á—Ç–æ-—Ç–æ —Ç–∏–ø–∞"PhpStorm Petrov Ivan" (—Å—Ç—Ä–æ–≥–æ –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º —è–∑—ã–∫–µ).

```sql
select e.*,
       pg_blocking_pids(pid),
       a.*  
       --, pg_cancel_backend(pid) -- –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ SQL –∑–∞–ø—Ä–æ—Å—ã, —Ä–∞–±–æ—Ç–∞—é—â–∏–µ –±–æ–ª–µ–µ 1 —á–∞—Å–∞, —Å–∏–≥–Ω–∞–ª–æ–º SIGINT. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î –¥–ª—è –ø—Ä–æ—Ü–µ—Å—Å–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è.
       --, pg_terminate_backend(pid) -- –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∑–∞–≤–µ—Ä—à–∏—Ç—å —Ä–∞–±–æ—Ç—É –≤—Å–µ—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤, —Ä–∞–±–æ—Ç–∞—é—â–∏—Ö –±–æ–ª–µ–µ 1 —á–∞—Å–∞, —Å–∏–≥–Ω–∞–ª–æ–º SIGTERM, –µ—Å–ª–∏ –Ω–µ –ø–æ–º–æ–≥–∞–µ—Ç SIGINT. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î –¥–ª—è –ø—Ä–æ—Ü–µ—Å—Å–∞ —Ç–µ—Ä—è–µ—Ç—Å—è.
from pg_stat_activity as a
cross join lateral (
    select statement_timestamp() - xact_start as xact_elapsed,  --–¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∏–ª–∏ NULL, –µ—Å–ª–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –Ω–µ—Ç
           case when a.state ~ '^idle\M' --idle, idle in transaction, idle in transaction (aborted)
                    then state_change - query_start
                else statement_timestamp() - query_start
               end as query_elapsed, --–¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞ –≤—Å–µ–≥–æ
           statement_timestamp() - state_change as state_change_elapsed --–¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è (–ø–æ–ª—è state)
) as e
where true
  and state_change is not null --–∏—Å–∫–ª—é—á–∞–µ–º –∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ö–≤–∞—Ç–∏–ª–æ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
  --and query ~ 'WITH  base_fcu_table'
  --and application_name ilike '%RINAT_TEST%'
  and state not in ('idle', 'idle in transaction', 'idle in transaction (aborted)')
  --and wait_event = 'ClientRead' --https://postgrespro.ru/docs/postgresql/12/monitoring-stats#WAIT-EVENT-TABLE
  --and (state_change_elapsed > interval '1 minutes' or xact_elapsed > interval '1 minutes')
order by greatest(state_change_elapsed, query_elapsed, xact_elapsed) desc;
```

### –ö–∞–∫ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–ª–∏ –∑–∞–≤–µ—Ä—à–∏—Ç—å —Ä–∞–±–æ—Ç—É –ø—Ä–æ—Ü–µ—Å—Å–æ–≤?

–ò–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ —Å—Ç—Ä–æ–∫–∏:
```sql
--, pg_cancel_backend(pid) -- –ò–õ–ò 
--, pg_terminate_backend(pid)

--and (state_change_elapsed > interval '1 minutes' or xact_elapsed > interval '1 minutes')
```

### –ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Ñ—É–Ω–∫—Ü–∏–π –ë–î, –≤–∫–ª—é—á–∞—è —Ç—Ä–∏–≥–≥–µ—Ä–Ω—ã–µ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã?

```sql
SELECT n.nspname AS "Schema",
       p.proname AS "Name",
       CASE WHEN p.proretset THEN 'setof ' ELSE '' END
       || pg_catalog.format_type(p.prorettype, NULL) AS "Result data type",
       CASE WHEN proallargtypes IS NOT NULL
           THEN pg_catalog.array_to_string(
               ARRAY(SELECT CASE
                            WHEN p.proargmodes[s.i] = 'i' THEN ''
                            WHEN p.proargmodes[s.i] = 'o' THEN 'OUT '
                            WHEN p.proargmodes[s.i] = 'b' THEN 'INOUT '
                            END || CASE
                                   WHEN COALESCE(p.proargnames[s.i], '') = '' THEN ''
                                   ELSE p.proargnames[s.i] || ' '
                                   END || pg_catalog.format_type(p.proallargtypes[s.i], NULL)
                     FROM
                                 pg_catalog.generate_series(1, pg_catalog.array_upper(p.proallargtypes, 1)) AS s(i)
               ), ', '
           ) ELSE pg_catalog.array_to_string(
           ARRAY(SELECT CASE
                        WHEN COALESCE(p.proargnames[s.i+1], '') = '' THEN ''
                        ELSE p.proargnames[s.i+1] || ' '
                        END || pg_catalog.format_type(p.proargtypes[s.i], NULL)
                 FROM
                             pg_catalog.generate_series(0, pg_catalog.array_upper(p.proargtypes, 1)) AS s(i)
           ), ', '
       )
       END AS "Argument data types",
       CASE WHEN p.provolatile = 'i' THEN 'immutable'
       WHEN p.provolatile = 's' THEN 'stable'
       WHEN p.provolatile = 'v' THEN 'volatile'
       END AS "Volatility",
       r.rolname AS "Owner",
       l.lanname AS "Language",
       p.prosrc AS "Source code",
       pg_catalog.obj_description(p.oid, 'pg_proc') AS "Description"
FROM pg_catalog.pg_proc p
    LEFT JOIN pg_catalog.pg_namespace n ON n.oid = p.pronamespace
    LEFT JOIN pg_catalog.pg_language l ON l.oid = p.prolang
    JOIN pg_catalog.pg_roles r ON r.oid = p.proowner
WHERE p.prorettype <> 'pg_catalog.cstring'::pg_catalog.regtype
      AND (p.proargtypes[0] IS NULL
           OR p.proargtypes[0] <> 'pg_catalog.cstring'::pg_catalog.regtype)
      AND NOT p.proisagg
      AND pg_catalog.pg_function_is_visible(p.oid)
      AND r.rolname <> 'pgsql';
```

### –ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (–≤–Ω–µ—à–Ω–∏—Ö –∫–ª—é—á–µ–π) –º–µ–∂–¥—É —Ç–∞–±–ª–∏—Ü–∞–º–∏ –ë–î?

–ó–∞–ø—Ä–æ—Å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ–ª–æ–Ω–∫–∏ `from_table`, `from_cols`, `to_table`, `to_cols` –∏ –¥—Ä—É–≥–∏–µ.

–î–ª—è –∫–∞–∫–æ–π-–ª–∏–±–æ —Ç–∞–±–ª–∏—Ü—ã –º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å:

* —Å–ø–∏—Å–æ–∫ –∏—Å—Ö–æ–¥—è—â–∏—Ö —Å–≤—è–∑–µ–π (—Ç–∞–±–ª–∏—Ü—ã, –∫–æ—Ç–æ—Ä—ã–µ –∑–∞–≤–∏—Å—è—Ç –æ—Ç —Ç–µ–∫—É—â–µ–π —Ç–∞–±–ª–∏—Ü—ã)
* —Å–ø–∏—Å–æ–∫ –≤—Ö–æ–¥—è—â–∏—Ö —Å–≤—è–∑–µ–π (—Ç–∞–±–ª–∏—Ü—ã, –æ—Ç –∫–æ—Ç–æ—Ä—ã—Ö –∑–∞–≤–∏—Å–∏—Ç —Ç–µ–∫—É—â–∞—è —Ç–∞–±–ª–∏—Ü–∞)

[–ò—Å—Ç–æ—á–Ω–∏–∫](https://stackoverflow.com/questions/1152260/postgres-sql-to-list-table-foreign-keys/36800049#36800049)

```sql
SELECT
    c.conname AS constraint_name,
    (SELECT n.nspname FROM pg_namespace AS n WHERE n.oid=c.connamespace) AS constraint_schema,

    tf.name AS from_table,
    (
        SELECT STRING_AGG(QUOTE_IDENT(a.attname), ', ' ORDER BY t.seq)
        FROM
            (
                SELECT
                    ROW_NUMBER() OVER (ROWS UNBOUNDED PRECEDING) AS seq,
                    attnum
                FROM UNNEST(c.conkey) AS t(attnum)
            ) AS t
            INNER JOIN pg_attribute AS a ON a.attrelid=c.conrelid AND a.attnum=t.attnum
    ) AS from_cols,

    tt.name AS to_table,
    (
        SELECT STRING_AGG(QUOTE_IDENT(a.attname), ', ' ORDER BY t.seq)
        FROM
            (
                SELECT
                    ROW_NUMBER() OVER (ROWS UNBOUNDED PRECEDING) AS seq,
                    attnum
                FROM UNNEST(c.confkey) AS t(attnum)
            ) AS t
            INNER JOIN pg_attribute AS a ON a.attrelid=c.confrelid AND a.attnum=t.attnum
    ) AS to_cols,

    CASE confupdtype WHEN 'r' THEN 'restrict'
                     WHEN 'c' THEN 'cascade'
                     WHEN 'n' THEN 'set null'
                     WHEN 'd' THEN 'set default'
                     WHEN 'a' THEN 'no action'
                     --ELSE NULL
    END AS on_update,

    CASE confdeltype WHEN 'r' THEN 'restrict'
                     WHEN 'c' THEN 'cascade'
                     WHEN 'n' THEN 'set null'
                     WHEN 'd' THEN 'set default'
                     WHEN 'a' THEN 'no action'
                     --ELSE NULL
    END AS on_delete,

    CASE confmatchtype::text WHEN 'f' THEN 'full'
                             WHEN 'p' THEN 'partial'
                             WHEN 'u' THEN 'simple'
                             WHEN 's' THEN 'simple'
                             --ELSE NULL
    END AS match_type,  -- In earlier postgres docs, simple was 'u'nspecified, but current versions use 's'imple.  text cast is required.

    pg_catalog.pg_get_constraintdef(c.oid, true) as condef
FROM
    pg_catalog.pg_constraint AS c
    INNER JOIN (
                   SELECT pg_class.oid, QUOTE_IDENT(pg_namespace.nspname) || '.' || QUOTE_IDENT(pg_class.relname) AS name
                   FROM pg_class INNER JOIN pg_namespace ON pg_class.relnamespace=pg_namespace.oid
               ) AS tf ON tf.oid=c.conrelid
    INNER JOIN (
                   SELECT pg_class.oid, QUOTE_IDENT(pg_namespace.nspname) || '.' || QUOTE_IDENT(pg_class.relname) AS name
                   FROM pg_class INNER JOIN pg_namespace ON pg_class.relnamespace=pg_namespace.oid
               ) AS tt ON tt.oid=c.confrelid
WHERE c.contype = 'f' ORDER BY 1;
```

### –ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∏–Ω–¥–µ–∫—Å–æ–≤?

–ó–∞–ø—Ä–æ—Å –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤. –ß—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç —É–≤–∏–¥–µ—Ç—å –Ω–∞–∏–±–æ–ª–µ–µ —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã, –∞ —Ç–∞–∫–∂–µ –∏ –Ω–∞–∏–±–æ–ª–µ–µ —Ä–µ–¥–∫–æ (—É –∫–æ—Ç–æ—Ä—ã—Ö –±—É–¥–µ—Ç index_scans_count = 0).

–£—á–∏—Ç—ã–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –∏–Ω–¥–µ–∫—Å—ã –∏ –Ω–µ —É—á–∏—Ç—ã–≤–∞—é—Ç—Å—è —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ, —Ç.–∫. –æ–Ω–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –∫–∞–∫ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è (–∫–∞–∫ —á–∞—Å—Ç—å –ª–æ–≥–∏–∫–∏ —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö).

–í –Ω–∞—á–∞–ª–µ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –Ω–∞–∏–±–æ–ª–µ–µ —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –∏–Ω–¥–µ–∫—Å—ã (–æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –ø–æ –∫–æ–ª–æ–Ω–∫–µ index_scans_count)

```sql
SELECT
    idstat.schemaname AS schema_name, -- –Ω–∞–∑–≤–∞–Ω–∏–µ —Å—Ö–µ–º—ã
    idstat.relname    AS table_name,  -- –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã
    indexrelname      AS index_name,  -- –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–∞
    idstat.idx_scan   AS index_scans_count, -- —á–∏—Å–ª–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–π –ø–æ —ç—Ç–æ–º—É –∏–Ω–¥–µ–∫—Å—É
    pg_size_pretty(pg_relation_size(indexrelid))AS index_size, -- —Ä–∞–∑–º–µ—Ä –∏–Ω–¥–µ–∫—Å–∞
    pg_size_pretty(pg_relation_size(idstat.relid)) AS table_size, -- —Ä–∞–∑–º–µ—Ä —Ç–∞–±–ª–∏—Ü—ã
    tabstat.idx_scan AS table_reads_index_count, -- –∏–Ω–¥–µ–∫—Å–Ω—ã—Ö —á—Ç–µ–Ω–∏–π –ø–æ —Ç–∞–±–ª–∏—Ü–µ
    tabstat.seq_scan AS table_reads_seq_count, -- –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö —á—Ç–µ–Ω–∏–π –ø–æ —Ç–∞–±–ª–∏—Ü–µ
    tabstat.seq_scan + tabstat.idx_scan AS table_reads_count, -- —á—Ç–µ–Ω–∏–π –ø–æ —Ç–∞–±–ª–∏—Ü–µ
    n_tup_upd + n_tup_ins + n_tup_del   AS table_writes_count -- –æ–ø–µ—Ä–∞—Ü–∏–π –∑–∞–ø–∏—Å–∏
FROM pg_stat_user_indexes AS idstat
JOIN pg_indexes ON indexrelname = indexname AND idstat.schemaname = pg_indexes.schemaname
JOIN pg_stat_user_tables AS tabstat ON idstat.relid = tabstat.relid
WHERE indexdef !~* 'unique'
ORDER BY idstat.idx_scan DESC, pg_relation_size(indexrelid) DESC
```

### –ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–π (extensions)?

```sql
select *
from pg_available_extensions
--where installed_version is not null
order by installed_version is null, name
```

### –ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ç–∞–±–ª–∏—Ü —Å —Ä–∞–∑–º–µ—Ä–æ–º –∑–∞–Ω–∏–º–∞–µ–º–æ–≥–æ –º–µ—Å—Ç–∞ –∏ –ø—Ä–∏–º–µ—Ä–Ω—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —Å—Ç—Ä–æ–∫?

–í—ã–ø–æ–ª–Ω–∏—Ç–µ –∑–∞–ø—Ä–æ—Å [`pg_table_size_rows_count.sql`](DBA/pg_table_size_rows_count.sql)

–í —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ –≤—ã –ø–æ–ª—É—á–∏—Ç–µ –ø—Ä–∏–º–µ—Ä–Ω–æ —Ç–∞–∫—É—é —Ç–∞–±–ª–∏—Ü—É:

| relation | table\_size\_pretty | toast\_size\_pretty | indexes\_size\_pretty | total\_size\_pretty | total\_size\_percent | rows\_estimate\_count\_pretty | rows\_estimate\_count\_percent |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| public.table_a | 25 GB | 2455 MB | 24 GB | 51 GB | 7.6 | 21,213,390 | 0.72 |
| public.table_b | 26 GB | 7568 kB | 21 GB | 48 GB | 7.06 | 330,934,528 | 11.27 |
| public.table_c | 21 GB | 12 GB | 14 GB | 47 GB | 6.97 | 9,149,683 | 0.31 |
| public.table_d | 35 GB | 324 MB | 3648 MB | 39 GB | 5.76 | 10,418,124 | 0.35 |
| public.table_e | 28 GB | 5317 MB | 3035 MB | 36 GB | 5.31 | 33,890,060 | 1.15 |
| ‚Ä¶ | ‚Ä¶ | ‚Ä¶ | ‚Ä¶ | ‚Ä¶ | ‚Ä¶ | ‚Ä¶ | ‚Ä¶ |


### –ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Å–∞–º—ã—Ö —Ä–µ—Å—É—Ä—Å–æ—ë–º–∫–∏—Ö SQL –∑–∞–ø—Ä–æ—Å–æ–≤?

–ú–µ–¥–ª–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –º–æ–≥—É—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –≤ —Ä–∞–∑—ã –±—ã—Å—Ç—Ä–µ–µ, –µ—Å–ª–∏ –∏—Ö –ø–µ—Ä–µ–ø–∏—Å–∞—Ç—å –ø–æ-–¥—Ä—É–≥–æ–º—É –∏/–∏–ª–∏ –¥–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã. 
–ì–æ—Ä–∞–∑–¥–æ –±–æ–ª–µ–µ –≤–∞–∂–Ω—ã–º –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º –æ—Ü–µ–Ω–∫–∏ SQL –∑–∞–ø—Ä–æ—Å–æ–≤ —è–≤–ª—è–µ—Ç—Å—è –∏—Ö **—Ä–µ—Å—É—Ä—Å–æ—ë–º–∫–æ—Å—Ç—å**, —Ç.–µ. % –ø–æ—Ç—Ä–µ–±–ª—è–µ–º—ã—Ö —Ä–µ—Å—É—Ä—Å–æ–≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º –∑–∞–ø—Ä–æ—Å–æ–º –≤ —Ä–∞–º–∫–∞—Ö –≤—Å–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞ –ë–î.
–î–ª—è –ø—Ä–∏–Ω—è—Ç–∏—è —Ä–µ—à–µ–Ω–∏—è –æ–± –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ (—É—Å–∫–æ—Ä–µ–Ω–∏—è) –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω—É–∂–Ω–æ —É—á–∏—Ç—ã–≤–∞—Ç—å:
* –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ–¥–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
* –∫–æ–ª-–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –∑–∞ –µ–¥–∏–Ω–∏—Ü—É –≤—Ä–µ–º–µ–Ω–∏
* –æ–±—ä—ë–º –ø–µ—Ä–µ–¥–∞–≤–∞–µ–º—ã—Ö –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö, –∏—Ö —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∏ –Ω–∞–ª–∏—á–∏–µ –¥—É–±–ª–∏—Ä—É—é—â–∏—Ö –∑–Ω–∞—á–µ–Ω–∏–π

```sql
create extension if not exists pg_stat_statements;

SELECT
    a.rolname,
    t.total_time / 1000 / 60 as total_time_minutes,
    round((t.total_time * 100 / sum(t.total_time) over())::numeric, 2) as percent,
    d.datname, s.query, s.calls, t.mean_time, t.stddev_time, s.rows,
    s.shared_blks_hit, s.shared_blks_read
FROM pg_stat_statements as s
INNER JOIN pg_database as d ON d.oid = s.dbid
INNER JOIN pg_authid as a ON a.oid = s.userid
--Add CROSS JOIN LATERAL for PG14+
CROSS JOIN LATERAL (
    SELECT s.total_plan_time  + s.total_exec_time  AS total_time,
           s.mean_plan_time   + s.mean_exec_time   AS mean_time,
           s.stddev_plan_time + s.stddev_exec_time AS stddev_time,
           s.max_plan_time    + s.max_exec_time    AS max_time
) AS t
--WHERE query ~* '(^|\n)\s*\m(insert\s+into|update|delete|truncate)\M' --—Ç–æ–ª—å–∫–æ DML –∑–∞–ø—Ä–æ—Å—ã
WHERE s.query !~* '(^|\n)\s*\m(insert\s+into|update|delete|truncate)\M' --–∏—Å–∫–ª—é—á–∞—è DML –∑–∞–ø—Ä–æ—Å—ã
ORDER BY t.total_time DESC  -- —Å–∞–º—ã–µ –¥–æ–ª–≥–∏–µ –∑–∞–ø—Ä–æ—Å—ã –ø–æ –æ–±—â–µ–º—É –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
--ORDER BY t.mean_time DESC -- —Å–∞–º—ã–µ –º–µ–¥–ª–µ–Ω–Ω—ã–µ –≤ —Å—Ä–µ–¥–Ω–µ–º (total_time / calls)
--ORDER BY t.max_time DESC  -- —Å–∞–º—ã–µ –º–µ–¥–ª–µ–Ω–Ω—ã–µ –≤ –ø–∏–∫–µ
--ORDER BY s.calls DESC       -- —Å–∞–º—ã–µ –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ –ø–æ –∫–æ–ª-–≤—É
--ORDER BY s.rows DESC        -- –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç —Å—Ç—Ä–æ–∫
LIMIT 100;
```

–û—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É:
```sql
SELECT pg_stat_statements_reset(); -- –¥–ª—è –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è pg_stat_statements
SELECT pg_stat_reset(); -- –≤—Å–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è –ø–æ —ç—Ç–æ–º—É —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—é
```
–°–º. —Ç–∞–∫ –∂–µ https://youtu.be/uaQoa61LH1g?t=1489

### –ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ SQL –∑–∞–ø—Ä–æ—Å–æ–≤, —Å–æ–∑–¥–∞—é—â–∏—Ö –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã?

SELECT –∑–∞–ø—Ä–æ—Å—ã, –∫–æ—Ç–æ—Ä—ã–µ –∞–∫—Ç–∏–≤–Ω–æ –ø–∏—à—É—Ç –Ω–∞ –¥–∏—Å–∫ –¥–µ—Å—è—Ç–∫–∞–º–∏ –∏ —Å–æ—Ç–Ω—è–º–∏ –º–µ–≥–∞–±–∞–π—Ç –ø–æ—Ç—Ä–µ–±–ª—è—é—Ç –ª–∏—à–Ω–∏–µ —Ä–µ—Å—É—Ä—Å—ã –ë–î –∏ –∑–∞–º–µ–¥–ª—è—é—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –¥—Ä—É–≥–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ.

–°–Ω–∞—á–∞–ª–∞ –ø–æ—Å–º–æ—Ç—Ä–∏–º –ø–æ –∫–∞–∂–¥–æ–π –ë–î
```sql
select datname, temp_files, pg_size_pretty(temp_bytes) as temp_file_size
FROM pg_stat_database
WHERE temp_files > 0
ORDER BY temp_bytes DESC;
```

–¢–µ–ø–µ—Ä—å –ø–æ—Å–º–æ—Ç—Ä–∏–º –Ω–∞ SQL –∑–∞–ø—Ä–æ—Å—ã
```sql
create extension if not exists pg_stat_statements;

SELECT (SELECT datname FROM pg_database as d WHERE d.oid = s.dbid) AS dbname,
       interval '1 ms' * total_time AS exec_time_total,
       interval '1 ms' * (total_time / calls) AS exec_time_avg,
       rows,
       calls,
       pg_size_pretty(temp_blks_written * current_setting('block_size')::int) AS temp_written_total,
       pg_size_pretty(temp_blks_written * current_setting('block_size')::int / calls) AS temp_written_avg,
       query
FROM pg_stat_statements AS s
--Add CROSS JOIN LATERAL for PG14+
CROSS JOIN LATERAL (
    SELECT s.total_plan_time + s.total_exec_time AS total_time,
           s.mean_plan_time + s.mean_exec_time AS mean_time,
           s.stddev_plan_time + s.stddev_exec_time AS stddev_time
) AS t
WHERE temp_blks_written > 0
ORDER BY temp_blks_written / calls DESC
LIMIT 20;
```

### –ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å –∏ –∏–∑–º–µ–Ω–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è?

#### –ø–æ–ª—É—á–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏–π –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤

```sql
-- —Å–ø–æ—Å–æ–± 1
SHOW pg_trgm.word_similarity_threshold;
SHOW pg_trgm.similarity_threshold;

-- —Å–ø–æ—Å–æ–± 2
SELECT name, setting AS value
FROM pg_settings
WHERE name IN ('pg_trgm.word_similarity_threshold', 'pg_trgm.similarity_threshold');

-- —Å–ø–æ—Å–æ–± 3
SELECT current_setting('pg_trgm.word_similarity_threshold'), current_setting('pg_trgm.similarity_threshold');
```

#### –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏–π –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
```sql
-- —Å–ø–æ—Å–æ–± 1
SET pg_trgm.similarity_threshold = 0.3;
SET pg_trgm.word_similarity_threshold = 0.3;

-- —Å–ø–æ—Å–æ–± 2
SELECT set_config('pg_trgm.word_similarity_threshold', 0.2::text, FALSE),
       set_config('pg_trgm.similarity_threshold', 0.2::text, FALSE);
```

### –ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –≤ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –ø—Ä–æ—Ü–µ—Å—Å—ã –∞–≤—Ç–æ–≤–∞–∫—É—É–ºa –∏ –≤—Ä–µ–º—è –∏—Ö —Ä–∞–±–æ—Ç—ã?

–í–∞–∫—É—É–º–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Äî –≤–∞–∂–Ω–∞—è –ø—Ä–æ—Ü–µ–¥—É—Ä–∞ –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏—è —Ö–æ—Ä–æ—à–µ–π —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ –≤–∞—à–µ–π –±–∞–∑—ã.
–ï—Å–ª–∏ –≤—ã –≤–∏–¥–∏—Ç–µ, —á—Ç–æ –∞–≤—Ç–æ–≤–∞–∫—É—É–º –ø—Ä–æ—Ü–µ—Å—Å—ã –≤—Å—ë –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç–∞—é—Ç, —ç—Ç–æ –∑–Ω–∞—á–∏—Ç —á—Ç–æ –æ–Ω–∏ –Ω–µ —É—Å–ø–µ–≤–∞—é—Ç –∑–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ —Å–∏—Å—Ç–µ–º–µ. –ê —ç—Ç–æ –≤ —Å–≤–æ—é –æ—á–µ—Ä–µ–¥—å —Å–∏–≥–Ω–∞–ª —Ç–æ–≥–æ —á—Ç–æ –Ω–∞–¥–æ —Å—Ä–æ—á–Ω–æ –ø—Ä–∏–Ω–∏–º–∞—Ç—å –º–µ—Ä—ã, –∏–Ω–∞—á–µ –µ—Å—Ç—å –±–æ–ª—å—à–æ–π —Ä–∏—Å–∫ ‚Äú—Ä–∞—Å–ø—É—Ö–∞–Ω–∏—è‚Äù —Ç–∞–±–ª–∏—Ü –∏ –∏–Ω–¥–µ–∫—Å–æ–≤ ‚Äî —Å–∏—Ç—É–∞—Ü–∏—è –∫–æ–≥–¥–∞ —Ñ–∏–∑–∏—á–µ—Å–∫–∏–π —Ä–∞–∑–º–µ—Ä –æ–±—ä–µ–∫—Ç–æ–≤ –≤ –±–∞–∑–µ –æ—á–µ–Ω—å –±–æ–ª—å—à–æ–π, –∞ –ø—Ä–∏ —ç—Ç–æ–º –ø–æ–ª–µ–∑–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ —Ç–∞–º –≤ —Ä–∞–∑—ã –º–µ–Ω—å—à–µ.

[–ò—Å—Ç–æ—á–Ω–∏–∫](https://dataegret.ru/#_autovacuumWorkers)

```
SELECT (clock_timestamp() - xact_start) AS ts_age,
state, pid, query FROM pg_stat_activity
WHERE query ilike '%autovacuum%' AND NOT pid=pg_backend_pid()
```

### –ö–∞–∫ —É–∑–Ω–∞—Ç—å, –ø–æ—á–µ–º—É –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ –æ—Ç –±–∞–∑—ã –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –ø–∞–¥–∞–µ—Ç?

–ü—Ä–∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã—Ö –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã—Ö —Ç–æ—á–∫–∞—Ö –±–∞–∑–∞ –±—É–¥–µ—Ç –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–∑–±—ã—Ç–æ—á–Ω—É—é –¥–∏—Å–∫–æ–≤—É—é –Ω–∞–≥—Ä—É–∑–∫—É. –≠—Ç–æ –±—É–¥–µ—Ç –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç—å —Å –≤—ã—Å–æ–∫–æ–π —á–∞—Å—Ç–æ—Ç–æ–π, —á—Ç–æ –±—É–¥–µ—Ç –∑–∞–º–µ–¥–ª—è—Ç—å –æ–±—â–µ–µ –≤—Ä–µ–º—è –æ—Ç–∫–ª–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã –∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.
–î–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã –ø–æ–Ω—è—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏, –Ω–∞–¥–æ –æ–±—Ä–∞—Ç–∏—Ç—å –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –≤ –ø–æ–≤–µ–¥–µ–Ω–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö:
–≤ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏–ª–∏ –±–∞–∑—ã –±—É–¥—É—Ç –≤–∏–¥–Ω—ã –ø–∏–∫–∏ –≤–æ –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–≤–µ—Ç–∞, —Å —Ö–æ—Ä–æ—à–æ –ø—Ä–æ—Å–ª–µ–∂–∏–≤–∞–µ–º–æ–π –ø–µ—Ä–∏–æ–¥–∏—á–Ω–æ—Å—Ç—å—é;
–≤ –º–æ–º–µ–Ω—Ç—ã "–ø–∏–∫–æ–≤" –≤ –ª–æ–≥–µ –±–∞–∑—ã –±—É–¥–µ—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å—Å—è –±–æ–ª—å—à–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ–¥–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ (–≤ —Å–ª—É—á–∞–µ –µ—Å–ª–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–∞–∫–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ).

–ó–∞–ø—Ä–æ—Å –ø–æ–∫–∞–∂–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–º —Ç–æ—á–∫–∞–º —Å –º–æ–º–µ–Ω—Ç–∞, –∫–æ–≥–¥–∞ –æ–Ω–∞ –≤ –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ä–∞–∑ –æ–±–Ω—É–ª—è–ª–∞—Å—å. –í–∞–∂–Ω—ã–º–∏ –ø–æ–∫–∞–∑–∞—Ç–µ–ª—è–º–∏ –±—É–¥—É—Ç –º–∏–Ω—É—Ç—ã –º–µ–∂–¥—É –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–º–∏ —Ç–æ—á–∫–∞–º–∏ –∏ –æ–±—ä—ë–º –∑–∞–ø–∏—Å—ã–≤–∞–µ–º–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.
–ë–æ–ª—å—à–æ–µ –∫–æ–ª-–≤–æ –¥–∞–Ω–Ω—ã—Ö –∑–∞ –∫–æ—Ä–æ—Ç–∫–æ–µ –≤—Ä–µ–º—è ‚Äî —ç—Ç–æ —Å–µ—Ä—å–µ–∑–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ —Å–∏—Å—Ç–µ–º—É –≤–≤–æ–¥–∞-–≤—ã–≤–æ–¥–∞. –ï—Å–ª–∏ —ç—Ç–æ –≤–∞—à —Å–ª—É—á–∞–π, —Ç–æ —Å–∏—Ç—É–∞—Ü–∏—é –Ω—É–∂–Ω–æ –æ–¥–Ω–æ–∑–Ω–∞—á–Ω–æ –º–µ–Ω—è—Ç—å!

[–ò—Å—Ç–æ—á–Ω–∏–∫](https://dataegret.ru/#_timeDropsDown)

```sql
SELECT now()-pg_postmaster_start_time() "Uptime",
now()-stats_reset "Minutes since stats reset",
round(100.0*checkpoints_req/checkpoints,1) "Forced
checkpoint ratio (%)",
round(min_since_reset/checkpoints,2) "Minutes between
checkpoints",
round(checkpoint_write_time::numeric/(checkpoints*1000),2) "Average
write time per checkpoint (s)",
round(checkpoint_sync_time::numeric/(checkpoints*1000),2) "Average
sync time per checkpoint (s)",
round(total_buffers/pages_per_mb,1) "Total MB written",
round(buffers_checkpoint/(pages_per_mb*checkpoints),2) "MB per
checkpoint",
round(buffers_checkpoint/(pages_per_mb*min_since_reset*60),2)
"Checkpoint MBps"
FROM (
SELECT checkpoints_req,
checkpoints_timed + checkpoints_req checkpoints,
checkpoint_write_time,
checkpoint_sync_time,
buffers_checkpoint,
buffers_checkpoint + buffers_clean + buffers_backend total_buffers,
stats_reset,
round(extract('epoch' from now() - stats_reset)/60)::numeric
min_since_reset,
(1024.0 * 1024 / (current_setting('block_size')::numeric))pages_per_mb
FROM pg_stat_bgwriter
) bg
```

### –ö–∞–∫ –æ–±–µ–∑–æ–ø–∞—Å–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ—Ç —Ç—è–∂—ë–ª—ã—Ö –º–∏–≥—Ä–∞—Ü–∏–π, –ø—Ä–∏–≤–æ–¥—è—â–∏—Ö –∫ –±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∏—é –∑–∞–ø—Ä–æ—Å–æ–≤?

–≠—Ç–æ—Ç –∫–æ–¥ –Ω–µ –¥–∞—ë—Ç 100% –≥–∞—Ä–∞–Ω—Ç–∏–∏, –∞ —Ç–æ–ª—å–∫–æ —É–º–µ–Ω—å—à–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤.
–ü–æ—Å–ª–µ —Ç–æ–≥–æ, –∫–∞–∫ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –≤–∑—è—Ç–∞, –¥—Ä—É–≥–∏–µ –∑–∞–ø—Ä–æ—Å—ã, –º–æ–≥—É—Ç –≤—Å—Ç–∞—Ç—å –≤ –æ—á–µ—Ä–µ–¥—å, –æ–∂–∏–¥–∞—è –æ—Ç–ø—É—Å–∫–∞–Ω–∏—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏.

–í–Ω–∞—á–∞–ª–µ –∫–∞–∂–¥–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏, –∫–æ—Ç–æ—Ä–∞—è –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, –Ω—É–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ [`lock_timeout`](https://postgrespro.ru/docs/postgresql/10/runtime-config-client#GUC-LOCK-TIMEOUT) –∏ [`statement_timeout`](https://postgrespro.ru/docs/postgresql/10/runtime-config-client#GUC-STATEMENT-TIMEOUT) –∏  [`idle_in_transaction_session_timeout`](https://postgrespro.ru/docs/postgresql/11/runtime-config-client#GUC-IDLE-IN-TRANSACTION-SESSION-TIMEOUT) –∫–æ–º–∞–Ω–¥–æ–π [SET LOCAL](https://postgrespro.ru/docs/postgresql/10/sql-set).
–î–µ–π—Å—Ç–≤–∏–µ SET LOCAL –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–æ –∫–æ–Ω—Ü–∞ —Ç–µ–∫—É—â–µ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Ç–æ–≥–æ, —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç—Å—è –æ–Ω–∞ –∏–ª–∏ –Ω–µ—Ç. 
–ü—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ —Ç–∞–∫–æ–π –∫–æ–º–∞–Ω–¥—ã –≤–Ω–µ –±–ª–æ–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤—ã–¥–∞—ë—Ç—Å—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –∏ –±–æ–ª—å—à–µ –Ω–∏—á–µ–≥–æ –Ω–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç.

```sql
/*
–ó–¥–µ—Å—å SQL –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –Ω–∞–∫–∞—Ç–∞ (–∏–ª–∏ –æ—Ç–∫–∞—Ç–∞), –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –º–æ–≥—É—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –≤–Ω—É—Ç—Ä–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
*/
 
BEGIN;
    DO $$
    DECLARE
        exception_message text;
        exception_context text;
    BEGIN
        /*
        –ó–∞–¥–∞—ë—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –æ–∂–∏–¥–∞–Ω–∏—è –ª—é–±—ã–º –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º –ø–æ–ª—É—á–µ–Ω–∏—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —Ç–∞–±–ª–∏—Ü—ã, –∏–Ω–¥–µ–∫—Å–∞, —Å—Ç—Ä–æ–∫–∏ –∏–ª–∏ –¥—Ä—É–≥–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.
        –ï—Å–ª–∏ –æ–∂–∏–¥–∞–Ω–∏–µ –Ω–µ –∑–∞–∫–æ–Ω—á–∏–ª–æ—Å—å –∑–∞ —É–∫–∞–∑–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è, –æ–ø–µ—Ä–∞—Ç–æ—Ä –ø—Ä–µ—Ä—ã–≤–∞–µ—Ç—Å—è.
        –≠—Ç–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤—É–µ—Ç –Ω–∞ –∫–∞–∂–¥—É—é –ø–æ–ø—ã—Ç–∫—É –ø–æ–ª—É—á–µ–Ω–∏—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –ø–æ –æ—Ç–¥–µ–ª—å–Ω–æ—Å—Ç–∏ –∏ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫–∞–∫ –∫ —è–≤–Ω—ã–º –∑–∞–ø—Ä–æ—Å–∞–º –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
        (–Ω–∞–ø—Ä–∏–º–µ—Ä, LOCK TABLE –∏–ª–∏ SELECT FOR UPDATE –±–µ–∑ NOWAIT), —Ç–∞–∫ –∏ –∫ –Ω–µ—è–≤–Ω—ã–º.
        –ï—Å–ª–∏ —ç—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ –∑–∞–¥–∞—ë—Ç—Å—è –±–µ–∑ –µ–¥–∏–Ω–∏—Ü –∏–∑–º–µ—Ä–µ–Ω–∏—è, –æ–Ω–æ —Å—á–∏—Ç–∞–µ—Ç—Å—è –∑–∞–¥–∞–Ω–Ω—ã–º –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö.
        */
        SET LOCAL lock_timeout TO '3s';
        -- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ª—é–±–æ–≥–æ SQL –∑–∞–ø—Ä–æ—Å–∞ –≤ —ç—Ç–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏. –ï—Å–ª–∏ –±—É–¥–µ—Ç –ø—Ä–µ–≤—ã—à–µ–Ω–æ, —Ç–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –æ—Ç–∫–∞—Ç–∏—Ç—Å—è.
        SET LOCAL statement_timeout TO '30min';
        -- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –ø—Ä–æ—Å—Ç–∞–∏–≤–∞–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, PostgreSQL >= 10. –ï—Å–ª–∏ –±—É–¥–µ—Ç –ø—Ä–µ–≤—ã—à–µ–Ω–æ, —Ç–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –æ—Ç–∫–∞—Ç–∏—Ç—Å—è.
        SET LOCAL idle_in_transaction_session_timeout TO '10s';
    EXCEPTION WHEN undefined_object THEN
        GET STACKED DIAGNOSTICS
            exception_message = MESSAGE_TEXT,
            exception_context = PG_EXCEPTION_CONTEXT;
        RAISE NOTICE '%', exception_context;
        RAISE NOTICE '%', exception_message;
    END $$;
 
 
    /*
    –ó–¥–µ—Å—å SQL –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –Ω–∞–∫–∞—Ç–∞ (–∏–ª–∏ –æ—Ç–∫–∞—Ç–∞) –≤–Ω—É—Ç—Ä–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
    */
COMMIT;
 
/*
–ó–¥–µ—Å—å SQL –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –Ω–∞–∫–∞—Ç–∞ (–∏–ª–∏ –æ—Ç–∫–∞—Ç–∞), –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –º–æ–≥—É—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –≤–Ω—É—Ç—Ä–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
*/
```
–ï—Å–ª–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –æ—Ç–∫–∞—Ç–∏—Ç—Å—è, —Ç–æ –µ—Å—Ç—å 2 –≤–∞—Ä–∏–∞–Ω—Ç–∞: –∑–∞–ø—É—Å—Ç–∏—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ –≤–æ –≤—Ä–µ–º—è –º–µ–Ω—å—à–∏—Ö –Ω–∞–≥—Ä—É–∑–æ–∫ –∏–ª–∏ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥ –º–∏–≥—Ä–∞—Ü–∏–∏, —á—Ç–æ–±—ã —Å–≤–µ—Å—Ç–∏ –∫ –º–∏–Ω–∏–º—É–º—É –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏.

–°–º. –µ—â—ë:
* [–∑–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–µ—Ä–µ–≤–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤](https://postgres.ai/blog/20211018-postgresql-lock-trees)
* [execute_attempt.sql](procedures/execute_attempt/execute_attempt.sql)


### Simple index checking

[–ò—Å—Ç–æ—á–Ω–∏–∫ –∏ —Å—Ç–∞—Ç—å—è –ø–æ —Ç–µ–º–µ](https://www.compose.com/articles/simple-index-checking-for-postgres/)

```sql
with table_stats as (
select psut.relname,
  psut.n_live_tup,
  1.0 * psut.idx_scan / greatest(1, psut.seq_scan + psut.idx_scan) as index_use_ratio
from pg_stat_user_tables psut
order by psut.n_live_tup desc
),
table_io as (
select psiut.relname,
  sum(psiut.heap_blks_read) as table_page_read,
  sum(psiut.heap_blks_hit)  as table_page_hit,
  sum(psiut.heap_blks_hit) / greatest(1, sum(psiut.heap_blks_hit) + sum(psiut.heap_blks_read)) as table_hit_ratio
from pg_statio_user_tables psiut
group by psiut.relname
order by table_page_read desc
),
index_io as (
select psiui.relname,
  psiui.indexrelname,
  sum(psiui.idx_blks_read) as idx_page_read,
  sum(psiui.idx_blks_hit) as idx_page_hit,
  1.0 * sum(psiui.idx_blks_hit) / greatest(1.0, sum(psiui.idx_blks_hit) + sum(psiui.idx_blks_read)) as idx_hit_ratio
from pg_statio_user_indexes psiui
group by psiui.relname, psiui.indexrelname
order by sum(psiui.idx_blks_read) desc
)
select ts.relname, ts.n_live_tup, ts.index_use_ratio,
  ti.table_page_read, ti.table_page_hit, ti.table_hit_ratio,
  ii.indexrelname, ii.idx_page_read, ii.idx_page_hit, ii.idx_hit_ratio
from table_stats ts
left outer join table_io ti
  on ti.relname = ts.relname
left outer join index_io ii
  on ii.relname = ts.relname
order by ti.table_page_read desc, ii.idx_page_read desc
```

### –ö–∞–∫ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö?

–ë–µ–∑ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤, –æ–¥–Ω–æ–π –∫–æ–º–∞–Ω–¥–æ–π:
```bash
pg_dump -U postgres -h 127.0.0.1 --dbname=my_database_src --verbose \
    | psql -X -U postgres -h 127.0.0.1 --dbname=my_database_dst 2> my_database.stderr.log
```

–ß–µ—Ä–µ–∑ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–π —Å–∂–∞—Ç—ã–π —Ñ–∞–π–ª.

–°–º. [`db_dump.sh`](DBA/db_dump.sh) –∏ [`db_restore.sh`](DBA/db_restore.sh).

### –ö–∞–∫ –≤—ã–≥—Ä—É–∑–∏—Ç—å —Ç–∞–±–ª–∏—Ü—ã –∏–∑ –ë–î?

–í—ã–≥—Ä—É–∂–∞–µ–º:
`pg_dump -U postgres --db=my_database --table=public.my_table1 --table=public.my_table2 > my_tables.sql`

C–∂–∏–º–∞–µ–º:
`zstd -19 -T8 my_tables.sql -o my_tables.sql.zst`

–û–¥–Ω–æ–π –∫–æ–º–∞–Ω–¥–æ–π:
`pg_dump -U postgres --db=my_database --table=public.my_table1 --table=public.my_table2 | zstd -19 -T8 -o my_tables.sql.zst`

### –ö–∞–∫ –≤—ã–≥—Ä—É–∑–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç SELECT –∑–∞–ø—Ä–æ—Å–∞ –≤ CSV?

–§–∞–π–ª `select.sql`
```sql
copy (
    select id, send_date::timestamp(0), message
    from my_table
    where send_date > now() - interval '2 month'
    --limit 100
) to stdout (format csv, header false);
```

```bash
cat select.sql | psql -U postgres --dbname=my_database | zstd -19 -T8 -o select.csv.zst
```

–∏–ª–∏ (–ª—É—á—à–µ —Å–∂–∏–º–∞–µ—Ç, –Ω–æ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ –º–µ–¥–ª–µ–Ω–Ω–µ–µ —Ä–∞–±–æ—Ç–∞–µ—Ç)
```bash
cat select.sql | psql -U postgres --dbname=my_database | xz -zc9 --threads=8 > select.csv.xz
```

–ï—â—ë –æ–¥–∏–Ω —Å–ø–æ—Å–æ–±:
```bash
sudo su - postgres -c "psql -qX --csv -c 'select * from pg_stat_activity'" > select.csv
# –∏–ª–∏
sudo su - postgres -c "psql -qX --csv --file=select.sql" > select.csv
```

### –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–∏–Ω—Ç–∞–∫—Å–∏—Å SQL –∫–æ–¥–∞ –±–µ–∑ –µ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è?

–ì–æ—Ç–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è: [`is_sql.sql`](functions/is/is_sql.sql)

```sql
-- PostgreSQL syntax check without running the query
DO $SYNTAX_CHECK$ BEGIN
    RETURN;
    -- insert your SQL code here
END; $SYNTAX_CHECK$;
```

### –ö–∞–∫ –æ—Ç–∫–∞—Ç–∏—Ç—å —á–∞—Å—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤–Ω—É—Ç—Ä–∏ —Ñ—É–Ω–∫—Ü–∏–∏ –∏–ª–∏ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã?

–ù–∞ `SQL` –≤—ã –º–æ–∂–µ—Ç–µ —Å–¥–µ–ª–∞—Ç—å —Ç–∞–∫:
```sql
BEGIN;
    INSERT INTO table1 VALUES (1);
    SAVEPOINT my_savepoint;
    INSERT INTO table1 VALUES (2);
    ROLLBACK TO SAVEPOINT my_savepoint; --rollback previous command
    INSERT INTO table1 VALUES (3);
COMMIT;
```

–í–Ω—É—Ç—Ä–∏ —Ñ—É–Ω–∫—Ü–∏–∏ –∏–ª–∏ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã –∫–æ–¥ –≤—ã—à–µ –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è —Å –æ—à–∏–±–∫–æ–π, –Ω–∞–ø—Ä–∏–º–µ—Ä –≤ [`is_sql.sql`](functions/is/is_sql.sql).
–ù–æ –≤—ã –º–æ–∂–µ—Ç–µ –æ—Ç–∫–∞—Ç–∏—Ç—å —á–∞—Å—Ç—å SQL –∫–æ–º–∞–Ω–¥ –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —á–µ—Ä–µ–∑ –ø–æ–¥—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:
```sql
DO $TEST$
BEGIN
    -- here you can write DDL commands, for example, adding or deleting a table or its section
    -- and/or
    -- here you can write DML commands that modify data in tables and, thus, check the operation of triggers

    -- rollback all test queries
    raise exception using errcode = 'query_canceled';

EXCEPTION WHEN query_canceled THEN
    --don't do anything
END
$TEST$;
```

### –ö–∞–∫ —Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞—Ç—å –¥–æ–ª–≥–∏–µ –ø—Ä–æ—Å—Ç–∞–∏–≤–∞—é—â–∏–µ –±–µ–∑ –¥–µ–ª–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î?

–¶–µ–ª—å ‚Äî –∑–∞—â–∏—Ç–∞ —Ç–µ—Å—Ç–æ–≤–æ–π –ë–î –∏–ª–∏ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω–æ–π —Ä–µ–ø–ª–∏–∫–∏ –ë–î –æ—Ç —Å–±–æ–µ–≤ –∏–∑-–∑–∞ –æ—à–∏–±–æ–∫ –≤ –∫–æ–¥–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π.

–ß—Ç–æ–±—ã —Ä–µ–ø–ª–∏–∫–µ –∑–∞–±—Ä–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å –º–∞—Å—Ç–µ—Ä–∞, –æ–Ω–∞ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Ç–µ—Ä–º–∏–Ω–∏—Ä—É–µ—Ç –ø–æ —Ç–∞–π–º–∞—É—Ç—É –≤—Å–µ –æ—á–µ–Ω—å –¥–æ–ª–≥–∏–µ –∑–∞–ø—Ä–æ—Å—ã –∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –Ω–∞ —Ä–µ–ø–ª–∏–∫–µ.

–ü—Ä–∏–º–µ—Ä –∫–æ–º–∞–Ω–¥, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –Ω–∞ –º–∞—Å—Ç–µ—Ä–µ (–ø–æ–¥ —Å—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º):
```sql
alter system set idle_session_timeout = '20m'; --PostgreSQL v14+
alter system set idle_in_transaction_session_timeout = '50m'; --PostgreSQL v9.6+
```

–ü—Ä–∏–º–µ—Ä –∫–æ–º–∞–Ω–¥, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –Ω–∞ —Ä–µ–ø–ª–∏–∫–µ (–ø–æ–¥ —Å—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º):
```sql
alter system set max_standby_archive_delay = '1h';
alter system set max_standby_streaming_delay = '1h';
```

–ù–µ –∑–∞–±—É–¥—å—Ç–µ –≤–Ω–µ—Å—Ç–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ñ–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ `postgresql.conf` (—É–∑–Ω–∞—Ç—å, –≥–¥–µ –æ–Ω –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –º–æ–∂–Ω–æ –∫–æ–º–∞–Ω–¥–æ–π `show config_file`).

–ü–∞—Ä–∞–º–µ—Ç—Ä `idle_session_timeout` –ø–æ—è–≤–∏–ª—Å—è —Ç–æ–ª—å–∫–æ PostgreSQL v14+. 
–í PgBouncer –µ—Å—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä [`server_idle_timeout`](https://www.pgbouncer.org/config.html), –∫–æ—Ç–æ—Ä—ã–π –ø–æ —Å—É—Ç–∏ —è–≤–ª—è–µ—Ç—Å—è –∞–Ω–∞–ª–æ–≥–æ–º `idle_session_timeout`.
–î–ª—è PostgreSQL –≤–µ—Ä—Å–∏–π < 14 c–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª [`pg_terminate_idle_timeout.sql`](old/pg_terminate/pg_terminate_idle_timeout.sql).
–ó–∞–ø—Ä–æ—Å –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—ã–ø–æ–ª–Ω—è—Ç—å 1 —Ä–∞–∑ –≤ –º–∏–Ω—É—Ç—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∏–∑ –∫—Ä–æ–Ω–∞).
```
$ crontab -l
# m h dom mon dow command
* * * * * psql -U postgres --file=/path/to/pg_terminate_idle_timeout.sql
```


### –ö–∞–∫ —Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞—Ç—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã, –æ–±—Ä–∞–∑—É—é—â–∏–µ –æ—á–µ—Ä–µ–¥—å?

–¶–µ–ª—å ‚Äî –∑–∞—â–∏—Ç–∞ —Ç–µ—Å—Ç–æ–≤–æ–π –ë–î –∏–ª–∏ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω–æ–π —Ä–µ–ø–ª–∏–∫–∏ –ë–î –æ—Ç —Å–±–æ–µ–≤ –∏–∑-–∑–∞ –æ—à–∏–±–æ–∫ –≤ –∫–æ–¥–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π.

–û–¥–∏–Ω–∞–∫–æ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã –º–æ–≥—É—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –¥—Ä—É–≥-–¥—Ä—É–≥–∞ –∏ –æ–±—Ä–∞–∑–æ–≤—ã–≤–∞—Ç—å –æ—á–µ—Ä–µ–¥—å.
–ö–æ–≥–¥–∞ –∫–æ–ª-–≤–æ –¥–æ–ø—É—Å—Ç–∏–º—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –∫ –ë–î –±—É–¥–µ—Ç –ø—Ä–µ–≤—ã—à–µ–Ω–æ, –æ–Ω–∞ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Ç–µ—Ä–º–∏–Ω–∏—Ä—É–µ—Ç –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã –∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏.
–°—Ä–µ–¥–∏ —ç—Ç–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –º–æ–≥—É—Ç –±—ã—Ç—å "–Ω–µ–≤–∏–Ω–æ–≤–Ω—ã–µ" –∑–∞–ø—Ä–æ—Å—ã.
–ù–æ –º–æ–∂–Ω–æ —Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –ø—Ä–æ–±–ª–µ–º–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏.

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª [`pg_terminate_duplicate_locked.sql`](old/pg_terminate/pg_terminate_duplicate_locked.sql):

–ó–∞–ø—Ä–æ—Å –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—ã–ø–æ–ª–Ω—è—Ç—å 1 —Ä–∞–∑ –≤ 15 —Å–µ–∫—É–Ω–¥ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∏–∑ –∫—Ä–æ–Ω–∞).

```
$ crontab -l
# m h dom mon dow command
* * * * *               psql -U postgres --file=/path/to/pg_terminate_duplicate_locked.sql
* * * * * ( sleep 15 && psql -U postgres --file=/path/to/pg_terminate_duplicate_locked.sql )
* * * * * ( sleep 30 && psql -U postgres --file=/path/to/pg_terminate_duplicate_locked.sql )
* * * * * ( sleep 45 && psql -U postgres --file=/path/to/pg_terminate_duplicate_locked.sql )
```

### –ö–∞–∫ –∂—É—Ä–Ω–∞–ª–∏—Ä–æ–≤–∞—Ç—å DDL –∫–æ–º–∞–Ω–¥—ã –≤ —Ç–∞–±–ª–∏—Ü—É –ë–î?

–ì–æ—Ç–æ–≤–æ–µ —Ä–µ—à–µ–Ω–∏–µ: [`DDL_log_to_table`](DDL_log_to_table)

### –ö–∞–∫ —É–∑–Ω–∞—Ç—å, –∫–∞–∫–∏–µ —Å–∞–º—ã–µ —á–∞—Å—Ç—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –≤ —Ç–∞–±–ª–∏—Ü–µ —Å–æ–≤–µ—Ä—à–∞—é—Ç—Å—è?

–û–¥–Ω–∞ –∏–∑ —Ü–µ–ª–µ–π ‚Äî —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ [`fillfactor`](https://www.cybertec-postgresql.com/en/what-is-fillfactor-and-how-does-it-affect-postgresql-performance/) –¥–ª—è —Ç–∞–±–ª–∏—Ü —Å —á–∞—Å—Ç—ã–º–∏ UPDATE, —á—Ç–æ–±—ã –∑–∞–¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å [Heap-Only Tuple update](https://www.cybertec-postgresql.com/en/hot-updates-in-postgresql-for-better-performance/) –¥–ª—è —É–≤–µ–ª–∏—á–µ–Ω–∏—è —Å–∫–æ—Ä–æ—Å—Ç–∏ —Ä–∞–±–æ—Ç—ã.

–ì–æ—Ç–æ–≤–æ–µ —Ä–µ—à–µ–Ω–∏–µ: [`pg_stat_user_tables_usage.sql`](DBA/pg_stat_user_tables_usage.sql)

–ö–æ–ª–æ–Ω–∫–∞ `usage` —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–∞–±–æ—Ä –±—É–∫–≤:
|–î–µ–π—Å—Ç–≤–∏–µ |–ú–Ω–æ–≥–æ |–ú–∞–ª–æ|
|---------|------|----|
|–ß—Ç–µ–Ω–∏–µ     | `S` (>80%) | `s` (>50%) |
|–í—Å—Ç–∞–≤–∫–∞    | `I` (>90%) | `i` (>30%) |
|–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ | `U` (>90%) | `u` (>30%) |
|–£–¥–∞–ª–µ–Ω–∏–µ   | `D` (>90%) | `d` (>30%) |


### –ö–∞–∫ —É–∑–Ω–∞—Ç—å –æ—Ç—Å—Ç–∞–≤–∞–Ω–∏–µ —Ä–µ–ø–ª–∏–∫?

–ù–∞ –º–∞—Å—Ç–µ—Ä–µ:
```sql
SELECT
    client_addr,
    usename AS user,
    application_name,
    state,
    sync_state AS mode,
    pg_current_wal_lsn() - sent_lsn   AS pending_bytes,    -- –æ–±—ä—ë–º –¥–∞–Ω–Ω—ã—Ö –∫ –æ—Ç–ø—Ä–∞–≤–∫–µ, –∫–æ—Ç–æ—Ä—ã–π —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ –≤—Å–µ—Ö –∂—É—Ä–Ω–∞–ª—å–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π, –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã—Ö –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–º —É–∑–ª–µ, –Ω–æ –µ—â–µ –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Ä–µ–ø–ª–∏–∫—É
    sent_lsn - write_lsn              AS write_lag_bytes,  -- –æ–±—ä—ë–º –¥–∞–Ω–Ω—ã—Ö, –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö —Å –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —É–∑–ª–∞, –Ω–æ –µ—â–µ –Ω–µ –∑–∞–ø–∏—Å–∞–Ω–Ω—ã—Ö –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ —Ä–µ–ø–ª–∏–∫–∏
    write_lsn - flush_lsn             AS flush_lag_bytes,  -- –æ–±—ä—ë–º –¥–∞–Ω–Ω—ã—Ö, –∑–∞–ø–∏—Å–∞–Ω–Ω—ã—Ö, –Ω–æ –µ—â–µ –Ω–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –Ω–∞ —Ä–µ–ø–ª–∏–∫–µ
    flush_lsn - replay_lsn            AS replay_lag_bytes, -- –æ–±—ä—ë–º –¥–∞–Ω–Ω—ã—Ö, –≥–æ—Ç–æ–≤—ã—Ö –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–æ–º startup
    pg_current_wal_lsn() - replay_lsn AS total_lag_bytes,
    write_lag,  -- –≤—Ä–µ–º—è, –ø—Ä–æ—à–µ–¥—à–µ–µ –º–µ–∂–¥—É –ª–æ–∫–∞–ª—å–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–µ–π –∂—É—Ä–Ω–∞–ª–∞ –∏ –ø–æ–ª—É—á–µ–Ω–∏–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Ç–æ–º, —á—Ç–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞–ø–∏—Å–∞–Ω—ã (–Ω–æ –µ—â–µ –Ω–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã) –Ω–∞ —Ä–µ–ø–ª–∏–∫–µ
    flush_lag,  -- –≤—Ä–µ–º—è, –ø—Ä–æ—à–µ–¥—à–µ–µ –º–µ–∂–¥—É –ª–æ–∫–∞–ª—å–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–µ–π –∂—É—Ä–Ω–∞–ª–∞ –∏ –ø–æ–ª—É—á–µ–Ω–∏–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Ç–æ–º, —á—Ç–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞–ø–∏—Å–∞–Ω—ã –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –Ω–∞ —Ä–µ–ø–ª–∏–∫–µ
    replay_lag, -- –≤—Ä–µ–º—è, –ø—Ä–æ—à–µ–¥—à–µ–µ –º–µ–∂–¥—É –ª–æ–∫–∞–ª—å–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–µ–π –∂—É—Ä–Ω–∞–ª–∞ –∏ –ø–æ–ª—É—á–µ–Ω–∏–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Ç–æ–º, —á—Ç–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞–ø–∏—Å–∞–Ω—ã, —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã
    reply_time  -- –æ—Ç–º–µ—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ –æ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–ª—É–∂–µ–±–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç —Ä–µ–ø–ª–∏–∫–∏, –≤ –∫–æ—Ç–æ—Ä–æ–º –∏ —Å–æ–¥–µ—Ä–∂–∞—Ç—Å—è –¥–∞–Ω–Ω—ã–µ –ø–æ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∂—É—Ä–Ω–∞–ª–∞
FROM pg_stat_replication;
```

–ù–∞ —Ä–µ–ø–ª–∏–∫–µ:
```sql
select case when not pg_is_in_recovery() then null -- not standby
            when not exists(select from pg_stat_wal_receiver where status = 'streaming') then null -- primary lost
            when pg_last_wal_receive_lsn() = pg_last_wal_replay_lsn() then '0'::interval -- no lag
            else coalesce(now() - pg_last_xact_replay_timestamp(), '0'::interval)
       end as replication_lag_interval,
       current_setting('max_standby_archive_delay') as max_standby_archive_delay,
       current_setting('max_standby_streaming_delay') as max_standby_streaming_delay;
```
–ü—Ä–∏ –ø—Ä–æ—Å—Ç–æ–µ –º–∞—Å—Ç–µ—Ä–∞ –±–µ–∑ –Ω–∞–≥—Ä—É–∑–∫–∏ –∑–∞–ø—Ä–æ—Å –º–æ–∂–µ—Ç –≤—ã–¥–∞–≤–∞—Ç—å –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ —Å –æ—Ç—Å—Ç–∞–≤–∞–Ω–∏–µ–º —Ä–µ–ø–ª–∏–∫–∏. –í —Ç–∞–∫–æ–º —Å–ª—É—á–∞–µ –Ω—É–∂–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –∑–∞–ø—Ä–æ—Å –Ω–∞ –º–∞—Å—Ç–µ—Ä–µ.

### –ö–∞–∫ —É–∑–Ω–∞—Ç—å –ø—Ä–æ—Ü–µ–Ω—Ç –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Å–≤–æ–µ–≥–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–µ–π?

```sql
select schemaname as schema,
       sequencename as sequence_name,
       data_type,
       used_percent
from pg_sequences
cross join round(last_value * 100.0 / max_value, 2) as used_percent
where last_value is not null /*null means access denied*/ and used_percent > 33
order by used_percent desc; 
```

–ü—Ä–∏–º–µ—Ä —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:

|schema |sequence_name  |data_type | used_percent|
|-------|---------------|----------|-------------|
|public |table_a_id_seq |integer   |100          |
|public |table_b_id_seq |integer   |37.13        |

### –ö–∞–∫ —É–¥–∞–ª–∏—Ç—å –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ WAL —Ñ–∞–π–ª—ã?

–ï—Å–ª–∏ PostgreSQL –∑–∞–ø—É—â–µ–Ω:

```sql
-- –≤—ã—è–≤–ª—è–µ–º –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–µ —Å–ª–æ—Ç—ã —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ –Ω–µ –Ω—É–∂–Ω—ã
SELECT *,
       pg_wal_lsn_diff(
          pg_current_wal_lsn(),
          restart_lsn
       ) AS bytes_behind
FROM pg_replication_slots
ORDER BY restart_lsn;

-- —É–¥—è–ª—è–µ–º —Ç–∞–∫–∏–µ —Å–ª–æ—Ç—ã —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏
select pg_drop_replication_slot('slot_name');

-- —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—É—é —Ç–æ—á–∫—É, –≤ —ç—Ç–æ—Ç –º–æ–º–µ–Ω—Ç –Ω–µ–Ω—É–∂–Ω—ã–µ WAL —Ñ–∞–π–ª—ã –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã
checkpoint;
```

–ï—Å–ª–∏ PostgreSQL —É–∂–µ –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∏–∑-–∑–∞ –Ω–µ—Ö–≤–∞—Ç–∫–∏ –º–µ—Å—Ç–∞ –Ω–∞ –¥–∏—Å–∫–µ:

```bash
# /usr/pgsql-12/bin/pg_controldata -D /var/lib/pgsql/12/data | grep "Latest checkpoint's REDO WAL file" | cut -d: -f2 | tr -d " "
000000020001CD9E0000006F

# /usr/pgsql-12/bin/pg_archivecleanup -n /var/lib/pgsql/12/data/pg_wal 000000020001CD9E0000006F # –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å, —á—Ç–æ –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–æ
# /usr/pgsql-12/bin/pg_archivecleanup -d /var/lib/pgsql/12/data/pg_wal 000000020001CD9E0000006F # —É–¥–∞–ª–∏—Ç—å

```

–°–º. [–ü–æ—á–µ–º—É –º–æ–π `pg_wal` –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞—Å—Ç–∏?](https://www.cybertec-postgresql.com/en/why-does-my-pg_wal-keep-growing/) (–∏ –∫–∞–∫ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ä–æ—Å—Ç?)
